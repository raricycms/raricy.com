{% extends "base.html" %}

{% block title %}Raricy.com - åšå®¢{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="blogs-hero">
    <div class="container">
        <h1>åšå®¢</h1>
        <p>åˆ†äº«æ€è€ƒä¸è§è§£</p>
        {% if current_user.is_authenticated and current_user.is_core_user %}
        <div class="mt-3">
            <a href="/blog/upload_blog" class="upload-button">
                <span class="icon icon-add"></span>
                åˆ›å»º
            </a>
        </div>
        {% endif %}
        {% if current_category or featured %}
        <div class="current-category">
            {% if featured %}
            <span class="badge">ğŸŒŸ ç²¾é€‰</span>
            {% elif current_category %}
            <span class="badge">{{ current_category.icon }} {{ current_category.get_full_path() }}</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>

<!-- ä¸»å¸ƒå±€ -->
<div class="container">
    <div class="blog-layout">
        <!-- å·¦ä¾§åˆ†ç±»å¯¼èˆª -->
        <aside class="sidebar">
            <h3 class="sidebar-title" onclick="toggleMainCategories()">
                <span>åˆ†ç±»</span>
            </h3>
            <ul class="category-list" id="mainCategoryList">
                <li class="category-item">
                    <a href="/blog/" class="category-link {{ 'active' if not current_category and not featured else '' }}">
                        <div class="category-content">
                            <span class="icon">ğŸ </span>
                            <span>å…¨éƒ¨æ–‡ç« </span>
                        </div>
                    </a>
                </li>
                <li class="category-item">
                    <a href="/blog/?featured=1" class="category-link {{ 'active' if featured else '' }}">
                        <div class="category-content">
                            <span class="icon">ğŸŒŸ</span>
                            <span>ç²¾é€‰</span>
                        </div>
                    </a>
                </li>
                {% for category in categories %}
                <li class="category-item {{ 'has-children' if category.children else '' }}">
                    {% if category.children %}
                    <div class="category-link collapsible" onclick="toggleCategory('category-{{ category.id }}')">
                        <div class="category-content">
                            <span class="icon">{{ category.icon }}</span>
                            <span>{{ category.name }}</span>
                        </div>
                    </div>
                    <ul class="sub-category-list" id="category-{{ category.id }}">
                        <li class="category-item">
                            <a href="/blog/?category={{ category.slug }}" 
                               class="sub-category-link {{ 'active' if current_category and current_category.id == category.id else '' }}">
                                <span class="icon">{{ category.icon }}</span>
                                <span>å…¨éƒ¨</span>
                            </a>
                        </li>
                        {% for child in category.children %}
                        <li class="category-item">
                            <a href="/blog/?category={{ child.slug }}" 
                               class="sub-category-link {{ 'active' if current_category and current_category.id == child.id else '' }}">
                                <span class="icon">{{ child.icon }}</span>
                                <span>{{ child.name }}</span>
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <a href="/blog/?category={{ category.slug }}" 
                       class="category-link {{ 'active' if current_category and current_category.id == category.id else '' }}">
                        <div class="category-content">
                            <span class="icon">{{ category.icon }}</span>
                            <span>{{ category.name }}</span>
                        </div>
                    </a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        </aside>

        <!-- å³ä¾§åšå®¢åˆ—è¡¨ -->
        <main class="blog-content">
        {% for blog in blogs %}
		<article class="blog-item" id="id{{ blog.id }}">
                <div class="blog-header">
                    <a href="/blog/{{ blog.id }}" class="blog-title">{{ blog.title }}</a>
                    <div class="blog-stats">
                        <span class="blog-likes" title="ç‚¹èµæ•°">
                            <span class="icon icon-heart-fill"></span>
                            <span>{{ blog.likes_count or 0 }}</span>
                        </span>
                        <span class="blog-comments" title="è¯„è®ºæ•°">
                            <span class="icon icon-chat-dots_new"></span>
                            <span>{{ blog.comments_count or 0 }}</span>
                        </span>
                    </div>
                </div>
                <p class="blog-description">{{ blog.description }}</p>
                <div class="menu-blog-meta">
                    <div class="blog-author">
                        <img src="/auth/avatar/{{ blog.author_id }}" alt="{{ blog.author }}">
                        <span>{{ blog.author }}</span>
                        {% if blog.category_path %}
                        <span class="blog-category-tag">{{ blog.category_path }}</span>
                        {% endif %}
                    </div>
                </div>
            </article>
            {% endfor %}

            {% if not blogs %}
            <div class="no-blogs">
                <i class="bi bi-journal-x"></i>
                <p>æš‚æ— åšå®¢æ–‡ç« </p>
            </div>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
	const sortSelect = document.getElementById('sortSelect');

        // é¡µé¢åŠ è½½æ—¶ï¼Œæ ¹æ®å½“å‰ URL çš„å‚æ•°è®¾ç½®ä¸‹æ‹‰æ¡†çš„é»˜è®¤é€‰ä¸­é¡¹
        (function initSelection() {
		            const urlParams = new URLSearchParams(window.location.search);
		            if (urlParams.get('update') === 'True') {
				                    sortSelect.value = 'update';
				                } else {
							                sortSelect.value = 'publish';
							            }
		        })();

        // ç›‘å¬ä¸‹æ‹‰æ¡†å˜åŒ–
        sortSelect.addEventListener('change', function () {
		            const selected = this.value;               // 'publish' æˆ– 'update'
		            const url = new URL(window.location.href); // å½“å‰å®Œæ•´URL
		            const params = url.searchParams;

		            if (selected === 'update') {
				                    // æ·»åŠ æˆ–æ›´æ–° update å‚æ•°
				                    params.set('update', 'True');
				                } else {
							                // ç§»é™¤ update å‚æ•°ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
							        params.delete('update');
							            }

		            // é‡æ–°æ„é€  URL å¹¶è·³è½¬
		            // æ³¨æ„ï¼šå¦‚æœè¿˜æœ‰å…¶å®ƒæŸ¥è¯¢å‚ä¼šè¢«ä¿ç•™
		            const newUrl = url.origin + url.pathname;
		            const queryString = params.toString();
		            window.location.href = queryString ? `${newUrl}?${queryString}` : newUrl;
		        });
    document.addEventListener('DOMContentLoaded', function () {
        // åˆå§‹åŒ–æŠ˜å çŠ¶æ€
        initializeCollapse();
	jumpToTargetBlog();
        // ç§»é™¤æ‰€æœ‰åšå®¢å¡ç‰‡åŠ¨ç”»å’Œä¾§è¾¹æ åŠ¨ç”»ï¼Œæ‰€æœ‰å†…å®¹ç›´æ¥æ˜¾ç¤º
        // åŸå®ç°å¦‚ä¸‹ï¼ˆå·²ç§»é™¤ï¼‰ï¼š
        // const blogItems = document.querySelectorAll('.blog-item');
        // blogItems.forEach((item, index) => {
        //     item.style.opacity = '0';
        //     item.style.transform = 'translateY(20px)';
        //     setTimeout(() => {
        //         item.style.transition = 'all 0.6s ease';
        //         item.style.opacity = '1';
        //         item.style.transform = 'translateY(0)';
        //     }, index * 100);
        // });

        // const sidebar = document.querySelector('.sidebar');
        // if (sidebar) {
        //     sidebar.style.opacity = '0';
        //     sidebar.style.transform = 'translateX(-20px)';
        //     setTimeout(() => {
        //         sidebar.style.transition = 'all 0.6s ease';
        //         sidebar.style.opacity = '1';
        //         sidebar.style.transform = 'translateX(0)';
        //     }, 200);
        // }
    });
    function jumpToTargetBlog() {
    	const params = new URLSearchParams(window.location.search);
    	const targetBlogId = params.get('from_id');
	    if(targetBlogId === null){
	    	return;
	    }
	    const el = document.querySelector(`#id${targetBlogId}`);
	    if(!el)return;
	    //el.scrollIntoView({ behavior: 'smooth', block:'center' });
    }
    // åˆå§‹åŒ–æŠ˜å çŠ¶æ€
    function initializeCollapse() {
        const isMobile = window.innerWidth <= 768;
        const mainCategoryList = document.getElementById('mainCategoryList');
        const sidebarTitle = document.querySelector('.sidebar-title');
        
        // æ‰‹æœºç«¯é»˜è®¤æŠ˜å ä¸»åˆ†ç±»åˆ—è¡¨
        if (isMobile && mainCategoryList) {
            mainCategoryList.classList.add('collapsed');
            if (sidebarTitle) {
                sidebarTitle.classList.add('collapsed');
            }
        }

        // æ¡Œé¢ç«¯é»˜è®¤å±•å¼€æ‰€æœ‰å­åˆ†ç±»
        if (!isMobile) {
            const subCategoryLists = document.querySelectorAll('.sub-category-list');
            subCategoryLists.forEach(list => {
                list.classList.remove('collapsed');
            });
        } else {
            // æ‰‹æœºç«¯é»˜è®¤æŠ˜å æ‰€æœ‰å­åˆ†ç±»
            const subCategoryLists = document.querySelectorAll('.sub-category-list');
            subCategoryLists.forEach(list => {
                list.classList.add('collapsed');
            });
            const collapsibleLinks = document.querySelectorAll('.category-link.collapsible');
            collapsibleLinks.forEach(link => {
                link.classList.add('collapsed');
            });
        }
    }

    // åˆ‡æ¢ä¸»åˆ†ç±»åˆ—è¡¨æ˜¾ç¤º/éšè—
    function toggleMainCategories() {
        const mainCategoryList = document.getElementById('mainCategoryList');
        const sidebarTitle = document.querySelector('.sidebar-title');
        
        if (mainCategoryList) {
            const isCollapsed = mainCategoryList.classList.contains('collapsed');
            
            if (isCollapsed) {
                mainCategoryList.classList.remove('collapsed');
                if (window.innerWidth <= 768) {
                    mainCategoryList.classList.add('expanded');
                }
                if (sidebarTitle) {
                    sidebarTitle.classList.remove('collapsed');
                }
            } else {
                mainCategoryList.classList.add('collapsed');
                mainCategoryList.classList.remove('expanded');
                if (sidebarTitle) {
                    sidebarTitle.classList.add('collapsed');
                }
            }
        }
    }

    // åˆ‡æ¢å­åˆ†ç±»æ˜¾ç¤º/éšè—
    function toggleCategory(categoryId) {
        const categoryList = document.getElementById(categoryId);
        const toggleButton = document.querySelector(`[onclick="toggleCategory('${categoryId}')"]`);
        
        if (categoryList && toggleButton) {
            const isCollapsed = categoryList.classList.contains('collapsed');
            
            if (isCollapsed) {
                categoryList.classList.remove('collapsed');
                toggleButton.classList.remove('collapsed');
            } else {
                categoryList.classList.add('collapsed');
                toggleButton.classList.add('collapsed');
            }
        }
    }

    // å“åº”çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', function() {
        // å½“ä»æ‰‹æœºç«¯åˆ‡æ¢åˆ°æ¡Œé¢ç«¯æ—¶ï¼Œé‡æ–°åˆå§‹åŒ–
        setTimeout(initializeCollapse, 100);
    });
</script>
{% endblock %}

{% block footer_text %}
{% endblock %}
