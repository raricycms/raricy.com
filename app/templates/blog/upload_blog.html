{% extends "base.html" %}
{% block title %}
Raricy.com - 文章上传
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor/dist/index.css">
<style>
    .upload-hero {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 50px 0 30px;
        text-align: center;
    }

    .blog-form-container {
        max-width: 900px;
        margin: 40px auto;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
        padding: 40px;
    }

    #message-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
    }
</style>
{% endblock %}

{% block content %}
<section class="upload-hero">
    <h1>发布新文章</h1>
</section>

<div class="blog-form-container">
    <!-- 消息容器 -->
    <div id="message-container"></div>

    <form id="blogForm">
        <div class="mb-3">
            <label for="title" class="form-label">标题</label>
            <input type="text" class="form-control" id="title" required>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">摘要</label>
            <textarea class="form-control" id="description" rows="3" required></textarea>
        </div>

        <div class="mb-3">
            <label for="category" class="form-label">栏目</label>
            <select class="form-select" id="category">
                <option value="">选择栏目（可选）</option>
                {% for category in categories %}
                <optgroup label="{{ category.icon }} {{ category.name }}">
                    <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                    {% for child in category.children %}
                    <option value="{{ child.id }}">　└ {{ child.icon }} {{ child.name }}</option>
                    {% endfor %}
                </optgroup>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">内容（Markdown格式）（注意：粘贴的内容会自动变为引用。）</label>
            <!-- Vditor 编辑器容器 -->
            <div id="editor" style="height: 60vh;"></div>
            <!-- Fallback: 当 Vditor 加载失败时显示的普通文本框 -->
            <p id="fallback-message" class="form-text text-muted" style="display: none;">Markdown编辑器加载失败，已切换到基础文本输入框。</p>
            <textarea id="fallback-editor" class="form-control" rows="20" style="display: none;"></textarea>
        </div>

        {{turnstile}}

        <button type="submit" class="btn btn-primary">提交</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/vditor"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let vditor = null;
        let isVditorLoaded = false;

        // 检查 Vditor 是否成功加载
        if (typeof Vditor !== 'undefined') {
            try {
                // 初始化Vditor编辑器
                vditor = new Vditor('editor', {
                    minHeight: 500,
                    mode: 'sv',
                    toolbar: [
                        'emoji', 'headings', 'bold', 'italic', 'strike', 'link', '|',
                        'list', 'ordered-list', 'check', 'outdent', 'indent', '|',
                        'quote', 'line', 'code', 'inline-code', 'upload', 'table', '|',
                        'undo', 'redo', 'preview', 'export'
                    ],
                    counter: { enable: true, type: 'text' },
                    cache: { enable: false },
                    value: ''
                });
                isVditorLoaded = true;
                console.log("Vditor loaded successfully.");
            } catch (e) {
                console.error("Vditor initialization failed:", e);
                showFallback();
            }
        } else {
            // Vditor 加载失败，显示备用输入框
            console.warn("Vditor script failed to load. Using fallback textarea.");
            showFallback();
        }

        // 显示备用输入框的函数
        function showFallback() {
            document.getElementById('editor').style.display = 'none';
            document.getElementById('fallback-message').style.display = 'block';
            document.getElementById('fallback-editor').style.display = 'block';
            isVditorLoaded = false;
        }

        // 表单提交处理
        document.getElementById('blogForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const showMessage = (message, type = 'danger') => {
                const alert = `<div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close"></button>
                </div>`;
                document.getElementById('message-container').innerHTML = alert;
            };

            const form = document.getElementById('blogForm');
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const category_id = document.getElementById('category').value;
            const turnstileResponse = form.querySelector('[name="cf-turnstile-response"]').value;
            
            // 根据 Vditor 是否加载成功来获取内容
            let content;
            if (isVditorLoaded) {
                content = vditor.getValue();
            } else {
                content = document.getElementById('fallback-editor').value;
            }

            // 表单验证
            if (!title || !description || !content) {
                showMessage('请填写完整信息');
                return;
            }
            if (title.length > 30) {
                showMessage('标题不能超过30个字符');
                return;
            }
            if (description.length > 100) {
                showMessage('描述不能超过100个字符');
                return;
            }
            if (content.length > 250000) {
                showMessage('内容不能超过250000个字符');
                return;
            }
            
            try {
                const response = await fetch('/blog/upload_blog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        content: content,
                        category_id: category_id,
                        'cf-turnstile-response': turnstileResponse
                    })
                });

                const result = await response.json();
                if (result.code === 200) {
                    showMessage('上传成功！即将跳转到文章页面...', 'success');
                    setTimeout(() => {
                        window.location.href = '/blog/' + result.blog_id;
                    }, 1500);
                } else {
                    showMessage('上传失败: ' + result.message);
                }
            } catch (error) {
                showMessage('出现错误，请稍后重试');
            }
        });
    });
</script>
{% endblock %}

{% block footer_text %}
{% endblock %}
