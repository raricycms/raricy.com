{% extends "base.html" %}
{% block title %}
Raricy.com - 文章上传
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vditor@3.10.7/dist/index.css" onerror="this.onerror=null; this.href='{{ url_for('static', filename='js/vditor/node_modules/vditor/dist/index.css') }}'">
{% endblock %}

{% block content %}
<section class="upload-hero">
    <h1>发布新文章</h1>
</section>

<div class="blog-form-container">
    <!-- 消息容器 -->
    <div id="message-container"></div>

    {% if ban_info %}
    <div class="alert alert-danger" role="alert">
        <h5 class="alert-heading">您已被禁言</h5>
        <p class="mb-2">您当前无法发布新文章。</p>
        <hr>
        <p class="mb-0">
            <strong>原因：</strong>{{ ban_info.reason }}<br>
            {% if ban_info.ban_until %}
            <strong>解除时间：</strong>{{ ban_info.ban_until | datetime_format }}<br>
            {% endif %}
            {% if ban_info.remaining_hours %}
                {% if ban_info.remaining_hours > 24 %}
                    <strong>剩余时间：</strong>约{{ "%.1f"|format(ban_info.remaining_hours/24) }}天
                {% else %}
                    <strong>剩余时间：</strong>约{{ "%.1f"|format(ban_info.remaining_hours) }}小时
                {% endif %}
            {% endif %}
        </p>
    </div>
    {% endif %}

    <form id="blogForm" {% if ban_info %}style="opacity: 0.5; pointer-events: none;"{% endif %}>
        <div class="mb-3">
            <label for="title" class="form-label">标题</label>
            <input type="text" class="form-control" id="title" required>
        </div>

        <div class="mb-3">
            <label for="description" class="form-label">摘要</label>
            <textarea class="form-control" id="description" rows="3" required></textarea>
        </div>

        <div class="mb-3">
            <label for="category" class="form-label">栏目</label>
            <select class="form-select" id="category">
                <option value="" class="form-option">选择栏目</option>
                {% for category in categories %}
                <optgroup label="{{ category.icon }} {{ category.name }}">
                    <option value="{{ category.id }}" class="form-option">{{ category.icon }} {{ category.name }}</option>
                    {% for child in category.children %}
                    <option value="{{ child.id }}" class="form-option">　└ {{ child.icon }} {{ child.name }}</option>
                    {% endfor %}
                </optgroup>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">内容（Markdown格式）（注意：粘贴的内容会自动变为引用。）</label>
            <!-- Vditor 编辑器容器 -->
            <div id="editor" style="height: 60vh;"></div>
            <!-- Fallback: 当 Vditor 加载失败时显示的普通文本框 -->
            <p id="fallback-message" class="form-text text-muted" style="display: none;">Markdown编辑器加载失败，已切换到基础文本输入框。</p>
            <textarea id="fallback-editor" class="form-control" rows="20" style="display: none;"></textarea>
        </div>

        <button type="submit" class="button button-primary">提交</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/vditor@3.10.7/dist/index.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let vditor = null;
        let isVditorLoaded = false;

        // 检查 Vditor 是否成功加载
        if (typeof Vditor !== 'undefined' && 0) {
            try {
                // 初始化Vditor编辑器
                vditor = new Vditor('editor', {
                    minHeight: 500,
                    mode: 'ir',
                    cdn: (window.__VDITOR_USE_LOCAL__ ? '/static/js/vditor/node_modules/vditor' : 'https://cdn.jsdelivr.net/npm/vditor@3.10.7'),
                    toolbar: [
                        'emoji', 'headings', 'bold', 'italic', 'strike', 'link', '|',
                        'list', 'ordered-list', 'check', 'outdent', 'indent', '|',
                        'quote', 'line', 'code', 'inline-code', 'upload', 'table', '|',
                        'undo', 'redo', 'preview', 'export'
                    ],
                    counter: { enable: true, type: 'text' },
                    cache: { 
                        enable: true,
                        id: 'blog-upload-editor'
                    },
                    value: ''
                });
                isVditorLoaded = true;
                console.log("Vditor loaded successfully.");
            } catch (e) {
                console.error("Vditor initialization failed:", e);
                showFallback();
            }
        } else {
            // Vditor 加载失败，显示备用输入框
            console.warn("Vditor script failed to load. Using fallback textarea.");
            showFallback();
        }

        // 显示备用输入框的函数
        function showFallback() {
            document.getElementById('editor').style.display = 'none';
            document.getElementById('fallback-message').style.display = 'block';
            document.getElementById('fallback-editor').style.display = 'block';
            isVditorLoaded = false;
        }

        // 表单提交处理
        document.getElementById('blogForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const showMessage = (message, type = 'danger') => {
                const alert = `<div class="alert alert-${type} alert-dismissible fade show">
                    ${message}
                    <button type="button" class="btn-close"></button>
                </div>`;
                document.getElementById('message-container').innerHTML = alert;
            };

            const form = document.getElementById('blogForm');
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const category_id = document.getElementById('category').value;
            
            // 根据 Vditor 是否加载成功来获取内容
            let content;
            if (isVditorLoaded) {
                content = vditor.getValue();
            } else {
                content = document.getElementById('fallback-editor').value;
            }

            // 表单验证
            if (!title || !description || !content) {
                showMessage('请填写完整信息');
                return;
            }
            if (title.length > 30) {
                showMessage('标题不能超过30个字符');
                return;
            }
            if (description.length > 100) {
                showMessage('描述不能超过100个字符');
                return;
            }
            if (content.length > 250000) {
                showMessage('内容不能超过250000个字符');
                return;
            }
            
            try {
                const response = await fetch('/blog/upload_blog', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        description: description,
                        content: content,
                        category_id: category_id
                    })
                });

                const result = await response.json();
                if (result.code === 200) {
                    showMessage('上传成功！即将跳转到文章页面...', 'success');
                    
                    // 清除vditor缓存
                    if (isVditorLoaded && vditor) {
                        vditor.clearCache();
                        console.log("Vditor cache cleared after successful upload.");
                    }
                    
                    setTimeout(() => {
                        window.location.href = '/blog/' + result.blog_id;
                    }, 1500);
                } else {
                    showMessage('上传失败: ' + result.message);
                }
            } catch (error) {
                showMessage('出现错误，请稍后重试');
            }
        });
    });
</script>
{% endblock %}

{% block footer_text %}
{% endblock %}
