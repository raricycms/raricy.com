{% extends "base.html" %}

{% block title %}{{ blog.title }} - æ–‡ç« é˜…è¯»{% endblock %}

{% block extra_css %}
<!-- CSS æ ·å¼è¡¨ -->
<link rel="stylesheet" href="{{url_for('static', filename='css/hljs/default.min.css')}}" id="hljs-light" onerror="this.onerror=null; this.href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css'">
<link rel="stylesheet" href="{{url_for('static', filename='css/hljs/monokai.min.css')}}" id="hljs-dark" disabled onerror="this.onerror=null; this.href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css'">

<!-- JavaScript åº“ï¼ˆæŒ‰ä¾èµ–é¡ºåºåŠ è½½ï¼‰ -->
<script src="{{url_for('static', filename='js/dompurify.min.js')}}"></script>
<script>
    if (typeof window.DOMPurify === 'undefined') {
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"><\\/script>');
    }
</script>
<script src="{{url_for('static', filename='js/highlight.min.js')}}"></script>
<script>
    if (typeof window.hljs === 'undefined') {
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\\/script>');
    }
</script>
<script src="{{url_for('static', filename='js/marked.min.js')}}"></script>
<script>
    if (typeof window.marked === 'undefined') {
        document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"><\\/script>');
    }
</script>
<!-- MathJax é…ç½®å’ŒåŠ è½½ -->
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true,
            processRefs: true,
            packages: {'[+]': ['ams', 'newcommand', 'configmacros', 'action', 'bbox', 'boldsymbol', 'braket', 'cancel', 'color', 'enclose', 'extpfeil', 'mhchem', 'newcommand', 'unicode', 'verb']},
            macros: {
                RR: "\\mathbb{R}",
                NN: "\\mathbb{N}",
                ZZ: "\\mathbb{Z}",
                QQ: "\\mathbb{Q}",
                CC: "\\mathbb{C}",
                PP: "\\mathbb{P}",
                EE: "\\mathbb{E}",
                FF: "\\mathbb{F}",
                bold: ["\\mathbf{" + "#1}", 1],
                bm: ["\\boldsymbol{" + "#1}", 1]
            }
        },
        options: {
            ignoreHtmlClass: 'tex2jax_ignore',
            processHtmlClass: 'tex2jax_process',
            renderActions: {
                findScript: [10, function (doc) {
                    for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                        const display = !!node.type.match(/; *mode=display/);
                        const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                        const text = document.createTextNode('');
                        node.parentNode.replaceChild(text, node);
                        math.start = {node: text, delim: '', n: 0};
                        math.end = {node: text, delim: '', n: 0};
                        doc.math.push(math);
                    }
                }, '']
            }
        },
        chtml: {
            fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
        },
        svg: {
            fontCache: 'global'
        },
        startup: {
            ready: function () {
                console.log('MathJax åŠ è½½å®Œæˆ');
                MathJax.startup.defaultReady();
            }
        }
    };
</script>
<!-- ç§»é™¤æœ‰é—®é¢˜çš„ polyfill.ioï¼Œæ”¹ç”¨æ›´ç¨³å®šçš„æ–¹æ¡ˆ -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" onerror="console.error('MathJax åŠ è½½å¤±è´¥')"></script>
<style>
    .read-hero {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 50px 0 30px;
        text-align: center;
    }

    .read-hero h1 {
        font-size: 2.2rem;
        font-weight: 400;
        color: #2c3e50;
        margin-bottom: 15px;
    }

    .blog-meta {
        color: #7f8c8d;
        font-size: 1rem;
        margin-bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .blog-author::before {
        margin-right: 5px;
    }

    .blog-date::before {
        content: 'ğŸ“…';
        margin-right: 5px;
    }

    .blog-content-container {
        max-width: 900px;
        margin: 40px auto 60px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
        padding: 40px;
        font-size: 1.15rem;
        line-height: 2;
        color: #2c3e50;
    }

    .blog-content-container-container {
        margin: 0 auto;
        padding: 0 20px;
    }

    .blog-content-container p {
        margin-bottom: 1.5em;
        text-align: justify;
    }

    /* åšå®¢å†…å®¹æ ‡é¢˜æ ·å¼ */
    .blog-content-container h1,
    .blog-content-container h2,
    .blog-content-container h3,
    .blog-content-container h4,
    .blog-content-container h5,
    .blog-content-container h6 {
        margin: 2em 0 1em;
        font-weight: 600;
        color: #2c3e50;
    }

    .blog-content-container h1 {
        font-size: 1.8rem;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }

    .blog-content-container h2 {
        font-size: 1.5rem;
    }

    .blog-content-container h3 {
        font-size: 1.3rem;
    }

    /* ä»£ç å—æ ·å¼ */
    .blog-content-container pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        overflow-x: auto;
        margin: 1.5em 0;
    }

    .blog-content-container code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }

    .blog-content-container pre code {
        background: none;
        padding: 0;
    }

    /* å¼•ç”¨æ ·å¼ */
    .blog-content-container blockquote {
        border-left: 4px solid #3498db;
        margin: 1.5em 0;
        padding: 10px 20px;
        background: #f8f9fa;
        font-style: italic;
    }

    /* åˆ—è¡¨æ ·å¼ */
    .blog-content-container ul,
    .blog-content-container ol {
        margin: 1.5em 0;
        padding-left: 2em;
    }

    .blog-content-container li {
        margin-bottom: 0.5em;
    }

    /* ä»»åŠ¡åˆ—è¡¨æ ·å¼ */
    .blog-content-container li input[type="checkbox"] {
        margin-right: 0.5em;
        cursor: default;
    }

    /* ä»»åŠ¡åˆ—è¡¨æ ·å¼ - ä½¿ç”¨æ›´å…¼å®¹çš„é€‰æ‹©å™¨ */
    .blog-content-container li.task-list-item {
        list-style: none;
        margin-left: -1.5em;
    }

    /* åå¤‡æ ·å¼ï¼šå¦‚æœ :has é€‰æ‹©å™¨ä¸è¢«æ”¯æŒï¼Œè¿™ä¸ªæ ·å¼ä¼šä½œä¸ºå¤‡é€‰ */
    @supports not (selector(:has(*))) {
        .blog-content-container li:first-child input[type="checkbox"] {
            margin-left: -1.5em;
        }
    }

    /* é“¾æ¥æ ·å¼ */
    .blog-content-container a {
        color: #3498db;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-bottom 0.2s ease;
    }

    .blog-content-container a:hover {
        color: #2980b9;
        border-bottom: 1px solid #2980b9;
        text-decoration: none;
    }

    /* å›¾ç‰‡æ ·å¼ */
    .blog-content-container img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 1.5em 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* è¡¨æ ¼æ ·å¼ */
    .blog-content-container table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5em 0;
    }

    .blog-content-container th,
    .blog-content-container td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }

    .blog-content-container th {
        background: #f8f9fa;
        font-weight: 600;
    }

    /* MathJax æ•°å­¦å…¬å¼æ ·å¼ */
    .blog-content-container .MathJax {
        font-size: 1.1em !important;
        max-width: 100%;
    }

    .blog-content-container .MathJax_Display {
        margin: 1.5em 0;
        text-align: center;
        overflow-x: auto;
        overflow-y: hidden;
    }

    /* MathJax SVG è¾“å‡ºæ ·å¼ */
    .blog-content-container mjx-container[jax="CHTML"][display="true"] {
        margin: 1.5em 0;
        text-align: center;
        overflow-x: auto;
        overflow-y: hidden;
    }

    .blog-content-container mjx-container[jax="CHTML"] {
        font-size: 1.1em;
        max-width: 100%;
    }

    /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ•°å­¦å…¬å¼ */
    body.dark-mode .MathJax,
    body.dark-mode mjx-container {
        color: var(--text) !important;
    }

    .blog-content-container .highlight {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        overflow-x: auto;
        margin: 1.5em 0;
        position: relative;
    }

    .blog-content-container .highlight pre {
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.4;
    }

    .blog-content-container .highlight code {
        background: none;
        padding: 0;
        border-radius: 0;
        font-size: inherit;
    }

    /* è¡Œå†…ä»£ç æ ·å¼ */
    .blog-content-container code:not(.highlight code) {
        background: #f1f3f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        color: #d73a49;
    }

    /* æ·±è‰²æ¨¡å¼ä¸‹çš„ä»£ç æ ·å¼ */
    body.dark-mode .blog-content-container .highlight {
        background: #2d3748;
        border-color: #4a5568;
    }

    body.dark-mode .blog-content-container code:not(.highlight code) {
        background: #4a5568;
        color: #f56565;
    }

    /* æ·±è‰²æ¨¡å¼ä¸‹çš„Markdownå¤‡ç”¨æ˜¾ç¤ºæ ·å¼ */
    body.dark-mode .markdown-fallback {
        background: #2d3748 !important;
        border-color: #4a5568 !important;
    }

    body.dark-mode .markdown-fallback h6 {
        color: #a0aec0 !important;
    }

    body.dark-mode .markdown-fallback pre {
        color: #e2e8f0 !important;
    }

    /* ä»£ç å¤åˆ¶æŒ‰é’®æ ·å¼ä¼˜åŒ– */
    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #3498db;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 0.8rem;
        cursor: pointer;
        opacity: 0.8;
        transition: all 0.2s ease;
        font-family: system-ui, -apple-system, sans-serif;
        z-index: 10;
        user-select: none;
    }

    .copy-btn:hover {
        opacity: 1;
        background: #2980b9;
        transform: translateY(-1px);
    }
    
    .copy-btn:active {
        transform: translateY(0);
    }
    
    .copy-btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* æ·±è‰²æ¨¡å¼ä¸‹çš„å¤åˆ¶æŒ‰é’® */
    body.dark-mode .copy-btn {
        background: #5dade2;
        color: #1e1e1e;
    }
    
    body.dark-mode .copy-btn:hover {
        background: #3498db;
    }

    .read-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        margin: 30px auto 40px;
        max-width: 700px;
        padding: 0 20px;
        flex-wrap: wrap;
    }

    /* ç®¡ç†å‘˜æ“ä½œåŒºåŸŸå•ç‹¬ä¸€è¡Œ */
    .admin-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin: -10px auto 30px; /* ä¸ä¸Šæ–¹æ§ä»¶é—´è·æ›´ç´§å‡‘ä¸€ç‚¹ */
        max-width: 900px;
        padding: 0 20px;
        flex-wrap: wrap;
    }

    .read-btn {
        background: #2c3e50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 500;
        text-decoration: none;
        font-size: 1rem;
        transition: all 0.3s ease;
        min-width: 120px;
        text-align: center;
    }

    .read-btn:hover {
        background: #34495e;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }

    /* ç‚¹èµæŒ‰é’®æ ·å¼ */
    .like-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #ffffff;
        color: #e74c3c;
        border: 1px solid #f2d7d5;
        padding: 10px 16px;
        border-radius: 999px;
        box-shadow: 0 2px 10px rgba(231, 76, 60, 0.08);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .like-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(231, 76, 60, 0.15);
        border-color: #f5b7b1;
    }

    .like-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .like-btn .bi {
        font-size: 1.1rem;
    }

    .like-count-badge {
        background: #fdecea;
        color: #c0392b;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.85rem;
        line-height: 1.2;
    }

    .like-btn.liked {
        background: linear-gradient(135deg, #ff7675, #e74c3c);
        color: #fff;
        border-color: #e74c3c;
        box-shadow: 0 6px 18px rgba(231, 76, 60, 0.25);
    }

    .like-btn.liked .like-count-badge {
        background: rgba(255, 255, 255, 0.25);
        color: #fff;
    }

    /* æ·±è‰²ä¸»é¢˜ä¸‹çš„æœªç‚¹èµæ ·å¼ */
    body.dark-mode .like-btn:not(.liked) {
        background: #1f242b;
        color: #ffb3ae;
        border-color: #2f3640;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
    }

    body.dark-mode .like-btn:not(.liked):hover {
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
        border-color: #3a4350;
    }

    body.dark-mode .like-btn:not(.liked) .like-count-badge {
        background: #2b323c;
        color: #ffd7d4;
    }

    /* ä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ */
    #toggle-theme {
        font-size: 0.9rem;
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.3s ease;
        margin-top: 15px;
    }

    /* é˜…è¯»è¿›åº¦æ¡ */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: #3498db;
        z-index: 1000;
        transition: width 0.1s ease;
    }

    @media (max-width: 768px) {
        .read-hero h1 {
            font-size: 1.8rem;
        }

        .blog-meta {
            flex-direction: column;
            gap: 10px;
        }

        .blog-content-container {
            padding: 25px 20px;
            margin: 20px auto 40px;
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .read-controls {
            padding: 0 15px;
            margin: 20px auto 30px;
            gap: 12px;
        }

        .read-btn {
            padding: 10px 16px;
            font-size: 0.9rem;
            min-width: 100px;
        }

        .blog-content-container-container {
            padding: 0 10px;
        }

        .blog-content-container h1 {
            font-size: 1.5rem;
        }

        .blog-content-container h2 {
            font-size: 1.3rem;
        }

        .blog-content-container h3 {
            font-size: 1.2rem;
        }

        /* ç§»åŠ¨ç«¯ï¼šè®©å¤åˆ¶æŒ‰é’®ä¸é®æŒ¡ä»£ç ï¼Œæ”¾åˆ°ä»£ç å—ä¸‹æ–¹æ˜¾ç¤º */
        .copy-btn {
            position: static;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            top: auto;
            right: auto;
            margin-top: 8px;
            padding: 6px 10px;
            font-size: 0.85rem;
            width: auto;
        }
        /* ä»£ç å—åœ¨ç§»åŠ¨ç«¯å†…è¾¹è·ç¨å¾®å¢å¤§ï¼Œé¿å…æ‹¥æŒ¤ */
        .blog-content-container .highlight {
            padding: 12px;
        }

        /* ç§»åŠ¨ç«¯æ•°å­¦å…¬å¼ä¼˜åŒ– */
        .blog-content-container .MathJax_Display,
        .blog-content-container mjx-container[jax="CHTML"][display="true"] {
            margin: 1em 0;
            font-size: 0.9em;
        }

        .blog-content-container .MathJax,
        .blog-content-container mjx-container[jax="CHTML"] {
            font-size: 0.9em !important;
        }
    }

    /* CSS å˜é‡ */
    :root {
        --bg: #f3f5f7;
        --text: #2c3e50;
        --box-bg: #ffffff;
        --hero-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --btn-bg: #2c3e50;
        --btn-hover-bg: #34495e;
        --shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
        --code-bg: #f8f9fa;
        --border-color: #e9ecef;
        --link-color: #3498db;
        --link-hover-color: #2980b9;
    }

    body.dark-mode {
        --bg: #121212;
        --text: #ecf0f1;
        --box-bg: #1e1e1e;
        --hero-bg: linear-gradient(135deg, #1c1d22 0%, #212224 100%);
        --btn-bg: #3498db;
        --btn-hover-bg: #2980b9;
        --shadow: 0 2px 16px rgba(0, 0, 0, 0.3);
        --code-bg: #2d3748;
        --border-color: #4a5568;
        --link-color: #5dade2;
        --link-hover-color: #3498db;
    }

    body {
        background-color: var(--bg);
        color: var(--text);
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .read-hero {
        background: var(--hero-bg);
    }

    .read-hero h1,
    .blog-meta {
        color: var(--text);
    }

    .blog-content-container {
        background-color: var(--box-bg);
        color: var(--text);
        box-shadow: var(--shadow);
    }

    .blog-content-container h1,
    .blog-content-container h2,
    .blog-content-container h3,
    .blog-content-container h4,
    .blog-content-container h5,
    .blog-content-container h6 {
        color: var(--text);
    }

    .blog-content-container pre,
    .blog-content-container code,
    .blog-content-container blockquote,
    .blog-content-container th {
        background: var(--code-bg);
    }

    .blog-content-container th,
    .blog-content-container td {
        border-color: var(--border-color);
    }

    .blog-content-container a {
        color: var(--link-color);
    }

    .blog-content-container a:hover {
        color: var(--link-hover-color);
        border-bottom-color: var(--link-hover-color);
    }

    .read-btn {
        background: var(--btn-bg);
    }

    .read-btn:hover {
        background: var(--btn-hover-bg);
    }
</style>
{% endblock %}

{% block content %}
<!-- é˜…è¯»è¿›åº¦æ¡ -->
<div class="reading-progress"></div>

<section class="read-hero">
    <h1>{{ blog.title }}</h1>
    <div class="blog-meta">
        <span class="blog-author">
            <img src="/auth/avatar/{{ blog.author_id }}"
                style="width:24px; height:24px; border-radius:10%; margin-right:8px;">
            {{ blog.author }}</span>
        <!-- <span class="blog-date">{{ blog.date }}</span> -->
    </div>
    <button id="toggle-theme" class="btn btn-outline-secondary">åˆ‡æ¢æ·±è‰²æ¨¡å¼</button>
</section>

<div class="blog-content-container-container">
    <div class="blog-content-container" id="userContentContainer">
        <!-- Markdown å†…å®¹å°†åœ¨å‰ç«¯æ¸²æŸ“ -->
        <div id="loading-indicator" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="mt-2">æ­£åœ¨åŠ è½½å†…å®¹...</p>
        </div>
    </div>
    <!-- åŸå§‹ Markdown æ•°æ® -->
    <script type="application/json" id="markdownContent">{{ blog.content | tojson }}</script>
</div>

<div class="read-controls">
    <button
        id="like-btn"
        class="like-btn {{ 'liked' if blog.liked else '' }}"
        data-auth="{{ 1 if current_user.is_authenticated else 0 }}"
        data-login-url="{{ url_for('auth.login') }}"
        data-like-url="{{ url_for('blog.like_toggle', blog_id=blog.id) }}"
        aria-label="ç‚¹èµ"
    >
        <i id="like-icon" class="bi {{ 'bi-heart-fill' if blog.liked else 'bi-heart' }}"></i>
        <span id="like-text">{{ 'å·²ç‚¹èµ' if blog.liked else 'ç‚¹èµ' }}</span>
        <span class="like-count-badge" id="like-count">{{ blog.likes_count or 0 }}</span>
    </button>

    <a href="{{ url_for('blog.menu') }}" class="read-btn">ğŸ“ è¿”å›åšå®¢åˆ—è¡¨</a>
</div>
{% if current_user.is_authenticated and (current_user.is_admin or current_user.id == blog.author_id) %}
<div class="admin-controls">
    {% if current_user.is_admin %}
    <button id="admin-likers-btn" class="btn btn-outline-primary" data-likers-url="{{ url_for('blog.likers', blog_id=blog.id) }}">
        ğŸ‘ æŸ¥çœ‹ç‚¹èµè€…
    </button>
    {% endif %}
    <button id="admin-delete-btn" class="btn btn-outline-danger" data-delete-url="{{ url_for('blog.delete_blog', blog_id=blog.id) }}" data-redirect-url="{{ url_for('blog.menu') }}">
        ğŸ—‘ï¸ åˆ é™¤æ–‡ç« 
    </button>
    <a href="{{ url_for('blog.edit_blog', blog_id=blog.id) }}" class="btn btn-outline-primary">âœï¸ ç¼–è¾‘æ–‡ç« </a>
    
</div>
{% endif %}
{% if current_user.is_authenticated and current_user.is_admin %}
<!-- ç‚¹èµè€…åˆ—è¡¨ Modal -->
<div class="modal fade" id="likersModal" tabindex="-1" aria-labelledby="likersModalLabel" aria-hidden="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="likersModalLabel">ç‚¹èµè€…åˆ—è¡¨</h5>
        <button type="button" class="btn-close" data-modal-close aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="likers-list" class="list-group" style="max-height: 50vh; overflow: auto;"></div>
        <div class="d-flex justify-content-between align-items-center mt-3">
            <button id="likers-prev" class="btn btn-sm btn-outline-secondary">ä¸Šä¸€é¡µ</button>
            <small id="likers-pageinfo" class="text-muted"></small>
            <button id="likers-next" class="btn btn-sm btn-outline-secondary">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>å…³é—­</button>
      </div>
    </div>
  </div>
</div>

<!-- åˆ é™¤ç¡®è®¤ Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true" role="dialog">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmLabel">ç¡®è®¤åˆ é™¤</h5>
        <button type="button" class="btn-close" data-modal-close aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ–‡ç« ã€Š{{ blog.title }}ã€‹å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-modal-close>å–æ¶ˆ</button>
        <button type="button" id="confirm-delete-btn" class="btn btn-danger">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
    
<!-- è¯„è®ºåŒº -->
<div class="blog-detail">
    <section class="comment-section" id="comment-section"
             data-blog-id="{{ blog.id }}"
             data-list-url="{{ url_for('blog.list_comments', blog_id=blog.id) }}"
             data-create-url="{{ url_for('blog.create_comment', blog_id=blog.id) }}"
             data-delete-url-template="{{ url_for('blog.delete_comment', comment_id='__CID__') }}"
             data-can-comment="{{ 1 if current_user.is_authenticated and (current_user.authenticated or current_user.is_admin) else 0 }}"
             data-current-user-id="{{ current_user.id if current_user.is_authenticated else '' }}"
             data-is-admin="{{ 1 if current_user.is_authenticated and current_user.is_admin else 0 }}">

        {% if current_user.is_authenticated and (current_user.authenticated or current_user.is_admin) %}
        <form class="comment-form" id="comment-form">
            <textarea name="content" id="comment-content" maxlength="2000" placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦ï¼ˆæœ€å¤š2000å­—ï¼‰"></textarea>
            <div class="mt-2">
                <button type="submit" class="btn btn-primary btn-sm">å‘è¡¨è¯„è®º</button>
            </div>
            <input type="hidden" name="parent_id" id="comment-parent-id" value="">
        </form>
        {% else %}
        <div class="alert alert-info">åªæœ‰"æ ¸å¿ƒç”¨æˆ·"å¯ä»¥å‘è¡¨è¯„è®ºã€‚</div>
        {% endif %}

        <ul class="comment-list" id="comment-list"></ul>
    </section>
</div>
{% endblock %}

{% block copyright %}
ä½œè€…ï¼š{{ blog.author }} | ç‰ˆæƒå½’åŸä½œè€…æ‰€æœ‰  

{% endblock %}

{% block extra_js %}
<script>
    // å‰ç«¯ Markdown æ¸²æŸ“åŠŸèƒ½
    function initMarkdownRenderer() {
        // æ£€æŸ¥ä¾èµ–æ˜¯å¦åŠ è½½å®Œæˆ
        if (typeof marked === 'undefined') {
            console.error('marked.js æœªåŠ è½½');
            return false;
        }
        if (typeof hljs === 'undefined') {
            console.error('highlight.js æœªåŠ è½½');
            return false;
        }
        if (typeof DOMPurify === 'undefined') {
            console.error('DOMPurify æœªåŠ è½½');
            return false;
        }
        if (typeof MathJax === 'undefined') {
            console.error('MathJax æœªåŠ è½½');
            return false;
        }

        // é…ç½® marked
        marked.setOptions({
            highlight: function(code, lang) {
                try {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                } catch (err) {
                    console.warn('ä»£ç é«˜äº®å¤±è´¥:', err);
                    return code; // è¿”å›åŸå§‹ä»£ç 
                }
            },
            breaks: true,
            gfm: true,
            tables: true,
            xhtml: false
        });

        // é…ç½®è‡ªå®šä¹‰æ¸²æŸ“å™¨
        const renderer = new marked.Renderer();
        
        // è‡ªå®šä¹‰é“¾æ¥æ¸²æŸ“
        renderer.link = function(href, title, text) {
            const link = marked.Renderer.prototype.link.call(this, href, title, text);
            return link.replace('<a', '<a rel="noopener noreferrer nofollow" target="_blank"');
        };

        // è‡ªå®šä¹‰ä»£ç å—æ¸²æŸ“
        renderer.code = function(code, lang) {
            try {
                const highlighted = lang && hljs.getLanguage(lang) 
                    ? hljs.highlight(code, { language: lang }).value 
                    : hljs.highlightAuto(code).value;
                
                return `<div class="highlight">
                    <pre><code class="hljs">${highlighted}</code></pre>
                    <button class="copy-btn" data-code="${encodeURIComponent(code)}">ğŸ“‹ å¤åˆ¶</button>
                </div>`;
            } catch (err) {
                console.warn('ä»£ç é«˜äº®å¤±è´¥:', err);
                return `<div class="highlight">
                    <pre><code>${code}</code></pre>
                    <button class="copy-btn" data-code="${encodeURIComponent(code)}">ğŸ“‹ å¤åˆ¶</button>
                </div>`;
            }
        };

        // è‡ªå®šä¹‰åˆ—è¡¨é¡¹æ¸²æŸ“ï¼ˆæ”¯æŒä»»åŠ¡åˆ—è¡¨ï¼‰
        renderer.listitem = function(text) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯ä»»åŠ¡åˆ—è¡¨é¡¹
            if (/^\s*\[[ x]\]\s/.test(text)) {
                const checked = /^\s*\[x\]\s/.test(text);
                const cleanText = text.replace(/^\s*\[[ x]\]\s/, '');
                return `<li class="task-list-item"><input type="checkbox" ${checked ? 'checked' : ''} disabled> ${cleanText}</li>`;
            }
            return `<li>${text}</li>`;
        };

        marked.use({ renderer });
        
        return true;
    }

    // å®‰å…¨æ¸²æŸ“ Markdown å†…å®¹
    function renderUserContent() {
        const container = document.getElementById('userContentContainer');
        const markdownScript = document.getElementById('markdownContent');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        if (!markdownScript) {
            console.error('æœªæ‰¾åˆ° Markdown å†…å®¹');
            if (loadingIndicator) {
                loadingIndicator.innerHTML = '<div class="alert alert-danger">å†…å®¹æ•°æ®ç¼ºå¤±</div>';
            }
            return;
        }

        try {
            let markdownText = JSON.parse(markdownScript.textContent);
            
            // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
            
            // æ£€æŸ¥å¿…è¦çš„åº“æ˜¯å¦å¯ç”¨
            if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ˜¾ç¤ºåŸå§‹ Markdown
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>âš ï¸ Markdown æ¸²æŸ“åº“æœªåŠ è½½</h5>
                        <p>æ­£åœ¨æ˜¾ç¤ºåŸå§‹ Markdown å†…å®¹ã€‚è¿™å¯èƒ½æ˜¯ç”±äºç½‘ç»œé—®é¢˜å¯¼è‡´çš„ã€‚</p>
                        <button class="btn btn-primary btn-sm mt-2" onclick="location.reload()">åˆ·æ–°é¡µé¢é‡è¯•</button>
                    </div>
                    <div class="markdown-fallback" style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 15px; border: 1px solid #e9ecef;">
                        <h6 style="color: #6c757d; margin-bottom: 15px; font-weight: 600;">ğŸ“ åŸå§‹ Markdown å†…å®¹ï¼š</h6>
                        <pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; margin: 0; color: #2c3e50; background: transparent; border: none; padding: 0;">${markdownText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                    </div>
                `;
                console.warn('Markdown åº“æœªåŠ è½½ï¼Œæ˜¾ç¤ºåŸå§‹å†…å®¹');
                return;
            }
            
            // ä¿æŠ¤æ•°å­¦å…¬å¼ä¸è¢« Markdown ç ´å
            const mathPlaceholders = {};
            let placeholderCounter = 0;
            
            // ä¿æŠ¤å—çº§æ•°å­¦å…¬å¼ $$...$$
            markdownText = markdownText.replace(/\$\$([\s\S]*?)\$\$/g, (match) => {
                const placeholder = `MATHBLOCK${placeholderCounter++}PLACEHOLDER`;
                mathPlaceholders[placeholder] = match;
                return placeholder;
            });
            
            // ä¿æŠ¤è¡Œå†…æ•°å­¦å…¬å¼ $...$
            markdownText = markdownText.replace(/\$([^$\n]+?)\$/g, (match) => {
                const placeholder = `MATHINLINE${placeholderCounter++}PLACEHOLDER`;
                mathPlaceholders[placeholder] = match;
                return placeholder;
            });
            
            // ä¿æŠ¤ LaTeX é£æ ¼å…¬å¼ \[...\] å’Œ \(...\)
            markdownText = markdownText.replace(/\\\[([\s\S]*?)\\\]/g, (match) => {
                const placeholder = `MATHLATEX${placeholderCounter++}PLACEHOLDER`;
                mathPlaceholders[placeholder] = match;
                return placeholder;
            });
            
            markdownText = markdownText.replace(/\\\(([\s\S]*?)\\\)/g, (match) => {
                const placeholder = `MATHLATEX${placeholderCounter++}PLACEHOLDER`;
                mathPlaceholders[placeholder] = match;
                return placeholder;
            });
            
            // æ¸²æŸ“ Markdown ä¸º HTML
            let html = marked.parse(markdownText);
            
            // æ¢å¤æ•°å­¦å…¬å¼
            Object.keys(mathPlaceholders).forEach(placeholder => {
                html = html.replace(new RegExp(placeholder, 'g'), mathPlaceholders[placeholder]);
            });
            
            // ä½¿ç”¨ DOMPurify æ¸…ç† HTMLï¼Œé˜²æ­¢ XSS - ä¿ç•™æ•°å­¦å…¬å¼æ ‡è®°
            html = DOMPurify.sanitize(html, {
                ALLOWED_TAGS: [
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    'p', 'br', 'hr', 'div', 'span',
                    'strong', 'b', 'em', 'i', 'u', 's', 'del',
                    'code', 'pre', 'blockquote',
                    'ul', 'ol', 'li',
                    'a', 'img',
                    'table', 'thead', 'tbody', 'tr', 'th', 'td',
                    'details', 'summary',
                    'sub', 'sup', 'mark',
                    'input', 'button'  // å…è®¸ input æ ‡ç­¾ç”¨äºä»»åŠ¡åˆ—è¡¨å’Œbuttonç”¨äºå¤åˆ¶åŠŸèƒ½
                ],
                ALLOWED_ATTR: [
                    'href', 'title', 'alt', 'src', 'class', 'rel', 'target',
                    'width', 'height', 'align', 'colspan', 'rowspan',
                    'type', 'checked', 'disabled', 'data-code'  // å…è®¸ä»»åŠ¡åˆ—è¡¨çš„å±æ€§å’Œå¤åˆ¶æŒ‰é’®å±æ€§
                ],
                ALLOW_DATA_ATTR: false
            });
            
            container.innerHTML = html;
            
            // å®‰å…¨å¤„ç†é“¾æ¥
            hardenLinks();
            
            // æ·»åŠ ä»£ç å¤åˆ¶åŠŸèƒ½
            addCopyButtons();
            
            // æ·»åŠ å›¾ç‰‡ç‚¹å‡»æ”¾å¤§åŠŸèƒ½
            addImageZoom();
            
            // å»¶è¿Ÿæ¸²æŸ“æ•°å­¦å…¬å¼ï¼Œç¡®ä¿ DOM å®Œå…¨å‡†å¤‡å¥½
            if (typeof MathJax !== 'undefined') {
                setTimeout(() => {
                    // ç›´æ¥æ£€æŸ¥ DOM ä¸­æ˜¯å¦æœ‰æ•°å­¦å…¬å¼
                    const hasBlockMath = container.innerHTML.includes('$$') || container.innerHTML.includes('\\[') || container.innerHTML.includes('\\]');
                    const hasInlineMath = /\$[^$\n]+\$/.test(container.innerHTML) || container.innerHTML.includes('\\(') || container.innerHTML.includes('\\)');
                    
                    console.log('æ•°å­¦å…¬å¼æ£€æµ‹:', {
                        hasBlockMath,
                        hasInlineMath,
                        htmlSample: container.innerHTML.substring(0, 200) + '...'
                    });
                    
                    if (hasBlockMath || hasInlineMath) {
                        console.log('æ£€æµ‹åˆ°æ•°å­¦å…¬å¼ï¼Œå¼€å§‹æ¸²æŸ“...');
                        renderMath();
                    } else {
                        console.log('æœªæ£€æµ‹åˆ°æ•°å­¦å…¬å¼');
                    }
                }, 300);
            } else {
                console.warn('MathJax æœªåŠ è½½ï¼Œè·³è¿‡æ•°å­¦å…¬å¼æ¸²æŸ“');
            }
            
        } catch (error) {
            console.error('Markdown æ¸²æŸ“å¤±è´¥:', error);
            // å°è¯•æ˜¾ç¤ºåŸå§‹å†…å®¹ä½œä¸ºå¤‡ç”¨
            try {
                const markdownText = JSON.parse(markdownScript.textContent);
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>âš ï¸ å†…å®¹æ¸²æŸ“å¤±è´¥</h5>
                        <p>æ­£åœ¨æ˜¾ç¤ºåŸå§‹ Markdown å†…å®¹ã€‚è¿™å¯èƒ½æ˜¯ç”±äºå†…å®¹æ ¼å¼é—®é¢˜å¯¼è‡´çš„ã€‚</p>
                        <button class="btn btn-primary btn-sm mt-2" onclick="location.reload()">åˆ·æ–°é¡µé¢é‡è¯•</button>
                    </div>
                    <div class="markdown-fallback" style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 15px; border: 1px solid #e9ecef;">
                        <h6 style="color: #6c757d; margin-bottom: 15px; font-weight: 600;">ğŸ“ åŸå§‹ Markdown å†…å®¹ï¼š</h6>
                        <pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; margin: 0; color: #2c3e50; background: transparent; border: none; padding: 0;">${markdownText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = '<div class="alert alert-danger">å†…å®¹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</div>';
            }
        }
    }

    // æ¸²æŸ“æ•°å­¦å…¬å¼
    function renderMath() {
        try {
            console.log('å¼€å§‹æ¸²æŸ“æ•°å­¦å…¬å¼...');
            const container = document.getElementById('userContentContainer');
            if (!container) {
                console.warn('æœªæ‰¾åˆ°å†…å®¹å®¹å™¨');
                return;
            }
            
            // ä½¿ç”¨ MathJax é‡æ–°æ¸²æŸ“æ•°å­¦å…¬å¼
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([container]).then(() => {
                    console.log('æ•°å­¦å…¬å¼æ¸²æŸ“å®Œæˆ');
                }).catch((error) => {
                    console.error('MathJax æ¸²æŸ“å¤±è´¥:', error);
                });
            } else if (window.MathJax && window.MathJax.Hub) {
                // é’ˆå¯¹ MathJax v2 çš„é™çº§æ”¯æŒ
                window.MathJax.Hub.Queue(["Typeset", window.MathJax.Hub, container]);
                console.log('æ•°å­¦å…¬å¼æ¸²æŸ“å®Œæˆ (MathJax v2)');
            } else {
                console.warn('MathJax æœªæ­£ç¡®åŠ è½½æˆ–é…ç½®');
            }
        } catch (error) {
            console.error('æ•°å­¦å…¬å¼æ¸²æŸ“å¤±è´¥:', error);
        }
    }

    // æ·»åŠ ä»£ç å¤åˆ¶åŠŸèƒ½
    function addCopyButtons() {
        const copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(button => {
            button.addEventListener('click', function() {
                copyCode(this);
            });
        });
    }
    
    // å¤åˆ¶ä»£ç åŠŸèƒ½
    function copyCode(button) {
        console.log('å¤åˆ¶ä»£ç æŒ‰é’®è¢«ç‚¹å‡»');
        try {
            let codeText = '';
            
            // å°è¯•ä» data-code å±æ€§è·å–ä»£ç 
            const encodedCode = button.getAttribute('data-code');
            if (encodedCode) {
                codeText = decodeURIComponent(encodedCode);
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä»ç›¸é‚»çš„ code å…ƒç´ è·å–
                const codeBlock = button.parentElement.querySelector('code');
                if (!codeBlock) {
                    console.error('æœªæ‰¾åˆ°ä»£ç å—');
                    return;
                }
                codeText = codeBlock.textContent || codeBlock.innerText;
            }
            
            console.log('å‡†å¤‡å¤åˆ¶çš„ä»£ç é•¿åº¦:', codeText.length);
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                // ç°ä»£æµè§ˆå™¨
                navigator.clipboard.writeText(codeText).then(() => {
                    console.log('ä»£ç å¤åˆ¶æˆåŠŸ');
                    showCopySuccess(button);
                }).catch((err) => {
                    console.warn('Clipboard API å¤±è´¥ï¼Œä½¿ç”¨é™çº§æ–¹æ¡ˆ:', err);
                    fallbackCopy(codeText, button);
                });
            } else {
                // é™çº§æ–¹æ¡ˆ
                console.log('ä½¿ç”¨é™çº§å¤åˆ¶æ–¹æ¡ˆ');
                fallbackCopy(codeText, button);
            }
        } catch (error) {
            console.error('å¤åˆ¶ä»£ç æ—¶å‡ºé”™:', error);
        }
    }
    
    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
    function showCopySuccess(button) {
        const originalText = button.innerHTML;
        const originalBg = button.style.background;
        
        button.innerHTML = 'âœ… å·²å¤åˆ¶';
        button.style.background = '#27ae60';
        button.disabled = true;
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = originalBg || '#3498db';
            button.disabled = false;
        }, 2000);
    }
    
    // é™çº§å¤åˆ¶æ–¹æ¡ˆ
    function fallbackCopy(text, button) {
        try {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (successful) {
                console.log('é™çº§å¤åˆ¶æˆåŠŸ');
                showCopySuccess(button);
            } else {
                console.error('é™çº§å¤åˆ¶å¤±è´¥');
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ä»£ç ');
            }
        } catch (err) {
            console.error('é™çº§å¤åˆ¶å‡ºé”™:', err);
            alert('å¤åˆ¶åŠŸèƒ½ä¸å¯ç”¨ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©ä»£ç ');
        }
    }

    // å¯¹å†…å®¹åŒºåŸŸä¸­çš„é“¾æ¥è¿›è¡Œå®‰å…¨åŠ å›º
    function hardenLinks() {
        const anchors = document.querySelectorAll('.blog-content-container a[href]');
        anchors.forEach(a => {
            const href = a.getAttribute('href') || '';
            try {
                const url = new URL(href, window.location.origin);
                const protocol = url.protocol.toLowerCase();
                const isHttp = protocol === 'http:' || protocol === 'https:';
                const isAllowed = isHttp || protocol === 'mailto:' || protocol === 'tel:';
                
                if (!isAllowed) {
                    a.removeAttribute('href');
                    return;
                }
                
                if (isHttp && url.origin !== window.location.origin) {
                    a.setAttribute('rel', 'noopener noreferrer nofollow');
                    a.setAttribute('target', '_blank');
                }
            } catch (e) {
                // éæ³•URLï¼Œç§»é™¤href
                a.removeAttribute('href');
            }
        });
    }
    // ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½
    const toggleBtn = document.getElementById('toggle-theme');
    const isDark = localStorage.getItem('theme') === 'dark';

    if (isDark) {
        document.body.classList.add('dark-mode');
        toggleBtn.innerText = 'åˆ‡æ¢äº®è‰²æ¨¡å¼';
    }
    updateHighlightTheme(isDark);

    toggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const nowDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', nowDark ? 'dark' : 'light');
        toggleBtn.innerText = nowDark ? 'åˆ‡æ¢äº®è‰²æ¨¡å¼' : 'åˆ‡æ¢æ·±è‰²æ¨¡å¼';
        updateHighlightTheme(nowDark);
    });

    // é˜…è¯»è¿›åº¦æ¡
    function updateReadingProgress() {
        const article = document.querySelector('.blog-content-container');
        const scrollTop = window.pageYOffset;
        const docHeight = document.body.scrollHeight - window.innerHeight;
        const scrollPercent = Math.min((scrollTop / docHeight) * 100, 100);

        let progressBar = document.querySelector('.reading-progress');
        if (!progressBar) {
            progressBar = document.createElement('div');
            progressBar.className = 'reading-progress';
            document.body.appendChild(progressBar);
        }

        progressBar.style.width = scrollPercent + '%';
    }



    // å›¾ç‰‡ç‚¹å‡»æ”¾å¤§åŠŸèƒ½
    function addImageZoom() {
        const images = document.querySelectorAll('.blog-content-container img');
        images.forEach(img => {
            img.style.cursor = 'pointer';
            img.addEventListener('click', () => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    cursor: pointer;
                `;

                const zoomedImg = img.cloneNode();
                zoomedImg.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                `;

                overlay.appendChild(zoomedImg);
                document.body.appendChild(overlay);

                overlay.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });
            });
        });
    }



    // æ»šåŠ¨äº‹ä»¶ç›‘å¬
    window.addEventListener('scroll', updateReadingProgress);



    // ç­‰å¾…æ‰€æœ‰ä¾èµ–åŠ è½½å®Œæˆ
    function waitForDependencies(callback, maxAttempts = 15) { // å‡å°‘åˆ°15æ¬¡å°è¯•ï¼Œæ€»å…±3ç§’
        let attempts = 0;
        
        function check() {
            attempts++;
            
            // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªä¾èµ–
            const dependencies = {
                'marked': typeof marked !== 'undefined',
                'hljs': typeof hljs !== 'undefined', 
                'DOMPurify': typeof DOMPurify !== 'undefined',
                'MathJax': typeof MathJax !== 'undefined'
            };
            
            console.log(`ä¾èµ–æ£€æŸ¥ (${attempts}/${maxAttempts}):`, dependencies);
            
            if (dependencies.marked && dependencies.hljs && dependencies.DOMPurify && dependencies.MathJax) {
                console.log('âœ… æ‰€æœ‰ä¾èµ–å·²åŠ è½½å®Œæˆ');
                callback();
                return;
            }
            
            if (attempts >= maxAttempts) {
                console.error('âŒ ä¾èµ–åŠ è½½è¶…æ—¶ï¼Œç¼ºå¤±çš„ä¾èµ–:', 
                    Object.keys(dependencies).filter(key => !dependencies[key]));
                // å¦‚æœå…³é”®ä¾èµ–ç¼ºå¤±ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹å†…å®¹
                if (!dependencies.marked || !dependencies.DOMPurify) {
                    console.log('å…³é”®ä¾èµ–ç¼ºå¤±ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹Markdownå†…å®¹');
                    const container = document.getElementById('userContentContainer');
                    const markdownScript = document.getElementById('markdownContent');
                    const loadingIndicator = document.getElementById('loading-indicator');
                    
                    if (markdownScript && container) {
                        try {
                            const markdownText = JSON.parse(markdownScript.textContent);
                            if (loadingIndicator) {
                                loadingIndicator.remove();
                            }
                            container.innerHTML = `
                                <div class="alert alert-warning">
                                    <h5>âš ï¸ CDN èµ„æºåŠ è½½å¤±è´¥</h5>
                                    <p>ç”±äºç½‘ç»œé—®é¢˜ï¼ŒMarkdown æ¸²æŸ“åº“æœªèƒ½åŠ è½½ã€‚æ­£åœ¨æ˜¾ç¤ºåŸå§‹å†…å®¹ã€‚</p>
                                    <button class="btn btn-primary btn-sm mt-2" onclick="location.reload()">åˆ·æ–°é¡µé¢é‡è¯•</button>
                                </div>
                                <div class="markdown-fallback" style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 15px; border: 1px solid #e9ecef;">
                                    <h6 style="color: #6c757d; margin-bottom: 15px; font-weight: 600;">ğŸ“ åŸå§‹ Markdown å†…å®¹ï¼š</h6>
                                    <pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; margin: 0; color: #2c3e50; background: transparent; border: none; padding: 0;">${markdownText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                                </div>
                            `;
                            return;
                        } catch (e) {
                            console.error('è§£æMarkdownå†…å®¹å¤±è´¥:', e);
                        }
                    }
                }
                callback(); // ä»ç„¶å°è¯•åˆå§‹åŒ–
                return;
            }
            
            setTimeout(check, 200); // 200ms åé‡è¯•
        }
        
        check();
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨é€‚é…ç³»ç»Ÿä¸»é¢˜å’Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        // å¢åŠ ä¸€ä¸ªå¿«é€Ÿå¤±è´¥æ£€æµ‹ï¼Œ2ç§’åå¦‚æœä¾èµ–è¿˜æœªåŠ è½½å°±ç›´æ¥æ˜¾ç¤ºåŸæ–‡
        const quickFailTimeout = setTimeout(() => {
            console.log('ğŸš€ å¿«é€Ÿå¤±è´¥æ£€æµ‹ï¼š2ç§’åå¼ºåˆ¶æ˜¾ç¤ºåŸæ–‡');
            const container = document.getElementById('userContentContainer');
            const markdownScript = document.getElementById('markdownContent');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            if (markdownScript && container && loadingIndicator) {
                try {
                    const markdownText = JSON.parse(markdownScript.textContent);
                    loadingIndicator.remove();
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <h5>âš¡ ç½‘ç»œè¾ƒæ…¢ï¼Œå·²åˆ‡æ¢åˆ°åŸæ–‡æ˜¾ç¤º</h5>
                            <p>Markdown æ¸²æŸ“åº“æ­£åœ¨åŠ è½½ä¸­ã€‚å¦‚éœ€å®Œæ•´æ¸²æŸ“æ•ˆæœï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢ã€‚</p>
                            <button class="btn btn-primary btn-sm mt-2" onclick="location.reload()">åˆ·æ–°é¡µé¢</button>
                        </div>
                        <div class="markdown-fallback" style="background: #f8f9fa; padding: 20px; border-radius: 6px; margin-top: 15px; border: 1px solid #e9ecef;">
                            <h6 style="color: #6c757d; margin-bottom: 15px; font-weight: 600;">ğŸ“ åŸå§‹ Markdown å†…å®¹ï¼š</h6>
                            <pre style="white-space: pre-wrap; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; font-size: 0.9rem; line-height: 1.6; margin: 0; color: #2c3e50; background: transparent; border: none; padding: 0;">${markdownText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                        </div>
                    `;
                } catch (e) {
                    console.error('è§£æMarkdownå†…å®¹å¤±è´¥:', e);
                }
            }
        }, 2000); // 2ç§’å¿«é€Ÿå¤±è´¥

        waitForDependencies(() => {
            // å¦‚æœä¾èµ–åŠ è½½æˆåŠŸï¼Œæ¸…é™¤å¿«é€Ÿå¤±è´¥å®šæ—¶å™¨
            clearTimeout(quickFailTimeout);
            
            // åˆå§‹åŒ– Markdown æ¸²æŸ“å™¨
            if (initMarkdownRenderer()) {
                // æ¸²æŸ“å†…å®¹
                renderUserContent();
            } else {
                console.error('Markdown æ¸²æŸ“å™¨åˆå§‹åŒ–å¤±è´¥');
                document.getElementById('userContentContainer').innerHTML = 
                    '<p class="text-danger">å†…å®¹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚</p>';
            }
        });
        
        // ä¸»é¢˜è®¾ç½®
        let isDark = localStorage.getItem('theme') === 'dark';
        if (!localStorage.getItem('theme')) {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
                document.getElementById('toggle-theme').innerText = 'åˆ‡æ¢äº®è‰²æ¨¡å¼';
                isDark = true;
            }
        }
        updateHighlightTheme(document.body.classList.contains('dark-mode'));
        updateReadingProgress();
        addImageZoom();

        // å¹³æ»‘æ»šåŠ¨åˆ°å†…å®¹åŒºåŸŸï¼ˆå¦‚æœæœ‰é”šç‚¹ï¼‰
        if (window.location.hash) {
            const target = document.querySelector(window.location.hash);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        }
    });

    function updateHighlightTheme(isDark) {
        document.getElementById('hljs-light').disabled = isDark;
        document.getElementById('hljs-dark').disabled = !isDark;
    }

    // Lightweight modal helpers (no Bootstrap), with a11y handling
    function setBackgroundInert(enable, excludeEl) {
        const children = Array.from(document.body.children);
        children.forEach(node => {
            if (excludeEl && (node === excludeEl || node.contains(excludeEl))) return;
            if (enable) node.setAttribute('inert', ''); else node.removeAttribute('inert');
        });
    }
    function trapFocus(modalEl, e) {
        if (e.key !== 'Tab') return;
        const focusable = modalEl.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
        if (focusable.length === 0) return;
        const first = focusable[0];
        const last = focusable[focusable.length - 1];
        if (e.shiftKey) {
            if (document.activeElement === first) { last.focus(); e.preventDefault(); }
        } else {
            if (document.activeElement === last) { first.focus(); e.preventDefault(); }
        }
    }
    function openModal(modalEl) {
        if (!modalEl) return;
        modalEl._prevActiveEl = document.activeElement;
        modalEl.classList.add('is-open');
        modalEl.classList.add('show');
        modalEl.setAttribute('aria-hidden', 'false');
        modalEl.setAttribute('aria-modal', 'true');
        document.body.style.overflow = 'hidden';
        setBackgroundInert(true, modalEl);
        const focusable = modalEl.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
        if (focusable.length > 0) {
            focusable[0].focus();
        } else {
            modalEl.focus();
        }
        modalEl._onKeydown = (e) => {
            if (e.key === 'Escape') { closeModal(modalEl); }
            trapFocus(modalEl, e);
        };
        document.addEventListener('keydown', modalEl._onKeydown);
    }
    function closeModal(modalEl) {
        if (!modalEl) return;
        modalEl.classList.remove('is-open');
        modalEl.classList.remove('show');
        modalEl.setAttribute('aria-hidden', 'true');
        modalEl.removeAttribute('aria-modal');
        document.body.style.overflow = '';
        setBackgroundInert(false, modalEl);
        if (modalEl._onKeydown) {
            document.removeEventListener('keydown', modalEl._onKeydown);
            modalEl._onKeydown = null;
        }
        if (modalEl._prevActiveEl && typeof modalEl._prevActiveEl.focus === 'function') {
            modalEl._prevActiveEl.focus();
        }
        modalEl._prevActiveEl = null;
    }
    function setupModal(modalEl) {
        if (!modalEl) return;
        // Close on backdrop click
        modalEl.addEventListener('click', (e) => {
            if (e.target === modalEl) closeModal(modalEl);
        });
        // Close on any element marked with data-modal-close
        modalEl.querySelectorAll('[data-modal-close]').forEach((el) => {
            el.addEventListener('click', () => closeModal(modalEl));
        });
    }

    // ç‚¹èµåŠŸèƒ½
    (function () {
        const likeBtn = document.getElementById('like-btn');
        if (!likeBtn) return;
        const IS_AUTHENTICATED = likeBtn.dataset.auth === '1';
        const LOGIN_URL = likeBtn.dataset.loginUrl;
        const LIKE_URL = likeBtn.dataset.likeUrl;
        const likeIcon = document.getElementById('like-icon');
        const likeText = document.getElementById('like-text');
        const likeCount = document.getElementById('like-count');

        likeBtn.addEventListener('click', async () => {
            if (!IS_AUTHENTICATED) {
                if (typeof showToast === 'function') {
                    showToast('è¯·å…ˆç™»å½•åå†ç‚¹èµ', 'info');
                }
                window.location.href = LOGIN_URL;
                return;
            }
            likeBtn.disabled = true;
            try {
                const res = await fetch(LIKE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                const data = await res.json();
                if (data.code === 200) {
                    const liked = !!data.liked;
                    likeCount.textContent = data.likes_count;
                    likeIcon.className = 'bi ' + (liked ? 'bi-heart-fill' : 'bi-heart');
                    likeText.textContent = liked ? 'å·²ç‚¹èµ' : 'ç‚¹èµ';
                    likeBtn.classList.toggle('liked', liked);
                    if (typeof showToast === 'function') {
                        showToast(liked ? 'å·²ç‚¹èµ' : 'å·²å–æ¶ˆç‚¹èµ', liked ? 'success' : 'info');
                    }
                } else {
                    if (typeof showToast === 'function') showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
                }
            } catch (e) {
                if (typeof showToast === 'function') showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            } finally {
                likeBtn.disabled = false;
            }
        });
    })();

    // ===== è¯„è®ºåŠŸèƒ½ =====
    (function () {
        const section = document.getElementById('comment-section');
        if (!section) return;

        const LIST_URL = section.dataset.listUrl;
        const CREATE_URL = section.dataset.createUrl;
        const DELETE_URL_TPL = section.dataset.deleteUrlTemplate; // åŒ…å« __CID__ å ä½ç¬¦
        const CAN_COMMENT = section.dataset.canComment === '1';
        const CURRENT_USER_ID = section.dataset.currentUserId || '';
        const IS_ADMIN = section.dataset.isAdmin === '1';

        const listEl = document.getElementById('comment-list');
        const formEl = document.getElementById('comment-form');
        const contentEl = document.getElementById('comment-content');
        const parentIdEl = document.getElementById('comment-parent-id');

        async function loadComments() {
            listEl.innerHTML = '<li class="text-muted">åŠ è½½è¯„è®ºä¸­â€¦</li>';
            try {
                const res = await fetch(LIST_URL, { credentials: 'same-origin' });
                const data = await res.json();
                if (data.code !== 200) throw new Error(data.message || 'åŠ è½½å¤±è´¥');
                renderComments(data.comments || []);
            } catch (e) {
                listEl.innerHTML = '<li class="text-danger">è¯„è®ºåŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</li>';
            }
        }

        function renderComments(comments) {
            listEl.innerHTML = '';
            const frag = document.createDocumentFragment();
            comments.forEach(c => frag.appendChild(renderItem(c)));
            listEl.appendChild(frag);
        }

        function renderItem(cmt) {
            const li = document.createElement('li');
            li.className = 'comment-item';

            const meta = document.createElement('div');
            meta.className = 'meta';
            const authorName = (cmt.author && cmt.author.username) ? cmt.author.username : 'åŒ¿åç”¨æˆ·';
            meta.textContent = `${authorName}`;

            const content = document.createElement('div');
            content.className = 'content';
            // æœåŠ¡ç«¯å·²åšè½¬ä¹‰ï¼Œè¿™é‡Œå®‰å…¨æ’å…¥
            content.innerHTML = cmt.content_html || '';

            const actions = document.createElement('div');
            actions.className = 'actions';

            if (CAN_COMMENT) {
                const replyBtn = document.createElement('button');
                replyBtn.type = 'button';
                replyBtn.className = 'btn btn-link btn-sm';
                replyBtn.textContent = 'å›å¤';
                replyBtn.addEventListener('click', () => openReply(cmt.id, li));
                actions.appendChild(replyBtn);
            }

            if (IS_ADMIN || (cmt.author && cmt.author.id === CURRENT_USER_ID)) {
                const delBtn = document.createElement('button');
                delBtn.type = 'button';
                delBtn.className = 'btn btn-link btn-sm text-danger';
                delBtn.textContent = 'åˆ é™¤';
                delBtn.addEventListener('click', () => deleteComment(cmt.id));
                actions.appendChild(delBtn);
            }

            li.appendChild(meta);
            li.appendChild(content);
            li.appendChild(actions);

            if (Array.isArray(cmt.children) && cmt.children.length > 0) {
                const children = document.createElement('ul');
                children.className = 'children comment-list';
                cmt.children.forEach(child => children.appendChild(renderItem(child)));
                li.appendChild(children);
            }

            return li;
        }

        function openReply(parentId, liEl) {
            // å°†ä¸»è¡¨å•ç§»åŠ¨åˆ°ç›®æ ‡è¯„è®ºä¸‹æ–¹å¹¶è®¾ç½® parent_id
            if (!formEl || !contentEl || !parentIdEl) return;
            parentIdEl.value = parentId || '';
            contentEl.value = '';
            liEl.appendChild(formEl);
            contentEl.focus();
        }

        async function deleteComment(commentId) {
            const ok = window.confirm('ç¡®è®¤åˆ é™¤è¯¥è¯„è®ºï¼Ÿ');
            if (!ok) return;
            const url = DELETE_URL_TPL.replace('__CID__', commentId);
            try {
                const res = await fetch(url, { method: 'DELETE', credentials: 'same-origin' });
                const data = await res.json();
                if (data.code === 200) {
                    if (typeof showToast === 'function') showToast('å·²åˆ é™¤', 'success');
                    loadComments();
                } else {
                    if (typeof showToast === 'function') showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                if (typeof showToast === 'function') showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        }

        function formatTime(iso) {
            if (!iso) return '';
            try {
                const d = new Date(iso);
                return d.toLocaleString();
            } catch { return iso; }
        }

        if (formEl) {
            formEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!CAN_COMMENT) return;
                const content = (contentEl.value || '').trim();
                if (!content) {
                    if (typeof showToast === 'function') showToast('è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º', 'info');
                    return;
                }
                if (content.length > 2000) {
                    if (typeof showToast === 'function') showToast('è¯„è®ºå†…å®¹ä¸èƒ½è¶…è¿‡2000å­—', 'info');
                    return;
                }
                const payload = { content };
                const pid = (parentIdEl.value || '').trim();
                if (pid) payload.parent_id = pid;
                try {
                    const res = await fetch(CREATE_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.code === 200) {
                        if (typeof showToast === 'function') showToast('è¯„è®ºæˆåŠŸ', 'success');
                        // é‡ç½®ä¸ºé¡¶å±‚è¡¨å•ï¼šæ”¾å›è¯„è®ºåŒºé¡¶éƒ¨
                        parentIdEl.value = '';
                        contentEl.value = '';
                        section.insertBefore(formEl, listEl);
                        loadComments();
                    } else {
                        if (typeof showToast === 'function') showToast(data.message || 'è¯„è®ºå¤±è´¥', data.code === 429 ? 'warning' : 'error');
                    }
                } catch (e) {
                    if (typeof showToast === 'function') showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                }
            });
        }

        // åˆæ¬¡åŠ è½½
        loadComments();
    })();

    // ç®¡ç†å‘˜ï¼šç‚¹èµè€…åˆ—è¡¨ï¼ˆæ—  Bootstrapï¼‰
    (function () {
        const btn = document.getElementById('admin-likers-btn');
        if (!btn) return;
        const listEl = document.getElementById('likers-list');
        const pageInfo = document.getElementById('likers-pageinfo');
        const prevBtn = document.getElementById('likers-prev');
        const nextBtn = document.getElementById('likers-next');
        const modalEl = document.getElementById('likersModal');
        const LIKERS_URL = btn.dataset.likersUrl;
        let offset = 0;
        const limit = 20;

        async function loadLikers() {
            listEl.innerHTML = '<div class="text-muted">åŠ è½½ä¸­...</div>';
            try {
                const res = await fetch(`${LIKERS_URL}?offset=${offset}&limit=${limit}`);
                const data = await res.json();
                if (data.code !== 200) throw new Error(data.message || 'åŠ è½½å¤±è´¥');
                const { users = [], total = 0 } = data;
                listEl.innerHTML = '';
                if (users.length === 0) {
                    listEl.innerHTML = '<div class="text-muted">æš‚æ— ç‚¹èµè€…</div>';
                } else {
                    for (const u of users) {
                        const item = document.createElement('a');
                        item.className = 'list-group-item list-group-item-action d-flex align-items-center';
                        item.innerHTML = `
                            <img src="${u.avatar_url}" style="width:28px;height:28px;border-radius:6%;margin-right:10px;" />
                            <div class="d-flex flex-column">
                                <strong>${u.username || u.id}</strong>
                                <small class="text-muted">${u.liked_at || ''}</small>
                            </div>
                        `;
                        listEl.appendChild(item);
                    }
                }
                const cur = Math.floor(offset / limit) + 1;
                const pages = Math.max(1, Math.ceil(total / limit));
                pageInfo.textContent = `${cur} / ${pages} é¡µï¼ˆå…± ${total} äººï¼‰`;
                prevBtn.disabled = offset <= 0;
                nextBtn.disabled = offset + limit >= total;
            } catch (e) {
                listEl.innerHTML = '<div class="text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</div>';
            }
        }

        setupModal(modalEl);
        btn.addEventListener('click', () => { openModal(modalEl); loadLikers(); });
        prevBtn.addEventListener('click', () => { offset = Math.max(0, offset - limit); loadLikers(); });
        nextBtn.addEventListener('click', () => { offset += limit; loadLikers(); });
    })();

    // åˆ é™¤æ–‡ç« ï¼ˆæ—  Bootstrapï¼‰ - å…¼å®¹æ— æ¨¡æ€åœºæ™¯
    (function () {
        const delBtn = document.getElementById('admin-delete-btn');
        if (!delBtn) return;
        const confirmBtn = document.getElementById('confirm-delete-btn');
        const deleteModal = document.getElementById('deleteConfirmModal');
        const DELETE_URL = delBtn.dataset.deleteUrl;
        const REDIRECT_URL = delBtn.dataset.redirectUrl;

        // è‹¥é¡µé¢å­˜åœ¨æ¨¡æ€æ¡†ï¼ˆç®¡ç†å‘˜è§†å›¾ï¼‰ï¼Œä½¿ç”¨æ¨¡æ€ç¡®è®¤
        if (deleteModal && confirmBtn) {
            setupModal(deleteModal);
            delBtn.addEventListener('click', () => { openModal(deleteModal); });
            confirmBtn.addEventListener('click', async () => {
                confirmBtn.disabled = true;
                try {
                    const res = await fetch(DELETE_URL, { method: 'DELETE' });
                    const data = await res.json();
                    if (data.code === 200) {
                        if (typeof showToast === 'function') showToast('æ–‡ç« å·²åˆ é™¤', 'success');
                        closeModal(deleteModal);
                        window.location.href = REDIRECT_URL;
                    } else {
                        if (typeof showToast === 'function') showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                    }
                } catch (e) {
                    if (typeof showToast === 'function') showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
                } finally {
                    confirmBtn.disabled = false;
                }
            });
            return;
        }

        // å¦åˆ™ï¼ˆéç®¡ç†å‘˜åœºæ™¯ï¼‰ï¼Œä½¿ç”¨åŸç”Ÿ confirm ä½œä¸ºåå¤‡
        delBtn.addEventListener('click', async () => {
            const ok = window.confirm('ç¡®è®¤åˆ é™¤è¿™ç¯‡æ–‡ç« ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚');
            if (!ok) return;
            try {
                const res = await fetch(DELETE_URL, { method: 'DELETE' });
                const data = await res.json();
                if (data.code === 200) {
                    if (typeof showToast === 'function') showToast('æ–‡ç« å·²åˆ é™¤', 'success');
                    window.location.href = REDIRECT_URL;
                } else {
                    if (typeof showToast === 'function') showToast(data.message || 'åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (e) {
                if (typeof showToast === 'function') showToast('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
        });
    })();
</script>
{% endblock %}

{% block footer_text %}
{% endblock %}
