{% extends "base.html" %}

{% block title %}{{ blog.title }} - 文章阅读{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pygments-default.css') }}" id="pygments-default">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pygments-Monokai.css') }}" id="pygments-monokai">
<!-- MathJax 配置 -->
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']],
    processEscapes: true,
    processEnvironments: true
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
    ignoreHtmlClass: 'tex2jax_ignore'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<style>
    .read-hero {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 50px 0 30px;
        text-align: center;
    }

    .read-hero h1 {
        font-size: 2.2rem;
        font-weight: 400;
        color: #2c3e50;
        margin-bottom: 15px;
    }

    .blog-meta {
        color: #7f8c8d;
        font-size: 1rem;
        margin-bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .blog-author::before {
        margin-right: 5px;
    }

    .blog-date::before {
        content: '📅';
        margin-right: 5px;
    }

    .blog-content-container {
        max-width: 900px;
        margin: 40px auto 60px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
        padding: 40px;
        font-size: 1.15rem;
        line-height: 2;
        color: #2c3e50;
    }

    .blog-content-container-container {
        margin: 0 auto;
        padding: 0 20px;
    }

    .blog-content-container p {
        margin-bottom: 1.5em;
        text-align: justify;
    }

    /* 博客内容标题样式 */
    .blog-content-container h1,
    .blog-content-container h2,
    .blog-content-container h3,
    .blog-content-container h4,
    .blog-content-container h5,
    .blog-content-container h6 {
        margin: 2em 0 1em;
        font-weight: 600;
        color: #2c3e50;
    }

    .blog-content-container h1 {
        font-size: 1.8rem;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }

    .blog-content-container h2 {
        font-size: 1.5rem;
    }

    .blog-content-container h3 {
        font-size: 1.3rem;
    }

    /* 代码块样式 */
    .blog-content-container pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        overflow-x: auto;
        margin: 1.5em 0;
    }

    .blog-content-container code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }

    .blog-content-container pre code {
        background: none;
        padding: 0;
    }

    /* 引用样式 */
    .blog-content-container blockquote {
        border-left: 4px solid #3498db;
        margin: 1.5em 0;
        padding: 10px 20px;
        background: #f8f9fa;
        font-style: italic;
    }

    /* 列表样式 */
    .blog-content-container ul,
    .blog-content-container ol {
        margin: 1.5em 0;
        padding-left: 2em;
    }

    .blog-content-container li {
        margin-bottom: 0.5em;
    }

    /* 链接样式 */
    .blog-content-container a {
        color: #3498db;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-bottom 0.2s ease;
    }

    .blog-content-container a:hover {
        color: #2980b9;
        border-bottom: 1px solid #2980b9;
        text-decoration: none;
    }

    /* 图片样式 */
    .blog-content-container img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 1.5em 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* 表格样式 */
    .blog-content-container table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5em 0;
    }

    .blog-content-container th,
    .blog-content-container td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }

    .blog-content-container th {
        background: #f8f9fa;
        font-weight: 600;
    }

    /* 数学公式样式 */
    .blog-content-container .MathJax_Display {
        margin: 1.5em 0;
        text-align: center;
        overflow-x: auto;
        overflow-y: hidden;
    }

    .blog-content-container .MathJax {
        font-size: 1.1em;
        max-width: 100%;
    }

    /* 行内数学公式样式 */
    .blog-content-container .MathJax_SVG {
        vertical-align: middle;
        max-width: 100%;
        height: auto;
    }

    /* 自适应字体大小的数学公式 */
    .blog-content-container mjx-container {
        max-width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
    }

    .blog-content-container mjx-container[jax="CHTML"][display="true"] {
        text-align: center;
        margin: 1.5em 0;
    }

    /* 当公式过长时自动调整字体大小 */
    .blog-content-container mjx-container[jax="CHTML"][display="true"] mjx-math {
        font-size: min(1.1em, calc(100vw / var(--formula-width, 20)));
    }

    .blog-content-container mjx-container[jax="CHTML"][display="false"] mjx-math {
        font-size: min(1em, calc(100vw / var(--formula-width, 25)));
    }

    /* 深色模式下的数学公式 */
    body.dark-mode .MathJax_SVG * {
        fill: var(--text) !important;
        stroke: var(--text) !important;
    }

    body.dark-mode mjx-container mjx-math {
        color: var(--text) !important;
    }

    .blog-content-container .highlight {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        overflow-x: auto;
        margin: 1.5em 0;
        position: relative;
    }

    .blog-content-container .highlight pre {
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.4;
    }

    .blog-content-container .highlight code {
        background: none;
        padding: 0;
        border-radius: 0;
        font-size: inherit;
    }

    /* 行内代码样式 */
    .blog-content-container code:not(.highlight code) {
        background: #f1f3f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        color: #d73a49;
    }

    /* 深色模式下的代码样式 */
    body.dark-mode .blog-content-container .highlight {
        background: #2d3748;
        border-color: #4a5568;
    }

    body.dark-mode .blog-content-container code:not(.highlight code) {
        background: #4a5568;
        color: #f56565;
    }

    /* 代码复制按钮样式优化 */
    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #3498db;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 0.8rem;
        cursor: pointer;
        opacity: 0.8;
        transition: all 0.2s ease;
        font-family: system-ui, -apple-system, sans-serif;
    }

    .copy-btn:hover {
        opacity: 1;
        background: #2980b9;
    }

    .read-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        margin: 30px auto 40px;
        max-width: 700px;
        padding: 0 20px;
        flex-wrap: wrap;
    }

    /* 管理员操作区域单独一行 */
    .admin-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin: -10px auto 30px; /* 与上方控件间距更紧凑一点 */
        max-width: 900px;
        padding: 0 20px;
        flex-wrap: wrap;
    }

    .read-btn {
        background: #2c3e50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 500;
        text-decoration: none;
        font-size: 1rem;
        transition: all 0.3s ease;
        min-width: 120px;
        text-align: center;
    }

    .read-btn:hover {
        background: #34495e;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }

    /* 点赞按钮样式 */
    .like-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #ffffff;
        color: #e74c3c;
        border: 1px solid #f2d7d5;
        padding: 10px 16px;
        border-radius: 999px;
        box-shadow: 0 2px 10px rgba(231, 76, 60, 0.08);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .like-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(231, 76, 60, 0.15);
        border-color: #f5b7b1;
    }

    .like-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .like-btn .bi {
        font-size: 1.1rem;
    }

    .like-count-badge {
        background: #fdecea;
        color: #c0392b;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.85rem;
        line-height: 1.2;
    }

    .like-btn.liked {
        background: linear-gradient(135deg, #ff7675, #e74c3c);
        color: #fff;
        border-color: #e74c3c;
        box-shadow: 0 6px 18px rgba(231, 76, 60, 0.25);
    }

    .like-btn.liked .like-count-badge {
        background: rgba(255, 255, 255, 0.25);
        color: #fff;
    }

    /* 深色主题下的未点赞样式 */
    body.dark-mode .like-btn:not(.liked) {
        background: #1f242b;
        color: #ffb3ae;
        border-color: #2f3640;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
    }

    body.dark-mode .like-btn:not(.liked):hover {
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
        border-color: #3a4350;
    }

    body.dark-mode .like-btn:not(.liked) .like-count-badge {
        background: #2b323c;
        color: #ffd7d4;
    }

    /* 主题切换按钮样式 */
    #toggle-theme {
        font-size: 0.9rem;
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.3s ease;
        margin-top: 15px;
    }

    /* 阅读进度条 */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: #3498db;
        z-index: 1000;
        transition: width 0.1s ease;
    }

    @media (max-width: 768px) {
        .read-hero h1 {
            font-size: 1.8rem;
        }

        .blog-meta {
            flex-direction: column;
            gap: 10px;
        }

        .blog-content-container {
            padding: 25px 20px;
            margin: 20px auto 40px;
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .read-controls {
            padding: 0 15px;
            margin: 20px auto 30px;
            gap: 12px;
        }

        .read-btn {
            padding: 10px 16px;
            font-size: 0.9rem;
            min-width: 100px;
        }

        .blog-content-container-container {
            padding: 0 10px;
        }

        .blog-content-container h1 {
            font-size: 1.5rem;
        }

        .blog-content-container h2 {
            font-size: 1.3rem;
        }

        .blog-content-container h3 {
            font-size: 1.2rem;
        }

        /* 移动端：让复制按钮不遮挡代码，放到代码块下方显示 */
        .copy-btn {
            position: static;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            top: auto;
            right: auto;
            margin-top: 8px;
            padding: 6px 10px;
            font-size: 0.85rem;
        }
        /* 代码块在移动端内边距稍微增大，避免拥挤 */
        .blog-content-container .highlight {
            padding: 12px;
        }

        /* 移动端数学公式优化 */
        .blog-content-container mjx-container[jax="CHTML"][display="true"] {
            margin: 1em 0;
        }

        .blog-content-container mjx-container[jax="CHTML"] {
            overflow-x: auto;
            max-width: 100%;
        }

        .blog-content-container mjx-container[jax="CHTML"] mjx-math {
            font-size: 0.9em !important;
            min-width: max-content;
        }
    }

    /* CSS 变量 */
    :root {
        --bg: #f3f5f7;
        --text: #2c3e50;
        --box-bg: #ffffff;
        --hero-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --btn-bg: #2c3e50;
        --btn-hover-bg: #34495e;
        --shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
        --code-bg: #f8f9fa;
        --border-color: #e9ecef;
        --link-color: #3498db;
        --link-hover-color: #2980b9;
    }

    body.dark-mode {
        --bg: #121212;
        --text: #ecf0f1;
        --box-bg: #1e1e1e;
        --hero-bg: linear-gradient(135deg, #1c1d22 0%, #212224 100%);
        --btn-bg: #3498db;
        --btn-hover-bg: #2980b9;
        --shadow: 0 2px 16px rgba(0, 0, 0, 0.3);
        --code-bg: #2d3748;
        --border-color: #4a5568;
        --link-color: #5dade2;
        --link-hover-color: #3498db;
    }

    body {
        background-color: var(--bg);
        color: var(--text);
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .read-hero {
        background: var(--hero-bg);
    }

    .read-hero h1,
    .blog-meta {
        color: var(--text);
    }

    .blog-content-container {
        background-color: var(--box-bg);
        color: var(--text);
        box-shadow: var(--shadow);
    }

    .blog-content-container h1,
    .blog-content-container h2,
    .blog-content-container h3,
    .blog-content-container h4,
    .blog-content-container h5,
    .blog-content-container h6 {
        color: var(--text);
    }

    .blog-content-container pre,
    .blog-content-container code,
    .blog-content-container blockquote,
    .blog-content-container th {
        background: var(--code-bg);
    }

    .blog-content-container th,
    .blog-content-container td {
        border-color: var(--border-color);
    }

    .blog-content-container a {
        color: var(--link-color);
    }

    .blog-content-container a:hover {
        color: var(--link-hover-color);
        border-bottom-color: var(--link-hover-color);
    }

    .read-btn {
        background: var(--btn-bg);
    }

    .read-btn:hover {
        background: var(--btn-hover-bg);
    }
</style>
{% endblock %}

{% block content %}
<!-- 阅读进度条 -->
<div class="reading-progress"></div>

<section class="read-hero">
    <h1>{{ blog.title }}</h1>
    <div class="blog-meta">
        <span class="blog-author">
            <img src="/auth/avatar/{{ blog.author_id }}"
                style="width:24px; height:24px; border-radius:10%; margin-right:8px;">
            {{ blog.author }}</span>
        <span class="blog-date">{{ blog.date }}</span>
    </div>
    <button id="toggle-theme" class="btn btn-outline-secondary">切换深色模式</button>
</section>

<div class="blog-content-container-container">
    <div class="blog-content-container" id="userContentContainer">
        <template id="userContentTemplate">
            {{ blog.content | safe }}
        </template>
    </div>
</div>

<div class="read-controls">
    <button
        id="like-btn"
        class="like-btn {{ 'liked' if blog.liked else '' }}"
        data-auth="{{ 1 if current_user.is_authenticated else 0 }}"
        data-login-url="{{ url_for('auth.login') }}"
        data-like-url="{{ url_for('blog.like_toggle', blog_id=blog.id) }}"
        aria-label="点赞"
    >
        <i id="like-icon" class="bi {{ 'bi-heart-fill' if blog.liked else 'bi-heart' }}"></i>
        <span id="like-text">{{ '已点赞' if blog.liked else '点赞' }}</span>
        <span class="like-count-badge" id="like-count">{{ blog.likes_count or 0 }}</span>
    </button>

    <a href="{{ url_for('blog.menu') }}" class="read-btn">📝 返回博客列表</a>
</div>
{% if current_user.is_authenticated and (current_user.is_admin or current_user.id == blog.author_id) %}
<div class="admin-controls">
    {% if current_user.is_admin %}
    <button id="admin-likers-btn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#likersModal" data-likers-url="{{ url_for('blog.likers', blog_id=blog.id) }}">
        👍 查看点赞者
    </button>
    <button id="admin-delete-btn" class="btn btn-outline-danger" data-delete-url="{{ url_for('blog.delete_blog', blog_id=blog.id) }}" data-redirect-url="{{ url_for('blog.menu') }}">
        🗑️ 删除文章
    </button>
    {% endif %}
    <a href="{{ url_for('blog.edit_blog', blog_id=blog.id) }}" class="btn btn-outline-primary">✏️ 编辑文章</a>
    
</div>
{% endif %}
{% if current_user.is_authenticated and current_user.is_admin %}
<!-- 点赞者列表 Modal -->
<div class="modal fade" id="likersModal" tabindex="-1" aria-labelledby="likersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="likersModalLabel">点赞者列表</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="likers-list" class="list-group" style="max-height: 50vh; overflow: auto;"></div>
        <div class="d-flex justify-content-between align-items-center mt-3">
            <button id="likers-prev" class="btn btn-sm btn-outline-secondary">上一页</button>
            <small id="likers-pageinfo" class="text-muted"></small>
            <button id="likers-next" class="btn btn-sm btn-outline-secondary">下一页</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<!-- 删除确认 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmLabel">确认删除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        确定要删除这篇文章《{{ blog.title }}》吗？该操作不可恢复。
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" id="confirm-delete-btn" class="btn btn-danger">确认删除</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block copyright %}
作者：{{ blog.author }} | 版权归原作者所有  

{% endblock %}

{% block extra_js %}
<script>
    // 主题切换功能
    // 安全渲染函数
    function renderUserContent() {
        const container = document.getElementById('userContentContainer');
        const template = document.getElementById('userContentTemplate');

        // 克隆模板内容（此时仍为惰性文档片段）
        const fragment = template.content.cloneNode(true);
        // 激活并插入DOM
        container.appendChild(fragment);
    }

    // 对内容区域中的链接进行安全加固：
    // - 外链添加 rel="noopener noreferrer nofollow"
    // - 外链在新窗口打开 target="_blank"
    // - 移除不安全协议（除 http/https/mailto/tel 外）
    function hardenLinks() {
        const anchors = document.querySelectorAll('.blog-content-container a[href]');
        anchors.forEach(a => {
            const href = a.getAttribute('href') || '';
            try {
                const url = new URL(href, window.location.origin);
                const protocol = url.protocol.toLowerCase();
                const isHttp = protocol === 'http:' || protocol === 'https:';
                const isAllowed = isHttp || protocol === 'mailto:' || protocol === 'tel:';
                if (!isAllowed) {
                    a.removeAttribute('href');
                    return;
                }
                if (isHttp) {
                    const relParts = new Set((a.getAttribute('rel') || '').split(/\s+/).filter(Boolean));
                    ['noopener', 'noreferrer', 'nofollow'].forEach(v => relParts.add(v));
                    a.setAttribute('rel', Array.from(relParts).join(' '));
                    if (url.origin !== window.location.origin) {
                        a.setAttribute('target', '_blank');
                    }
                }
            } catch (e) {
                // 非法URL，移除href
                a.removeAttribute('href');
            }
        });
    }
    const toggleBtn = document.getElementById('toggle-theme');
    const isDark = localStorage.getItem('theme') === 'dark';

    if (isDark) {
        document.body.classList.add('dark-mode');
        toggleBtn.innerText = '切换亮色模式';
    }
    updatePygmentsTheme(isDark);

    toggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const nowDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', nowDark ? 'dark' : 'light');
        toggleBtn.innerText = nowDark ? '切换亮色模式' : '切换深色模式';
        updatePygmentsTheme(nowDark);
    });

    // 阅读进度条
    function updateReadingProgress() {
        const article = document.querySelector('.blog-content-container');
        const scrollTop = window.pageYOffset;
        const docHeight = document.body.scrollHeight - window.innerHeight;
        const scrollPercent = Math.min((scrollTop / docHeight) * 100, 100);

        let progressBar = document.querySelector('.reading-progress');
        if (!progressBar) {
            progressBar = document.createElement('div');
            progressBar.className = 'reading-progress';
            document.body.appendChild(progressBar);
        }

        progressBar.style.width = scrollPercent + '%';
    }

    // 代码块复制功能
    function addCopyButtons() {
        const codeBlocks = document.querySelectorAll('.highlight');
        codeBlocks.forEach((block, index) => {
            const button = document.createElement('button');
            button.innerHTML = '📋 复制';
            button.className = 'copy-btn';

            block.style.position = 'relative';
            block.appendChild(button);

            button.addEventListener('click', async () => {
                const code = block.querySelector('code');
                if (code) {
                    try {
                        await navigator.clipboard.writeText(code.textContent);
                        button.innerHTML = '✅ 已复制';
                        button.style.background = '#27ae60';
                        setTimeout(() => {
                            button.innerHTML = '📋 复制';
                            button.style.background = '#3498db';
                        }, 2000);
                    } catch (err) {
                        // 降级方案
                        const textArea = document.createElement('textarea');
                        textArea.value = code.textContent;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);

                        button.innerHTML = '✅ 已复制';
                        setTimeout(() => {
                            button.innerHTML = '📋 复制';
                        }, 2000);
                    }
                }
            });
        });
    }

    // 图片点击放大功能
    function addImageZoom() {
        const images = document.querySelectorAll('.blog-content-container img');
        images.forEach(img => {
            img.style.cursor = 'pointer';
            img.addEventListener('click', () => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    cursor: pointer;
                `;

                const zoomedImg = img.cloneNode();
                zoomedImg.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                `;

                overlay.appendChild(zoomedImg);
                document.body.appendChild(overlay);

                overlay.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });
            });
        });
    }

    // 调整数学公式大小以适应容器宽度
    function adjustMathFormulaSizes() {
        const container = document.querySelector('.blog-content-container');
        if (!container) return;

        const containerWidth = container.clientWidth;
        const mathContainers = container.querySelectorAll('mjx-container[jax="CHTML"]');

        mathContainers.forEach(mathContainer => {
            const mathElement = mathContainer.querySelector('mjx-math');
            if (!mathElement) return;

            // 获取数学公式的实际宽度
            const mathWidth = mathContainer.scrollWidth;
            const isDisplayMode = mathContainer.getAttribute('display') === 'true';
            
            // 计算容器可用宽度（考虑内边距）
            const availableWidth = containerWidth - 80; // 减去左右内边距
            
            if (mathWidth > availableWidth) {
                // 计算需要的缩放比例
                const scale = availableWidth / mathWidth;
                const newFontSize = scale * (isDisplayMode ? 1.1 : 1.0);
                
                // 设置最小字体大小限制
                const minFontSize = isDisplayMode ? 0.7 : 0.8;
                const finalFontSize = Math.max(newFontSize, minFontSize);
                
                mathElement.style.fontSize = finalFontSize + 'em';
                
                // 为行内公式添加水平滚动
                if (!isDisplayMode && scale < 0.8) {
                    mathContainer.style.overflowX = 'auto';
                    mathContainer.style.display = 'inline-block';
                    mathContainer.style.maxWidth = '100%';
                }
            }
        });

        // 处理移动端的特殊情况
        if (window.innerWidth <= 768) {
            mathContainers.forEach(mathContainer => {
                const mathElement = mathContainer.querySelector('mjx-math');
                if (!mathElement) return;

                const isDisplayMode = mathContainer.getAttribute('display') === 'true';
                const currentFontSize = parseFloat(window.getComputedStyle(mathElement).fontSize);
                
                // 在移动端进一步缩小公式
                if (isDisplayMode) {
                    mathElement.style.fontSize = Math.min(currentFontSize * 0.9, 16) + 'px';
                } else {
                    mathElement.style.fontSize = Math.min(currentFontSize * 0.85, 14) + 'px';
                }
            });
        }
    }

    // 滚动事件监听
    window.addEventListener('scroll', updateReadingProgress);

    // 窗口大小变化时重新调整数学公式大小
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            adjustMathFormulaSizes();
        }, 200);
    });

    // 页面加载时自动适配系统主题
    document.addEventListener('DOMContentLoaded', () => {
        renderUserContent();
        hardenLinks();
        let isDark = localStorage.getItem('theme') === 'dark';
        if (!localStorage.getItem('theme')) {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
                document.getElementById('toggle-theme').innerText = '切换亮色模式';
                isDark = true;
            }
        }
        updatePygmentsTheme(document.body.classList.contains('dark-mode'));
        updateReadingProgress();
        addCopyButtons();
        addImageZoom();

        // 渲染数学公式
        if (window.MathJax) {
            MathJax.typesetPromise([document.querySelector('.blog-content-container')]).then(() => {
                console.log('MathJax rendering completed');
                // 渲染完成后调整过长公式的字体大小
                adjustMathFormulaSizes();
            }).catch((err) => console.log('MathJax rendering failed: ' + err.message));
        }

        // 平滑滚动到内容区域（如果有锚点）
        if (window.location.hash) {
            const target = document.querySelector(window.location.hash);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        }
    });

    function updatePygmentsTheme(isDark) {
        document.getElementById('pygments-default').disabled = isDark;
        document.getElementById('pygments-monokai').disabled = !isDark;
    }

    // 点赞功能
    (function () {
        const likeBtn = document.getElementById('like-btn');
        if (!likeBtn) return;
        const IS_AUTHENTICATED = likeBtn.dataset.auth === '1';
        const LOGIN_URL = likeBtn.dataset.loginUrl;
        const LIKE_URL = likeBtn.dataset.likeUrl;
        const likeIcon = document.getElementById('like-icon');
        const likeText = document.getElementById('like-text');
        const likeCount = document.getElementById('like-count');

        likeBtn.addEventListener('click', async () => {
            if (!IS_AUTHENTICATED) {
                if (typeof showToast === 'function') {
                    showToast('请先登录后再点赞', 'info');
                }
                window.location.href = LOGIN_URL;
                return;
            }
            likeBtn.disabled = true;
            try {
                const res = await fetch(LIKE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                const data = await res.json();
                if (data.code === 200) {
                    const liked = !!data.liked;
                    likeCount.textContent = data.likes_count;
                    likeIcon.className = 'bi ' + (liked ? 'bi-heart-fill' : 'bi-heart');
                    likeText.textContent = liked ? '已点赞' : '点赞';
                    likeBtn.classList.toggle('liked', liked);
                    if (typeof showToast === 'function') {
                        showToast(liked ? '已点赞' : '已取消点赞', liked ? 'success' : 'info');
                    }
                } else {
                    if (typeof showToast === 'function') showToast(data.message || '操作失败', 'error');
                }
            } catch (e) {
                if (typeof showToast === 'function') showToast('网络错误，请稍后重试', 'error');
            } finally {
                likeBtn.disabled = false;
            }
        });
    })();

    // 管理员：点赞者列表
    (function () {
        const btn = document.getElementById('admin-likers-btn');
        if (!btn) return;
        const listEl = document.getElementById('likers-list');
        const pageInfo = document.getElementById('likers-pageinfo');
        const prevBtn = document.getElementById('likers-prev');
        const nextBtn = document.getElementById('likers-next');
        const LIKERS_URL = btn.dataset.likersUrl;
        let offset = 0;
        const limit = 20;

        async function loadLikers() {
            listEl.innerHTML = '<div class="text-muted">加载中...</div>';
            try {
                const res = await fetch(`${LIKERS_URL}?offset=${offset}&limit=${limit}`);
                const data = await res.json();
                if (data.code !== 200) throw new Error(data.message || '加载失败');
                const { users = [], total = 0 } = data;
                listEl.innerHTML = '';
                if (users.length === 0) {
                    listEl.innerHTML = '<div class="text-muted">暂无点赞者</div>';
                } else {
                    for (const u of users) {
                        const item = document.createElement('a');
                        item.className = 'list-group-item list-group-item-action d-flex align-items-center';
                        item.innerHTML = `
                            <img src="${u.avatar_url}" style="width:28px;height:28px;border-radius:6%;margin-right:10px;" />
                            <div class="d-flex flex-column">
                                <strong>${u.username || u.id}</strong>
                                <small class="text-muted">${u.liked_at || ''}</small>
                            </div>
                        `;
                        listEl.appendChild(item);
                    }
                }
                const cur = Math.floor(offset / limit) + 1;
                const pages = Math.max(1, Math.ceil(total / limit));
                pageInfo.textContent = `${cur} / ${pages} 页（共 ${total} 人）`;
                prevBtn.disabled = offset <= 0;
                nextBtn.disabled = offset + limit >= total;
            } catch (e) {
                listEl.innerHTML = '<div class="text-danger">加载失败，请重试</div>';
            }
        }

        document.getElementById('likersModal').addEventListener('shown.bs.modal', loadLikers);
        prevBtn.addEventListener('click', () => { offset = Math.max(0, offset - limit); loadLikers(); });
        nextBtn.addEventListener('click', () => { offset += limit; loadLikers(); });
    })();

    // 管理员：删除文章
    (function () {
        const delBtn = document.getElementById('admin-delete-btn');
        if (!delBtn) return;
        const confirmBtn = document.getElementById('confirm-delete-btn');
        const DELETE_URL = delBtn.dataset.deleteUrl;
        const REDIRECT_URL = delBtn.dataset.redirectUrl;

        delBtn.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        });

        confirmBtn.addEventListener('click', async () => {
            confirmBtn.disabled = true;
            try {
                const res = await fetch(DELETE_URL, { method: 'DELETE' });
                const data = await res.json();
                if (data.code === 200) {
                    if (typeof showToast === 'function') showToast('文章已删除', 'success');
                    window.location.href = REDIRECT_URL;
                } else {
                    if (typeof showToast === 'function') showToast(data.message || '删除失败', 'error');
                }
            } catch (e) {
                if (typeof showToast === 'function') showToast('网络错误，请稍后重试', 'error');
            } finally {
                confirmBtn.disabled = false;
            }
        });
    })();
</script>
{% endblock %}

{% block footer_text %}
{% endblock %}