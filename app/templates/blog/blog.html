{% extends "base.html" %}

{% block title %}{{ blog.title }} - 文章阅读{% endblock %}

{% block extra_css %}
<!-- CSS 样式表 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css" id="hljs-light">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/monokai.min.css" id="hljs-dark" disabled>

<!-- JavaScript 库（按依赖顺序加载） -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js" onerror="console.error('DOMPurify 加载失败')"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js" onerror="console.error('highlight.js 加载失败')"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js" onerror="console.error('marked.js 加载失败')"></script>
<!-- MathJax 配置和加载 -->
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']],
            processEscapes: true,
            processEnvironments: true,
            processRefs: true,
            packages: {'[+]': ['ams', 'newcommand', 'configmacros', 'action', 'bbox', 'boldsymbol', 'braket', 'cancel', 'color', 'enclose', 'extpfeil', 'mhchem', 'newcommand', 'unicode', 'verb']},
            macros: {
                RR: "\\mathbb{R}",
                NN: "\\mathbb{N}",
                ZZ: "\\mathbb{Z}",
                QQ: "\\mathbb{Q}",
                CC: "\\mathbb{C}",
                PP: "\\mathbb{P}",
                EE: "\\mathbb{E}",
                FF: "\\mathbb{F}",
                bold: ["\\mathbf{" + "#1}", 1],
                bm: ["\\boldsymbol{" + "#1}", 1]
            }
        },
        options: {
            ignoreHtmlClass: 'tex2jax_ignore',
            processHtmlClass: 'tex2jax_process',
            renderActions: {
                findScript: [10, function (doc) {
                    for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                        const display = !!node.type.match(/; *mode=display/);
                        const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
                        const text = document.createTextNode('');
                        node.parentNode.replaceChild(text, node);
                        math.start = {node: text, delim: '', n: 0};
                        math.end = {node: text, delim: '', n: 0};
                        doc.math.push(math);
                    }
                }, '']
            }
        },
        chtml: {
            fontURL: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/output/chtml/fonts/woff-v2'
        },
        svg: {
            fontCache: 'global'
        },
        startup: {
            ready: function () {
                console.log('MathJax 加载完成');
                MathJax.startup.defaultReady();
            }
        }
    };
</script>
<!-- 移除有问题的 polyfill.io，改用更稳定的方案 -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" onerror="console.error('MathJax 加载失败')"></script>
<style>
    .read-hero {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 50px 0 30px;
        text-align: center;
    }

    .read-hero h1 {
        font-size: 2.2rem;
        font-weight: 400;
        color: #2c3e50;
        margin-bottom: 15px;
    }

    .blog-meta {
        color: #7f8c8d;
        font-size: 1rem;
        margin-bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .blog-author::before {
        margin-right: 5px;
    }

    .blog-date::before {
        content: '📅';
        margin-right: 5px;
    }

    .blog-content-container {
        max-width: 900px;
        margin: 40px auto 60px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
        padding: 40px;
        font-size: 1.15rem;
        line-height: 2;
        color: #2c3e50;
    }

    .blog-content-container-container {
        margin: 0 auto;
        padding: 0 20px;
    }

    .blog-content-container p {
        margin-bottom: 1.5em;
        text-align: justify;
    }

    /* 博客内容标题样式 */
    .blog-content-container h1,
    .blog-content-container h2,
    .blog-content-container h3,
    .blog-content-container h4,
    .blog-content-container h5,
    .blog-content-container h6 {
        margin: 2em 0 1em;
        font-weight: 600;
        color: #2c3e50;
    }

    .blog-content-container h1 {
        font-size: 1.8rem;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
    }

    .blog-content-container h2 {
        font-size: 1.5rem;
    }

    .blog-content-container h3 {
        font-size: 1.3rem;
    }

    /* 代码块样式 */
    .blog-content-container pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        overflow-x: auto;
        margin: 1.5em 0;
    }

    .blog-content-container code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
    }

    .blog-content-container pre code {
        background: none;
        padding: 0;
    }

    /* 引用样式 */
    .blog-content-container blockquote {
        border-left: 4px solid #3498db;
        margin: 1.5em 0;
        padding: 10px 20px;
        background: #f8f9fa;
        font-style: italic;
    }

    /* 列表样式 */
    .blog-content-container ul,
    .blog-content-container ol {
        margin: 1.5em 0;
        padding-left: 2em;
    }

    .blog-content-container li {
        margin-bottom: 0.5em;
    }

    /* 任务列表样式 */
    .blog-content-container li input[type="checkbox"] {
        margin-right: 0.5em;
        cursor: default;
    }

    /* 任务列表样式 - 使用更兼容的选择器 */
    .blog-content-container li.task-list-item {
        list-style: none;
        margin-left: -1.5em;
    }

    /* 后备样式：如果 :has 选择器不被支持，这个样式会作为备选 */
    @supports not (selector(:has(*))) {
        .blog-content-container li:first-child input[type="checkbox"] {
            margin-left: -1.5em;
        }
    }

    /* 链接样式 */
    .blog-content-container a {
        color: #3498db;
        text-decoration: none;
        border-bottom: 1px solid transparent;
        transition: border-bottom 0.2s ease;
    }

    .blog-content-container a:hover {
        color: #2980b9;
        border-bottom: 1px solid #2980b9;
        text-decoration: none;
    }

    /* 图片样式 */
    .blog-content-container img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        margin: 1.5em 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    /* 表格样式 */
    .blog-content-container table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5em 0;
    }

    .blog-content-container th,
    .blog-content-container td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }

    .blog-content-container th {
        background: #f8f9fa;
        font-weight: 600;
    }

    /* MathJax 数学公式样式 */
    .blog-content-container .MathJax {
        font-size: 1.1em !important;
        max-width: 100%;
    }

    .blog-content-container .MathJax_Display {
        margin: 1.5em 0;
        text-align: center;
        overflow-x: auto;
        overflow-y: hidden;
    }

    /* MathJax SVG 输出样式 */
    .blog-content-container mjx-container[jax="CHTML"][display="true"] {
        margin: 1.5em 0;
        text-align: center;
        overflow-x: auto;
        overflow-y: hidden;
    }

    .blog-content-container mjx-container[jax="CHTML"] {
        font-size: 1.1em;
        max-width: 100%;
    }

    /* 深色模式下的数学公式 */
    body.dark-mode .MathJax,
    body.dark-mode mjx-container {
        color: var(--text) !important;
    }

    .blog-content-container .highlight {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        overflow-x: auto;
        margin: 1.5em 0;
        position: relative;
    }

    .blog-content-container .highlight pre {
        background: none;
        border: none;
        padding: 0;
        margin: 0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
        line-height: 1.4;
    }

    .blog-content-container .highlight code {
        background: none;
        padding: 0;
        border-radius: 0;
        font-size: inherit;
    }

    /* 行内代码样式 */
    .blog-content-container code:not(.highlight code) {
        background: #f1f3f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.9em;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        color: #d73a49;
    }

    /* 深色模式下的代码样式 */
    body.dark-mode .blog-content-container .highlight {
        background: #2d3748;
        border-color: #4a5568;
    }

    body.dark-mode .blog-content-container code:not(.highlight code) {
        background: #4a5568;
        color: #f56565;
    }

    /* 代码复制按钮样式优化 */
    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #3498db;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        font-size: 0.8rem;
        cursor: pointer;
        opacity: 0.8;
        transition: all 0.2s ease;
        font-family: system-ui, -apple-system, sans-serif;
        z-index: 10;
        user-select: none;
    }

    .copy-btn:hover {
        opacity: 1;
        background: #2980b9;
        transform: translateY(-1px);
    }
    
    .copy-btn:active {
        transform: translateY(0);
    }
    
    .copy-btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* 深色模式下的复制按钮 */
    body.dark-mode .copy-btn {
        background: #5dade2;
        color: #1e1e1e;
    }
    
    body.dark-mode .copy-btn:hover {
        background: #3498db;
    }

    .read-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        margin: 30px auto 40px;
        max-width: 700px;
        padding: 0 20px;
        flex-wrap: wrap;
    }

    /* 管理员操作区域单独一行 */
    .admin-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin: -10px auto 30px; /* 与上方控件间距更紧凑一点 */
        max-width: 900px;
        padding: 0 20px;
        flex-wrap: wrap;
    }

    .read-btn {
        background: #2c3e50;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 500;
        text-decoration: none;
        font-size: 1rem;
        transition: all 0.3s ease;
        min-width: 120px;
        text-align: center;
    }

    .read-btn:hover {
        background: #34495e;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }

    /* 点赞按钮样式 */
    .like-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: #ffffff;
        color: #e74c3c;
        border: 1px solid #f2d7d5;
        padding: 10px 16px;
        border-radius: 999px;
        box-shadow: 0 2px 10px rgba(231, 76, 60, 0.08);
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .like-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(231, 76, 60, 0.15);
        border-color: #f5b7b1;
    }

    .like-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .like-btn .bi {
        font-size: 1.1rem;
    }

    .like-count-badge {
        background: #fdecea;
        color: #c0392b;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.85rem;
        line-height: 1.2;
    }

    .like-btn.liked {
        background: linear-gradient(135deg, #ff7675, #e74c3c);
        color: #fff;
        border-color: #e74c3c;
        box-shadow: 0 6px 18px rgba(231, 76, 60, 0.25);
    }

    .like-btn.liked .like-count-badge {
        background: rgba(255, 255, 255, 0.25);
        color: #fff;
    }

    /* 深色主题下的未点赞样式 */
    body.dark-mode .like-btn:not(.liked) {
        background: #1f242b;
        color: #ffb3ae;
        border-color: #2f3640;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
    }

    body.dark-mode .like-btn:not(.liked):hover {
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
        border-color: #3a4350;
    }

    body.dark-mode .like-btn:not(.liked) .like-count-badge {
        background: #2b323c;
        color: #ffd7d4;
    }

    /* 主题切换按钮样式 */
    #toggle-theme {
        font-size: 0.9rem;
        padding: 8px 16px;
        border-radius: 20px;
        transition: all 0.3s ease;
        margin-top: 15px;
    }

    /* 阅读进度条 */
    .reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: #3498db;
        z-index: 1000;
        transition: width 0.1s ease;
    }

    @media (max-width: 768px) {
        .read-hero h1 {
            font-size: 1.8rem;
        }

        .blog-meta {
            flex-direction: column;
            gap: 10px;
        }

        .blog-content-container {
            padding: 25px 20px;
            margin: 20px auto 40px;
            font-size: 1.1rem;
            line-height: 1.8;
        }

        .read-controls {
            padding: 0 15px;
            margin: 20px auto 30px;
            gap: 12px;
        }

        .read-btn {
            padding: 10px 16px;
            font-size: 0.9rem;
            min-width: 100px;
        }

        .blog-content-container-container {
            padding: 0 10px;
        }

        .blog-content-container h1 {
            font-size: 1.5rem;
        }

        .blog-content-container h2 {
            font-size: 1.3rem;
        }

        .blog-content-container h3 {
            font-size: 1.2rem;
        }

        /* 移动端：让复制按钮不遮挡代码，放到代码块下方显示 */
        .copy-btn {
            position: static;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            top: auto;
            right: auto;
            margin-top: 8px;
            padding: 6px 10px;
            font-size: 0.85rem;
            width: auto;
        }
        /* 代码块在移动端内边距稍微增大，避免拥挤 */
        .blog-content-container .highlight {
            padding: 12px;
        }

        /* 移动端数学公式优化 */
        .blog-content-container .MathJax_Display,
        .blog-content-container mjx-container[jax="CHTML"][display="true"] {
            margin: 1em 0;
            font-size: 0.9em;
        }

        .blog-content-container .MathJax,
        .blog-content-container mjx-container[jax="CHTML"] {
            font-size: 0.9em !important;
        }
    }

    /* CSS 变量 */
    :root {
        --bg: #f3f5f7;
        --text: #2c3e50;
        --box-bg: #ffffff;
        --hero-bg: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        --btn-bg: #2c3e50;
        --btn-hover-bg: #34495e;
        --shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
        --code-bg: #f8f9fa;
        --border-color: #e9ecef;
        --link-color: #3498db;
        --link-hover-color: #2980b9;
    }

    body.dark-mode {
        --bg: #121212;
        --text: #ecf0f1;
        --box-bg: #1e1e1e;
        --hero-bg: linear-gradient(135deg, #1c1d22 0%, #212224 100%);
        --btn-bg: #3498db;
        --btn-hover-bg: #2980b9;
        --shadow: 0 2px 16px rgba(0, 0, 0, 0.3);
        --code-bg: #2d3748;
        --border-color: #4a5568;
        --link-color: #5dade2;
        --link-hover-color: #3498db;
    }

    body {
        background-color: var(--bg);
        color: var(--text);
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .read-hero {
        background: var(--hero-bg);
    }

    .read-hero h1,
    .blog-meta {
        color: var(--text);
    }

    .blog-content-container {
        background-color: var(--box-bg);
        color: var(--text);
        box-shadow: var(--shadow);
    }

    .blog-content-container h1,
    .blog-content-container h2,
    .blog-content-container h3,
    .blog-content-container h4,
    .blog-content-container h5,
    .blog-content-container h6 {
        color: var(--text);
    }

    .blog-content-container pre,
    .blog-content-container code,
    .blog-content-container blockquote,
    .blog-content-container th {
        background: var(--code-bg);
    }

    .blog-content-container th,
    .blog-content-container td {
        border-color: var(--border-color);
    }

    .blog-content-container a {
        color: var(--link-color);
    }

    .blog-content-container a:hover {
        color: var(--link-hover-color);
        border-bottom-color: var(--link-hover-color);
    }

    .read-btn {
        background: var(--btn-bg);
    }

    .read-btn:hover {
        background: var(--btn-hover-bg);
    }
</style>
{% endblock %}

{% block content %}
<!-- 阅读进度条 -->
<div class="reading-progress"></div>

<section class="read-hero">
    <h1>{{ blog.title }}</h1>
    <div class="blog-meta">
        <span class="blog-author">
            <img src="/auth/avatar/{{ blog.author_id }}"
                style="width:24px; height:24px; border-radius:10%; margin-right:8px;">
            {{ blog.author }}</span>
        <span class="blog-date">{{ blog.date }}</span>
    </div>
    <button id="toggle-theme" class="btn btn-outline-secondary">切换深色模式</button>
</section>

<div class="blog-content-container-container">
    <div class="blog-content-container" id="userContentContainer">
        <!-- Markdown 内容将在前端渲染 -->
        <div id="loading-indicator" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">正在加载内容...</p>
        </div>
    </div>
    <!-- 原始 Markdown 数据 -->
    <script type="application/json" id="markdownContent">{{ blog.content | tojson }}</script>
</div>

<div class="read-controls">
    <button
        id="like-btn"
        class="like-btn {{ 'liked' if blog.liked else '' }}"
        data-auth="{{ 1 if current_user.is_authenticated else 0 }}"
        data-login-url="{{ url_for('auth.login') }}"
        data-like-url="{{ url_for('blog.like_toggle', blog_id=blog.id) }}"
        aria-label="点赞"
    >
        <i id="like-icon" class="bi {{ 'bi-heart-fill' if blog.liked else 'bi-heart' }}"></i>
        <span id="like-text">{{ '已点赞' if blog.liked else '点赞' }}</span>
        <span class="like-count-badge" id="like-count">{{ blog.likes_count or 0 }}</span>
    </button>

    <a href="{{ url_for('blog.menu') }}" class="read-btn">📝 返回博客列表</a>
</div>
{% if current_user.is_authenticated and (current_user.is_admin or current_user.id == blog.author_id) %}
<div class="admin-controls">
    {% if current_user.is_admin %}
    <button id="admin-likers-btn" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#likersModal" data-likers-url="{{ url_for('blog.likers', blog_id=blog.id) }}">
        👍 查看点赞者
    </button>
    <button id="admin-delete-btn" class="btn btn-outline-danger" data-delete-url="{{ url_for('blog.delete_blog', blog_id=blog.id) }}" data-redirect-url="{{ url_for('blog.menu') }}">
        🗑️ 删除文章
    </button>
    {% endif %}
    <a href="{{ url_for('blog.edit_blog', blog_id=blog.id) }}" class="btn btn-outline-primary">✏️ 编辑文章</a>
    
</div>
{% endif %}
{% if current_user.is_authenticated and current_user.is_admin %}
<!-- 点赞者列表 Modal -->
<div class="modal fade" id="likersModal" tabindex="-1" aria-labelledby="likersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="likersModalLabel">点赞者列表</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="likers-list" class="list-group" style="max-height: 50vh; overflow: auto;"></div>
        <div class="d-flex justify-content-between align-items-center mt-3">
            <button id="likers-prev" class="btn btn-sm btn-outline-secondary">上一页</button>
            <small id="likers-pageinfo" class="text-muted"></small>
            <button id="likers-next" class="btn btn-sm btn-outline-secondary">下一页</button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
      </div>
    </div>
  </div>
</div>

<!-- 删除确认 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmLabel">确认删除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        确定要删除这篇文章《{{ blog.title }}》吗？该操作不可恢复。
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" id="confirm-delete-btn" class="btn btn-danger">确认删除</button>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block copyright %}
作者：{{ blog.author }} | 版权归原作者所有  

{% endblock %}

{% block extra_js %}
<script>
    // 前端 Markdown 渲染功能
    function initMarkdownRenderer() {
        // 检查依赖是否加载完成
        if (typeof marked === 'undefined') {
            console.error('marked.js 未加载');
            return false;
        }
        if (typeof hljs === 'undefined') {
            console.error('highlight.js 未加载');
            return false;
        }
        if (typeof DOMPurify === 'undefined') {
            console.error('DOMPurify 未加载');
            return false;
        }
        if (typeof MathJax === 'undefined') {
            console.error('MathJax 未加载');
            return false;
        }

        // 配置 marked
        marked.setOptions({
            highlight: function(code, lang) {
                try {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                } catch (err) {
                    console.warn('代码高亮失败:', err);
                    return code; // 返回原始代码
                }
            },
            breaks: true,
            gfm: true,
            tables: true,
            xhtml: false
        });

        // 配置自定义渲染器
        const renderer = new marked.Renderer();
        
        // 自定义链接渲染
        renderer.link = function(href, title, text) {
            const link = marked.Renderer.prototype.link.call(this, href, title, text);
            return link.replace('<a', '<a rel="noopener noreferrer nofollow" target="_blank"');
        };

        // 自定义代码块渲染
        renderer.code = function(code, lang) {
            try {
                const highlighted = lang && hljs.getLanguage(lang) 
                    ? hljs.highlight(code, { language: lang }).value 
                    : hljs.highlightAuto(code).value;
                
                return `<div class="highlight">
                    <pre><code class="hljs">${highlighted}</code></pre>
                    <button class="copy-btn" data-code="${encodeURIComponent(code)}">📋 复制</button>
                </div>`;
            } catch (err) {
                console.warn('代码高亮失败:', err);
                return `<div class="highlight">
                    <pre><code>${code}</code></pre>
                    <button class="copy-btn" data-code="${encodeURIComponent(code)}">📋 复制</button>
                </div>`;
            }
        };

        // 自定义列表项渲染（支持任务列表）
        renderer.listitem = function(text) {
            // 检查是否是任务列表项
            if (/^\s*\[[ x]\]\s/.test(text)) {
                const checked = /^\s*\[x\]\s/.test(text);
                const cleanText = text.replace(/^\s*\[[ x]\]\s/, '');
                return `<li class="task-list-item"><input type="checkbox" ${checked ? 'checked' : ''} disabled> ${cleanText}</li>`;
            }
            return `<li>${text}</li>`;
        };

        marked.use({ renderer });
        
        return true;
    }

    // 安全渲染 Markdown 内容
    function renderUserContent() {
        const container = document.getElementById('userContentContainer');
        const markdownScript = document.getElementById('markdownContent');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        if (!markdownScript) {
            console.error('未找到 Markdown 内容');
            if (loadingIndicator) {
                loadingIndicator.innerHTML = '<div class="alert alert-danger">内容数据缺失</div>';
            }
            return;
        }

        try {
            let markdownText = JSON.parse(markdownScript.textContent);
            
            // 移除加载指示器
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
            
            // 检查必要的库是否可用
            if (typeof marked === 'undefined' || typeof DOMPurify === 'undefined') {
                // 备用方案：显示原始 Markdown
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <h5>⚠️ Markdown 渲染库未加载</h5>
                        <p>正在显示原始 Markdown 内容。这可能是由于网络问题导致的。</p>
                        <button class="btn btn-primary btn-sm mt-2" onclick="location.reload()">刷新页面重试</button>
                    </div>
                    <pre style="white-space: pre-wrap; font-family: inherit; background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px;">${markdownText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                `;
                console.warn('Markdown 库未加载，显示原始内容');
                return;
            }
            
            // 保护数学公式不被 Markdown 破坏
            const mathPlaceholders = {};
            let placeholderCounter = 0;
            
            // 保护块级数学公式 $$...$$
            markdownText = markdownText.replace(/\$\$([\s\S]*?)\$\$/g, (match) => {
                const placeholder = `MATHBLOCK${placeholderCounter++}PLACEHOLDER`;
                mathPlaceholders[placeholder] = match;
                return placeholder;
            });
            
            // 保护行内数学公式 $...$
            markdownText = markdownText.replace(/\$([^$\n]+?)\$/g, (match) => {
                const placeholder = `MATHINLINE${placeholderCounter++}PLACEHOLDER`;
                mathPlaceholders[placeholder] = match;
                return placeholder;
            });
            
            // 保护 LaTeX 风格公式 \[...\] 和 \(...\)
            markdownText = markdownText.replace(/\\\[([\s\S]*?)\\\]/g, (match) => {
                const placeholder = `MATHLATEX${placeholderCounter++}PLACEHOLDER`;
                mathPlaceholders[placeholder] = match;
                return placeholder;
            });
            
            markdownText = markdownText.replace(/\\\(([\s\S]*?)\\\)/g, (match) => {
                const placeholder = `MATHLATEX${placeholderCounter++}PLACEHOLDER`;
                mathPlaceholders[placeholder] = match;
                return placeholder;
            });
            
            // 渲染 Markdown 为 HTML
            let html = marked.parse(markdownText);
            
            // 恢复数学公式
            Object.keys(mathPlaceholders).forEach(placeholder => {
                html = html.replace(new RegExp(placeholder, 'g'), mathPlaceholders[placeholder]);
            });
            
            // 使用 DOMPurify 清理 HTML，防止 XSS - 保留数学公式标记
            html = DOMPurify.sanitize(html, {
                ALLOWED_TAGS: [
                    'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                    'p', 'br', 'hr', 'div', 'span',
                    'strong', 'b', 'em', 'i', 'u', 's', 'del',
                    'code', 'pre', 'blockquote',
                    'ul', 'ol', 'li',
                    'a', 'img',
                    'table', 'thead', 'tbody', 'tr', 'th', 'td',
                    'details', 'summary',
                    'sub', 'sup', 'mark',
                    'input', 'button'  // 允许 input 标签用于任务列表和button用于复制功能
                ],
                ALLOWED_ATTR: [
                    'href', 'title', 'alt', 'src', 'class', 'rel', 'target',
                    'width', 'height', 'align', 'colspan', 'rowspan',
                    'type', 'checked', 'disabled', 'data-code'  // 允许任务列表的属性和复制按钮属性
                ],
                ALLOW_DATA_ATTR: false
            });
            
            container.innerHTML = html;
            
            // 安全处理链接
            hardenLinks();
            
            // 添加代码复制功能
            addCopyButtons();
            
            // 添加图片点击放大功能
            addImageZoom();
            
            // 延迟渲染数学公式，确保 DOM 完全准备好
            if (typeof MathJax !== 'undefined') {
                setTimeout(() => {
                    // 直接检查 DOM 中是否有数学公式
                    const hasBlockMath = container.innerHTML.includes('$$') || container.innerHTML.includes('\\[') || container.innerHTML.includes('\\]');
                    const hasInlineMath = /\$[^$\n]+\$/.test(container.innerHTML) || container.innerHTML.includes('\\(') || container.innerHTML.includes('\\)');
                    
                    console.log('数学公式检测:', {
                        hasBlockMath,
                        hasInlineMath,
                        htmlSample: container.innerHTML.substring(0, 200) + '...'
                    });
                    
                    if (hasBlockMath || hasInlineMath) {
                        console.log('检测到数学公式，开始渲染...');
                        renderMath();
                    } else {
                        console.log('未检测到数学公式');
                    }
                }, 300);
            } else {
                console.warn('MathJax 未加载，跳过数学公式渲染');
            }
            
        } catch (error) {
            console.error('Markdown 渲染失败:', error);
            // 尝试显示原始内容作为备用
            try {
                const markdownText = JSON.parse(markdownScript.textContent);
                container.innerHTML = `<div class="alert alert-warning">
                    <h5>内容渲染失败</h5>
                    <p>正在显示原始内容：</p>
                    <pre style="white-space: pre-wrap; font-family: inherit; background: #f8f9fa; padding: 15px; border-radius: 6px;">${markdownText}</pre>
                </div>`;
            } catch (e) {
                container.innerHTML = '<div class="alert alert-danger">内容加载失败，请刷新页面重试。</div>';
            }
        }
    }

    // 渲染数学公式
    function renderMath() {
        try {
            console.log('开始渲染数学公式...');
            const container = document.getElementById('userContentContainer');
            if (!container) {
                console.warn('未找到内容容器');
                return;
            }
            
            // 使用 MathJax 重新渲染数学公式
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise([container]).then(() => {
                    console.log('数学公式渲染完成');
                }).catch((error) => {
                    console.error('MathJax 渲染失败:', error);
                });
            } else if (window.MathJax && window.MathJax.Hub) {
                // 针对 MathJax v2 的降级支持
                window.MathJax.Hub.Queue(["Typeset", window.MathJax.Hub, container]);
                console.log('数学公式渲染完成 (MathJax v2)');
            } else {
                console.warn('MathJax 未正确加载或配置');
            }
        } catch (error) {
            console.error('数学公式渲染失败:', error);
        }
    }

    // 添加代码复制功能
    function addCopyButtons() {
        const copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(button => {
            button.addEventListener('click', function() {
                copyCode(this);
            });
        });
    }
    
    // 复制代码功能
    function copyCode(button) {
        console.log('复制代码按钮被点击');
        try {
            let codeText = '';
            
            // 尝试从 data-code 属性获取代码
            const encodedCode = button.getAttribute('data-code');
            if (encodedCode) {
                codeText = decodeURIComponent(encodedCode);
            } else {
                // 降级方案：从相邻的 code 元素获取
                const codeBlock = button.parentElement.querySelector('code');
                if (!codeBlock) {
                    console.error('未找到代码块');
                    return;
                }
                codeText = codeBlock.textContent || codeBlock.innerText;
            }
            
            console.log('准备复制的代码长度:', codeText.length);
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                // 现代浏览器
                navigator.clipboard.writeText(codeText).then(() => {
                    console.log('代码复制成功');
                    showCopySuccess(button);
                }).catch((err) => {
                    console.warn('Clipboard API 失败，使用降级方案:', err);
                    fallbackCopy(codeText, button);
                });
            } else {
                // 降级方案
                console.log('使用降级复制方案');
                fallbackCopy(codeText, button);
            }
        } catch (error) {
            console.error('复制代码时出错:', error);
        }
    }
    
    // 显示复制成功状态
    function showCopySuccess(button) {
        const originalText = button.innerHTML;
        const originalBg = button.style.background;
        
        button.innerHTML = '✅ 已复制';
        button.style.background = '#27ae60';
        button.disabled = true;
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.style.background = originalBg || '#3498db';
            button.disabled = false;
        }, 2000);
    }
    
    // 降级复制方案
    function fallbackCopy(text, button) {
        try {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);
            
            if (successful) {
                console.log('降级复制成功');
                showCopySuccess(button);
            } else {
                console.error('降级复制失败');
                alert('复制失败，请手动选择代码');
            }
        } catch (err) {
            console.error('降级复制出错:', err);
            alert('复制功能不可用，请手动选择代码');
        }
    }

    // 对内容区域中的链接进行安全加固
    function hardenLinks() {
        const anchors = document.querySelectorAll('.blog-content-container a[href]');
        anchors.forEach(a => {
            const href = a.getAttribute('href') || '';
            try {
                const url = new URL(href, window.location.origin);
                const protocol = url.protocol.toLowerCase();
                const isHttp = protocol === 'http:' || protocol === 'https:';
                const isAllowed = isHttp || protocol === 'mailto:' || protocol === 'tel:';
                
                if (!isAllowed) {
                    a.removeAttribute('href');
                    return;
                }
                
                if (isHttp && url.origin !== window.location.origin) {
                    a.setAttribute('rel', 'noopener noreferrer nofollow');
                    a.setAttribute('target', '_blank');
                }
            } catch (e) {
                // 非法URL，移除href
                a.removeAttribute('href');
            }
        });
    }
    // 主题切换功能
    const toggleBtn = document.getElementById('toggle-theme');
    const isDark = localStorage.getItem('theme') === 'dark';

    if (isDark) {
        document.body.classList.add('dark-mode');
        toggleBtn.innerText = '切换亮色模式';
    }
    updateHighlightTheme(isDark);

    toggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        const nowDark = document.body.classList.contains('dark-mode');
        localStorage.setItem('theme', nowDark ? 'dark' : 'light');
        toggleBtn.innerText = nowDark ? '切换亮色模式' : '切换深色模式';
        updateHighlightTheme(nowDark);
    });

    // 阅读进度条
    function updateReadingProgress() {
        const article = document.querySelector('.blog-content-container');
        const scrollTop = window.pageYOffset;
        const docHeight = document.body.scrollHeight - window.innerHeight;
        const scrollPercent = Math.min((scrollTop / docHeight) * 100, 100);

        let progressBar = document.querySelector('.reading-progress');
        if (!progressBar) {
            progressBar = document.createElement('div');
            progressBar.className = 'reading-progress';
            document.body.appendChild(progressBar);
        }

        progressBar.style.width = scrollPercent + '%';
    }



    // 图片点击放大功能
    function addImageZoom() {
        const images = document.querySelectorAll('.blog-content-container img');
        images.forEach(img => {
            img.style.cursor = 'pointer';
            img.addEventListener('click', () => {
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                    cursor: pointer;
                `;

                const zoomedImg = img.cloneNode();
                zoomedImg.style.cssText = `
                    max-width: 90%;
                    max-height: 90%;
                    object-fit: contain;
                `;

                overlay.appendChild(zoomedImg);
                document.body.appendChild(overlay);

                overlay.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                });
            });
        });
    }



    // 滚动事件监听
    window.addEventListener('scroll', updateReadingProgress);



    // 等待所有依赖加载完成
    function waitForDependencies(callback, maxAttempts = 100) {
        let attempts = 0;
        
        function check() {
            attempts++;
            
            // 详细检查每个依赖
            const dependencies = {
                'marked': typeof marked !== 'undefined',
                'hljs': typeof hljs !== 'undefined', 
                'DOMPurify': typeof DOMPurify !== 'undefined',
                'MathJax': typeof MathJax !== 'undefined'
            };
            
            console.log(`依赖检查 (${attempts}/${maxAttempts}):`, dependencies);
            
            if (dependencies.marked && dependencies.hljs && dependencies.DOMPurify && dependencies.MathJax) {
                console.log('✅ 所有依赖已加载完成');
                callback();
                return;
            }
            
            if (attempts >= maxAttempts) {
                console.error('❌ 依赖加载超时，缺失的依赖:', 
                    Object.keys(dependencies).filter(key => !dependencies[key]));
                callback(); // 仍然尝试初始化
                return;
            }
            
            setTimeout(check, 200); // 200ms 后重试
        }
        
        check();
    }

    // 页面加载时自动适配系统主题和初始化
    document.addEventListener('DOMContentLoaded', () => {
        waitForDependencies(() => {
            // 初始化 Markdown 渲染器
            if (initMarkdownRenderer()) {
                // 渲染内容
                renderUserContent();
            } else {
                console.error('Markdown 渲染器初始化失败');
                document.getElementById('userContentContainer').innerHTML = 
                    '<p class="text-danger">内容加载失败，请刷新页面重试。</p>';
            }
        });
        
        // 主题设置
        let isDark = localStorage.getItem('theme') === 'dark';
        if (!localStorage.getItem('theme')) {
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.body.classList.add('dark-mode');
                document.getElementById('toggle-theme').innerText = '切换亮色模式';
                isDark = true;
            }
        }
        updateHighlightTheme(document.body.classList.contains('dark-mode'));
        updateReadingProgress();
        addImageZoom();

        // 平滑滚动到内容区域（如果有锚点）
        if (window.location.hash) {
            const target = document.querySelector(window.location.hash);
            if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
            }
        }
    });

    function updateHighlightTheme(isDark) {
        document.getElementById('hljs-light').disabled = isDark;
        document.getElementById('hljs-dark').disabled = !isDark;
    }

    // 点赞功能
    (function () {
        const likeBtn = document.getElementById('like-btn');
        if (!likeBtn) return;
        const IS_AUTHENTICATED = likeBtn.dataset.auth === '1';
        const LOGIN_URL = likeBtn.dataset.loginUrl;
        const LIKE_URL = likeBtn.dataset.likeUrl;
        const likeIcon = document.getElementById('like-icon');
        const likeText = document.getElementById('like-text');
        const likeCount = document.getElementById('like-count');

        likeBtn.addEventListener('click', async () => {
            if (!IS_AUTHENTICATED) {
                if (typeof showToast === 'function') {
                    showToast('请先登录后再点赞', 'info');
                }
                window.location.href = LOGIN_URL;
                return;
            }
            likeBtn.disabled = true;
            try {
                const res = await fetch(LIKE_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                const data = await res.json();
                if (data.code === 200) {
                    const liked = !!data.liked;
                    likeCount.textContent = data.likes_count;
                    likeIcon.className = 'bi ' + (liked ? 'bi-heart-fill' : 'bi-heart');
                    likeText.textContent = liked ? '已点赞' : '点赞';
                    likeBtn.classList.toggle('liked', liked);
                    if (typeof showToast === 'function') {
                        showToast(liked ? '已点赞' : '已取消点赞', liked ? 'success' : 'info');
                    }
                } else {
                    if (typeof showToast === 'function') showToast(data.message || '操作失败', 'error');
                }
            } catch (e) {
                if (typeof showToast === 'function') showToast('网络错误，请稍后重试', 'error');
            } finally {
                likeBtn.disabled = false;
            }
        });
    })();

    // 管理员：点赞者列表
    (function () {
        const btn = document.getElementById('admin-likers-btn');
        if (!btn) return;
        const listEl = document.getElementById('likers-list');
        const pageInfo = document.getElementById('likers-pageinfo');
        const prevBtn = document.getElementById('likers-prev');
        const nextBtn = document.getElementById('likers-next');
        const LIKERS_URL = btn.dataset.likersUrl;
        let offset = 0;
        const limit = 20;

        async function loadLikers() {
            listEl.innerHTML = '<div class="text-muted">加载中...</div>';
            try {
                const res = await fetch(`${LIKERS_URL}?offset=${offset}&limit=${limit}`);
                const data = await res.json();
                if (data.code !== 200) throw new Error(data.message || '加载失败');
                const { users = [], total = 0 } = data;
                listEl.innerHTML = '';
                if (users.length === 0) {
                    listEl.innerHTML = '<div class="text-muted">暂无点赞者</div>';
                } else {
                    for (const u of users) {
                        const item = document.createElement('a');
                        item.className = 'list-group-item list-group-item-action d-flex align-items-center';
                        item.innerHTML = `
                            <img src="${u.avatar_url}" style="width:28px;height:28px;border-radius:6%;margin-right:10px;" />
                            <div class="d-flex flex-column">
                                <strong>${u.username || u.id}</strong>
                                <small class="text-muted">${u.liked_at || ''}</small>
                            </div>
                        `;
                        listEl.appendChild(item);
                    }
                }
                const cur = Math.floor(offset / limit) + 1;
                const pages = Math.max(1, Math.ceil(total / limit));
                pageInfo.textContent = `${cur} / ${pages} 页（共 ${total} 人）`;
                prevBtn.disabled = offset <= 0;
                nextBtn.disabled = offset + limit >= total;
            } catch (e) {
                listEl.innerHTML = '<div class="text-danger">加载失败，请重试</div>';
            }
        }

        document.getElementById('likersModal').addEventListener('shown.bs.modal', loadLikers);
        prevBtn.addEventListener('click', () => { offset = Math.max(0, offset - limit); loadLikers(); });
        nextBtn.addEventListener('click', () => { offset += limit; loadLikers(); });
    })();

    // 管理员：删除文章
    (function () {
        const delBtn = document.getElementById('admin-delete-btn');
        if (!delBtn) return;
        const confirmBtn = document.getElementById('confirm-delete-btn');
        const DELETE_URL = delBtn.dataset.deleteUrl;
        const REDIRECT_URL = delBtn.dataset.redirectUrl;

        delBtn.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            modal.show();
        });

        confirmBtn.addEventListener('click', async () => {
            confirmBtn.disabled = true;
            try {
                const res = await fetch(DELETE_URL, { method: 'DELETE' });
                const data = await res.json();
                if (data.code === 200) {
                    if (typeof showToast === 'function') showToast('文章已删除', 'success');
                    window.location.href = REDIRECT_URL;
                } else {
                    if (typeof showToast === 'function') showToast(data.message || '删除失败', 'error');
                }
            } catch (e) {
                if (typeof showToast === 'function') showToast('网络错误，请稍后重试', 'error');
            } finally {
                confirmBtn.disabled = false;
            }
        });
    })();
</script>
{% endblock %}

{% block footer_text %}
{% endblock %}