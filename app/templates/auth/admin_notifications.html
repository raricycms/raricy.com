{% extends "base.html" %}
{% block title %}
Raricy.com - ç®¡ç†å‘˜é€šçŸ¥å‘é€
{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        background-attachment: fixed;
        min-height: 100vh;
    }
    .notification-card {
        margin-top: 30px;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.15);
        padding: 40px;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        transition: transform 0.3s ease;
    }
    .notification-card:hover {
        transform: translateY(-5px);
    }
    .template-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    .template-card:hover {
        border-color: #007bff;
        transform: translateY(-2px);
    }
    .template-card.selected {
        border-color: #007bff;
        background-color: #e7f3ff;
    }
    .user-select-card {
        max-height: 400px;
        overflow-y: auto;
    }
    .user-item {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .user-item:hover {
        background-color: #f8f9fa;
    }
    .user-item.selected {
        background-color: #e7f3ff;
        border-left: 4px solid #007bff;
    }
    .send-options {
        background: rgba(248, 249, 250, 0.8);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="notification-card">
        <h1 class="text-center mb-4">ğŸ“¢ ç®¡ç†å‘˜é€šçŸ¥å‘é€ä¸­å¿ƒ</h1>
        
        <!-- å‘é€é€‰é¡¹é€‰æ‹© -->
        <div class="send-options">
            <h4 class="mb-3">é€‰æ‹©å‘é€æ–¹å¼</h4>
            <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="sendMode" id="sendToUser" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="sendToUser">å‘é€ç»™æŒ‡å®šç”¨æˆ·</label>
                
                <input type="radio" class="btn-check" name="sendMode" id="sendToAll" autocomplete="off">
                <label class="btn btn-outline-success" for="sendToAll">ç¾¤å‘é€šçŸ¥</label>
            </div>
        </div>

        <!-- å‘é€ç»™æŒ‡å®šç”¨æˆ·çš„è¡¨å• -->
        <div id="sendToUserForm">
            <div class="row">
                <div class="col-md-4">
                    <h5>é€‰æ‹©ç”¨æˆ·</h5>
                    <div class="user-select-card card">
                        <div class="card-body p-2">
                            <div class="mb-2">
                                <input type="text" class="form-control form-control-sm" id="userSearch" placeholder="æœç´¢ç”¨æˆ·...">
                            </div>
                            <div id="userList">
                                {% for user in user_list %}
                                <div class="user-item p-2 rounded mb-1" data-user-id="{{ user.id }}" data-username="{{ user.username }}">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ user.username }}</strong>
                                            <br><small class="text-muted">{{ user.email }}</small>
                                        </div>
                                        <div>
                                            {% if user.is_admin %}
                                                <span class="badge badge-danger">ç®¡ç†å‘˜</span>
                                            {% elif user.authenticated %}
                                                <span class="badge badge-success">è®¤è¯ç”¨æˆ·</span>
                                            {% else %}
                                                <span class="badge badge-secondary">æ™®é€šç”¨æˆ·</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <h5>ç¼–å†™é€šçŸ¥</h5>
                    <form id="notificationForm">
                        <div class="form-group">
                            <label for="selectedUser">æ¥æ”¶ç”¨æˆ·</label>
                            <input type="text" class="form-control" id="selectedUser" readonly placeholder="è¯·å…ˆé€‰æ‹©ç”¨æˆ·">
                            <input type="hidden" id="selectedUserId">
                        </div>
                        
                        <div class="form-group">
                            <label for="notificationAction">é€šçŸ¥ç±»å‹</label>
                            <select class="form-control" id="notificationAction" required>
                                <option value="">è¯·é€‰æ‹©é€šçŸ¥ç±»å‹</option>
                                {% for template in templates %}
                                <option value="{{ template.action }}" data-placeholder="{{ template.placeholder }}">
                                    {{ template.action }} - {{ template.description }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="notificationDetail">é€šçŸ¥å†…å®¹</label>
                            <textarea class="form-control" id="notificationDetail" rows="5" required placeholder="è¯·è¾“å…¥é€šçŸ¥å†…å®¹..."></textarea>
                            <small class="form-text text-muted">è¯·è¯¦ç»†æè¿°é€šçŸ¥å†…å®¹ï¼Œç¡®ä¿ç”¨æˆ·èƒ½å¤Ÿç†è§£ã€‚</small>
                        </div>
                        
                        <div class="form-row">
                            <div class="col-md-6">
                                <label for="objectType">å…³è”å¯¹è±¡ç±»å‹ï¼ˆå¯é€‰ï¼‰</label>
                                <select class="form-control" id="objectType">
                                    <option value="">æ— å…³è”å¯¹è±¡</option>
                                    <option value="blog">åšå®¢æ–‡ç« </option>
                                    <option value="user">ç”¨æˆ·</option>
                                    <option value="system">ç³»ç»Ÿ</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="objectId">å…³è”å¯¹è±¡IDï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" class="form-control" id="objectId" placeholder="å¦‚ï¼šåšå®¢IDã€ç”¨æˆ·IDç­‰">
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-paper-plane"></i> å‘é€é€šçŸ¥
                            </button>
                            <button type="button" class="btn btn-secondary btn-lg ml-2" onclick="clearForm()">
                                <i class="fas fa-times"></i> æ¸…ç©º
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ç¾¤å‘é€šçŸ¥çš„è¡¨å• -->
        <div id="sendToAllForm" style="display: none;">
            <form id="broadcastForm">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label for="targetGroup">ç›®æ ‡ç”¨æˆ·ç¾¤</label>
                            <select class="form-control" id="targetGroup" required>
                                <option value="all">æ‰€æœ‰ç”¨æˆ·</option>
                                <option value="authenticated">è®¤è¯ç”¨æˆ·</option>
                                <option value="normal">æ™®é€šç”¨æˆ·</option>
                            </select>
                            <small class="form-text text-muted">é€‰æ‹©è¦æ¥æ”¶é€šçŸ¥çš„ç”¨æˆ·ç¾¤ä½“</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="broadcastAction">é€šçŸ¥ç±»å‹</label>
                            <select class="form-control" id="broadcastAction" required>
                                <option value="">è¯·é€‰æ‹©é€šçŸ¥ç±»å‹</option>
                                {% for template in templates %}
                                <option value="{{ template.action }}" data-placeholder="{{ template.placeholder }}">
                                    {{ template.action }} - {{ template.description }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="form-row">
                            <div class="col-md-6">
                                <label for="broadcastObjectType">å…³è”å¯¹è±¡ç±»å‹ï¼ˆå¯é€‰ï¼‰</label>
                                <select class="form-control" id="broadcastObjectType">
                                    <option value="">æ— å…³è”å¯¹è±¡</option>
                                    <option value="blog">åšå®¢æ–‡ç« </option>
                                    <option value="user">ç”¨æˆ·</option>
                                    <option value="system">ç³»ç»Ÿ</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="broadcastObjectId">å…³è”å¯¹è±¡IDï¼ˆå¯é€‰ï¼‰</label>
                                <input type="text" class="form-control" id="broadcastObjectId" placeholder="å¦‚ï¼šåšå®¢IDç­‰">
                            </div>
                        </div>
                        
                        <!-- é¢„è§ˆç”¨æˆ·æ•°é‡ -->
                        <div class="mt-3 p-3 bg-light rounded">
                            <h6>é¢„è§ˆä¿¡æ¯</h6>
                            <p class="mb-1">ç›®æ ‡ç”¨æˆ·æ•°é‡: <span id="targetUserCount" class="font-weight-bold text-primary">è®¡ç®—ä¸­...</span></p>
                            <small class="text-muted">è¯·ç¡®è®¤å‘é€èŒƒå›´åå†æäº¤</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="broadcastDetail">é€šçŸ¥å†…å®¹</label>
                    <textarea class="form-control" id="broadcastDetail" rows="5" required placeholder="è¯·è¾“å…¥ç¾¤å‘é€šçŸ¥å†…å®¹..."></textarea>
                    <small class="form-text text-muted">ç¾¤å‘é€šçŸ¥ä¼šå‘é€ç»™æ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„ç”¨æˆ·ï¼Œè¯·è°¨æ…ç¼–å†™å†…å®¹ã€‚</small>
                </div>
                
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-bullhorn"></i> ç¾¤å‘é€šçŸ¥
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg ml-2" onclick="clearBroadcastForm()">
                        <i class="fas fa-times"></i> æ¸…ç©º
                    </button>
                </div>
            </form>
        </div>
        
        <!-- è¿”å›ç”¨æˆ·ç®¡ç† -->
        <div class="text-center mt-4">
            <a href="{{ url_for('auth.user_management') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> è¿”å›ç”¨æˆ·ç®¡ç†
            </a>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let selectedUserId = null;
let userList = [];

// ä»DOMä¸­è·å–ç”¨æˆ·æ•°æ®ï¼Œè¿™æ ·æ›´å®‰å…¨ä¸”IDEå‹å¥½
$(document).ready(function() {
    // ä»DOMå…ƒç´ ä¸­æ”¶é›†ç”¨æˆ·æ•°æ®
    $('.user-item').each(function() {
        const userId = $(this).data('user-id');
        const username = $(this).data('username');
        const email = $(this).find('small').text();
        const isAdmin = $(this).find('.badge-danger').length > 0;
        const isAuthenticated = $(this).find('.badge-success').length > 0;
        
        userList.push({
            id: userId,
            username: username,
            email: email,
            is_admin: isAdmin,
            authenticated: isAuthenticated
        });
    });
    
    // å‘é€æ–¹å¼åˆ‡æ¢
    $('input[name="sendMode"]').change(function() {
        if ($(this).attr('id') === 'sendToUser') {
            $('#sendToUserForm').show();
            $('#sendToAllForm').hide();
        } else {
            $('#sendToUserForm').hide();
            $('#sendToAllForm').show();
            updateTargetUserCount();
        }
    });
    
    // ç”¨æˆ·é€‰æ‹©
    $('.user-item').click(function() {
        $('.user-item').removeClass('selected');
        $(this).addClass('selected');
        
        selectedUserId = $(this).data('user-id');
        const username = $(this).data('username');
        
        $('#selectedUserId').val(selectedUserId);
        $('#selectedUser').val(username);
    });
    
    // ç”¨æˆ·æœç´¢
    $('#userSearch').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('.user-item').each(function() {
            const username = $(this).data('username').toLowerCase();
            const email = $(this).find('small').text().toLowerCase();
            
            if (username.includes(searchTerm) || email.includes(searchTerm)) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });
    
    // é€šçŸ¥ç±»å‹é€‰æ‹©æ—¶æ›´æ–°placeholder
    $('#notificationAction, #broadcastAction').change(function() {
        const selectedOption = $(this).find('option:selected');
        const placeholder = selectedOption.data('placeholder') || 'è¯·è¾“å…¥é€šçŸ¥å†…å®¹...';
        
        if ($(this).attr('id') === 'notificationAction') {
            $('#notificationDetail').attr('placeholder', placeholder);
        } else {
            $('#broadcastDetail').attr('placeholder', placeholder);
        }
    });
    
    // ç›®æ ‡ç”¨æˆ·ç¾¤å˜åŒ–æ—¶æ›´æ–°ç”¨æˆ·æ•°é‡
    $('#targetGroup').change(function() {
        updateTargetUserCount();
    });
    
    // è¡¨å•æäº¤
    $('#notificationForm').submit(function(e) {
        e.preventDefault();
        sendNotificationToUser();
    });
    
    $('#broadcastForm').submit(function(e) {
        e.preventDefault();
        sendNotificationToAll();
    });
    
    // åˆå§‹åŒ–ç›®æ ‡ç”¨æˆ·æ•°é‡
    updateTargetUserCount();
});

// å‘é€é€šçŸ¥ç»™æŒ‡å®šç”¨æˆ·
function sendNotificationToUser() {
    if (!selectedUserId) {
        alert('è¯·å…ˆé€‰æ‹©è¦æ¥æ”¶é€šçŸ¥çš„ç”¨æˆ·');
        return;
    }
    
    const data = {
        recipient_id: selectedUserId,
        action: $('#notificationAction').val(),
        detail: $('#notificationDetail').val(),
        object_type: $('#objectType').val() || null,
        object_id: $('#objectId').val() || null
    };
    
    if (!data.action || !data.detail) {
        alert('è¯·å¡«å†™å®Œæ•´çš„é€šçŸ¥ä¿¡æ¯');
        return;
    }
    
    // ç¡®è®¤å‘é€
    if (!confirm(`ç¡®å®šè¦å‘ç”¨æˆ· "${$('#selectedUser').val()}" å‘é€é€šçŸ¥å—ï¼Ÿ`)) {
        return;
    }
    
    fetch('{{ url_for("auth.send_notification_to_user") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('é€šçŸ¥å‘é€æˆåŠŸï¼');
            clearForm();
        } else {
            alert('å‘é€å¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    });
}

// ç¾¤å‘é€šçŸ¥
function sendNotificationToAll() {
    const data = {
        target_group: $('#targetGroup').val(),
        action: $('#broadcastAction').val(),
        detail: $('#broadcastDetail').val(),
        object_type: $('#broadcastObjectType').val() || null,
        object_id: $('#broadcastObjectId').val() || null
    };
    
    if (!data.action || !data.detail) {
        alert('è¯·å¡«å†™å®Œæ•´çš„é€šçŸ¥ä¿¡æ¯');
        return;
    }
    
    // ç¡®è®¤ç¾¤å‘
    const targetCount = $('#targetUserCount').text();
    if (!confirm(`ç¡®å®šè¦å‘ ${targetCount} ä¸ªç”¨æˆ·ç¾¤å‘é€šçŸ¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
        return;
    }
    
    // æ˜¾ç¤ºå‘é€è¿›åº¦
    const submitBtn = $('#broadcastForm button[type="submit"]');
    const originalText = submitBtn.html();
    submitBtn.html('<i class="fas fa-spinner fa-spin"></i> å‘é€ä¸­...').prop('disabled', true);
    
    fetch('{{ url_for("auth.send_notification_to_all") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`ç¾¤å‘æˆåŠŸï¼å…±å‘é€äº† ${data.sent_count} ä¸ªé€šçŸ¥`);
            clearBroadcastForm();
        } else {
            alert('ç¾¤å‘å¤±è´¥ï¼š' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ç¾¤å‘å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    })
    .finally(() => {
        submitBtn.html(originalText).prop('disabled', false);
    });
}

// æ›´æ–°ç›®æ ‡ç”¨æˆ·æ•°é‡
function updateTargetUserCount() {
    const targetGroup = $('#targetGroup').val();
    let count = 0;
    
    userList.forEach(user => {
        if (targetGroup === 'all') {
            count++;
        } else if (targetGroup === 'authenticated' && user.authenticated) {
            count++;
        } else if (targetGroup === 'normal' && !user.authenticated && !user.is_admin) {
            count++;
        }
    });
    
    $('#targetUserCount').text(count);
}

// æ¸…ç©ºå•ç”¨æˆ·é€šçŸ¥è¡¨å•
function clearForm() {
    $('#notificationForm')[0].reset();
    $('#selectedUser').val('');
    $('#selectedUserId').val('');
    $('.user-item').removeClass('selected');
    selectedUserId = null;
    $('#notificationDetail').attr('placeholder', 'è¯·è¾“å…¥é€šçŸ¥å†…å®¹...');
}

// æ¸…ç©ºç¾¤å‘é€šçŸ¥è¡¨å•
function clearBroadcastForm() {
    $('#broadcastForm')[0].reset();
    $('#broadcastDetail').attr('placeholder', 'è¯·è¾“å…¥ç¾¤å‘é€šçŸ¥å†…å®¹...');
    updateTargetUserCount();
}
</script>
{% endblock %}
