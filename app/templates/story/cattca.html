{% extends "base.html" %}
{% block title %}
{{ title }} - 互动小说阅读
{% endblock %}

{% block extra_css %}
<style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    #game { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    #output { min-height: 150px; margin-bottom: 20px; white-space: pre-wrap; }
    #choices { display: flex; flex-direction: column; gap: 10px; }
    #choices button { padding: 12px; font-size: 16px; border: none; border-radius: 8px; background: #007bff; color: white; cursor: pointer; }
    #choices button:hover { background: #0056b3; }
    #log { margin-top: 20px; padding: 10px; background: #eee; border-radius: 6px; font-size: 14px; }
  </style>
{% endblock %}

{% block content %}
<div id="game">
    <h2>Cattca.js 互动小说 Demo</h2>
    <div id="output"></div>
    <div id="choices"></div>
    <div id="log"></div>
  </div>
<template id="cattca-template">
    {{ content }}
</template>"
{% endblock %}

{% block extra_js %}
<script type="module">
    import { CattcaInterpreter } from './cattca.js';

    const outputDiv = document.querySelector('#output');
    const logDiv = document.querySelector('#log');
    const choicesDiv = document.querySelector('#choices');

    function appendOutput(txt) {
      outputDiv.innerText += txt + "\n";
    }

    function appendLog(txt) {
      logDiv.innerText += txt + "\n";
    }

    // 异步等待用户选择
    function getChoice(options) {
      return new Promise(resolve => {
        choicesDiv.innerHTML = "";
        options.forEach(opt => {
          const btn = document.createElement("button");
          btn.innerText = opt;
          btn.onclick = () => {
            choicesDiv.innerHTML = "";
            resolve(opt);
          };
          choicesDiv.appendChild(btn);
        });
      });
    }

    // 输入文本：这里仍然用 prompt
    async function getInput(promptText) {
      return window.prompt(promptText);
    }

    const interpreter = new CattcaInterpreter(
      appendOutput,
      appendLog,
      getInput,
      getChoice
    );

    const story = document.getElementById('cattca-template').innerHTML;

    // 加载并运行
    interpreter.load(story);
    interpreter.run();
  </script>
{% endblock %}