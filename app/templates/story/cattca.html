{% extends "base.html" %}
{% block title %}
{{ title }} - 互动小说阅读
{% endblock %}

{% block extra_css %}
<style>
    body { font-family: sans-serif; padding: 80px 0px 0px; background: #f5f5f5; }
    #game { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    #output { min-height: 150px; margin-bottom: 20px; }
    #choices { display: flex; flex-direction: column; gap: 10px; }
    #choices button { padding: 12px; font-size: 16px; border: none; border-radius: 8px; background: #007bff; color: white; cursor: pointer; }
    #choices button:hover { background: #0056b3; }
    #log { margin-top: 20px; padding: 10px; background: #eee; border-radius: 6px; font-size: 14px; }
    
    /* 可折叠段落样式 */
    .output-segment { margin-bottom: 8px; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; }
    .segment-header { 
      background: #f8f9fa; 
      padding: 8px 12px; 
      cursor: pointer; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      border-bottom: 1px solid #ddd;
      transition: background-color 0.2s;
    }
    .segment-header:hover { background: #e9ecef; }
    .segment-title { font-weight: bold; font-size: 14px; color: #495057; }
    .toggle-icon { font-size: 12px; color: #6c757d; transition: transform 0.2s; }
    .segment-content { 
      padding: 12px; 
      white-space: pre-wrap; 
      background: white;
      transition: max-height 0.3s ease-out;
    }
    .segment-content.collapsed { 
      max-height: 0; 
      padding: 0 12px; 
      overflow: hidden; 
    }
  </style>
{% endblock %}

{% block content %}
<div id="game">
    <h2>{{title}}</h2>
    <div id="output"></div>
    <div id="choices"></div>
    <div id="log"></div>
  </div>
{% endblock %}

{% block extra_js %}
<script type="module">
    import { CattcaInterpreter } from "{{url_for('static', filename='js/cattca.js')}}";

    const outputDiv = document.querySelector('#output');
    const logDiv = document.querySelector('#log');
    const choicesDiv = document.querySelector('#choices');

    // 可折叠输出系统
    let currentSegment = null;
    let segmentCount = 0;

    function appendOutput(txt) {
      if (!currentSegment) {
        // 创建新的段落
        currentSegment = document.createElement('div');
        currentSegment.className = 'output-segment';
        currentSegment.innerHTML = `
          <div class="segment-header" onclick="toggleSegment(this)">
            <span class="segment-title">段落 ${++segmentCount}</span>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="segment-content">${txt}</div>
        `;
        outputDiv.appendChild(currentSegment);
        // 自动滚动到新段落，稍微往上一点以显示段落标题
        setTimeout(() => {
          const rect = currentSegment.getBoundingClientRect();
          const containerRect = outputDiv.getBoundingClientRect();
          const scrollTop = outputDiv.scrollTop + (rect.top - containerRect.top) - 20;
          outputDiv.scrollTo({ top: scrollTop, behavior: 'smooth' });
        }, 10);
      } else {
        // 追加到当前段落
        const contentDiv = currentSegment.querySelector('.segment-content');
        contentDiv.textContent += txt;
      }
    }

    function startNewSegment() {
      // 将当前段落标记为可折叠（如果有当前段落）
      if (currentSegment) {
        const content = currentSegment.querySelector('.segment-content');
        content.classList.add('collapsed');
      }
      currentSegment = null;
    }

    function toggleSegment(header) {
      const segment = header.parentElement;
      const content = segment.querySelector('.segment-content');
      const icon = header.querySelector('.toggle-icon');
      
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        icon.textContent = '▲';
      } else {
        content.classList.add('collapsed');
        icon.textContent = '▼';
      }
    }

    // 将函数暴露到全局作用域
    window.toggleSegment = toggleSegment;

    function appendLog(txt) {
      logDiv.innerText += txt + "\n";
    }

    // 异步等待用户选择
    function getChoice(options) {
      return new Promise(resolve => {
        choicesDiv.innerHTML = "";
        options.forEach(opt => {
          const btn = document.createElement("button");
          btn.innerText = opt;
          btn.onclick = () => {
            choicesDiv.innerHTML = "";
            // 选择完成后开始新段落
            startNewSegment();
            resolve(opt);
          };
          choicesDiv.appendChild(btn);
        });
      });
    }

    // 输入文本：使用非阻塞的输入框
    async function getInput(promptText) {
      return new Promise(resolve => {
        // 创建输入框
        const inputDiv = document.createElement('div');
        inputDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 6px; border: 1px solid #dee2e6;';
        
        const label = document.createElement('label');
        label.textContent = promptText || '请输入:';
        label.style.cssText = 'display: block; margin-bottom: 5px; font-weight: bold;';
        
        const input = document.createElement('input');
        input.type = 'text';
        input.style.cssText = 'width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 16px;';
        
        const button = document.createElement('button');
        button.textContent = '确定';
        button.style.cssText = 'margin-top: 5px; padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;';
        
        inputDiv.appendChild(label);
        inputDiv.appendChild(input);
        inputDiv.appendChild(button);
        
        // 添加到输出区域
        outputDiv.appendChild(inputDiv);
        
        // 自动聚焦输入框
        input.focus();
        
        // 处理输入
        const handleSubmit = () => {
          const value = input.value;
          outputDiv.removeChild(inputDiv);
          // 输入完成后开始新段落
          startNewSegment();
          resolve(value);
        };
        
        button.onclick = handleSubmit;
        input.onkeypress = (e) => {
          if (e.key === 'Enter') {
            handleSubmit();
          }
        };
      });
    }

    const interpreter = new CattcaInterpreter(
      appendOutput,
      appendLog,
      getInput,
      getChoice
    );

    const story = `{{ content|safe }}`
    console.log(story)

    // 加载并运行
    interpreter.load(story);
    interpreter.run();
  </script>
{% endblock %}