{% extends "base.html" %}

{% block title %}‰øÑÁΩóÊñØÊñπÂùó{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        overflow-x: hidden;
    }

    .game-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
        min-height: 100vh;
    }

    .game-header {
        text-align: center;
        margin-bottom: 15px;
    }

    .game-title {
        color: white;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        margin-bottom: 10px;
    }

    .score-board {
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .score-item {
        background: rgba(255,255,255,0.2);
        backdrop-filter: blur(10px);
        border-radius: 10px;
        padding: 8px 15px;
        color: white;
        font-weight: bold;
        border: 1px solid rgba(255,255,255,0.3);
    }

    .game-area {
        display: flex;
        gap: 15px;
        align-items: flex-start;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
        max-width: 600px;
    }

    .main-board {
        background: rgba(0,0,0,0.8);
        border-radius: 15px;
        padding: 15px;
        border: 3px solid #4a90e2;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    #gameBoard {
        display: grid;
        grid-template-columns: repeat(10, 1fr);
        grid-template-rows: repeat(20, 1fr);
        gap: 1px;
        background: #222;
        border: 2px solid #444;
        border-radius: 8px;
        width: 300px;
        height: 600px;
    }

    .cell {
        background: #111;
        border: 1px solid #333;
        transition: all 0.1s ease;
    }

    .cell.filled {
        border: 1px solid #fff;
        box-shadow: inset 0 0 5px rgba(255,255,255,0.3);
    }

    .side-panel {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .next-piece {
        background: rgba(0,0,0,0.8);
        border-radius: 10px;
        padding: 15px;
        border: 2px solid #4a90e2;
        text-align: center;
        min-width: 120px;
    }

    .next-title {
        color: white;
        font-weight: bold;
        margin-bottom: 10px;
    }

    #nextPieceBoard {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(4, 1fr);
        gap: 1px;
        background: #222;
        border-radius: 5px;
        width: 80px;
        height: 80px;
        margin: 0 auto;
    }

    .next-cell {
        background: #111;
        border: 1px solid #333;
    }

    .next-cell.filled {
        border: 1px solid #fff;
        box-shadow: inset 0 0 3px rgba(255,255,255,0.3);
    }

    .controls {
        width: 100%;
        max-width: 400px;
        margin-top: 20px;
    }

    .control-buttons {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        grid-template-rows: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 15px;
    }

    .control-btn {
        background: linear-gradient(145deg, #4a90e2, #357abd);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 15px rgba(74, 144, 226, 0.3);
        user-select: none;
        -webkit-user-select: none;
        -webkit-touch-callout: none;
    }

    .control-btn:active {
        transform: scale(0.95);
        box-shadow: 0 2px 8px rgba(74, 144, 226, 0.5);
    }

    .control-btn:hover {
        background: linear-gradient(145deg, #357abd, #2968a3);
    }

    .rotate-btn {
        grid-column: 2;
        grid-row: 1;
    }

    .left-btn {
        grid-column: 1;
        grid-row: 2;
    }

    .down-btn {
        grid-column: 2;
        grid-row: 2;
    }

    .right-btn {
        grid-column: 3;
        grid-row: 2;
    }

    .drop-btn {
        grid-column: 2;
        grid-row: 3;
        background: linear-gradient(145deg, #e74c3c, #c0392b);
    }

    .drop-btn:hover {
        background: linear-gradient(145deg, #c0392b, #a93226);
    }

    .game-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .game-btn {
        background: linear-gradient(145deg, #27ae60, #229954);
        border: none;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        padding: 12px 20px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    }

    .game-btn:hover {
        background: linear-gradient(145deg, #229954, #1e8449);
    }

    .game-btn:active {
        transform: scale(0.95);
    }

    .pause-btn {
        background: linear-gradient(145deg, #f39c12, #e67e22);
    }

    .pause-btn:hover {
        background: linear-gradient(145deg, #e67e22, #d35400);
    }

    .game-over {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .game-over-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        max-width: 90%;
    }

    .game-over h2 {
        color: #e74c3c;
        margin-bottom: 15px;
        font-size: 2rem;
    }

    .final-score {
        font-size: 1.2rem;
        margin-bottom: 20px;
        color: #333;
    }

    /* ÊñπÂùóÈ¢úËâ≤ */
    .color-1 { background: linear-gradient(145deg, #e74c3c, #c0392b); } /* I */
    .color-2 { background: linear-gradient(145deg, #3498db, #2980b9); } /* O */
    .color-3 { background: linear-gradient(145deg, #f39c12, #e67e22); } /* T */
    .color-4 { background: linear-gradient(145deg, #27ae60, #229954); } /* S */
    .color-5 { background: linear-gradient(145deg, #9b59b6, #8e44ad); } /* Z */
    .color-6 { background: linear-gradient(145deg, #e67e22, #d35400); } /* J */
    .color-7 { background: linear-gradient(145deg, #1abc9c, #16a085); } /* L */

    /* ÊâãÊú∫Á´ØÈÄÇÈÖç */
    @media (max-width: 768px) {
        .game-title {
            font-size: 1.5rem;
        }
        
        .game-area {
            flex-direction: column;
            align-items: center;
        }
        
        #gameBoard {
            width: 250px;
            height: 500px;
        }
        
        .side-panel {
            flex-direction: row;
            justify-content: center;
            width: 100%;
        }
        
        .score-board {
            gap: 10px;
        }
        
        .score-item {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        .control-btn {
            font-size: 1rem;
            padding: 12px;
        }
    }

    @media (max-width: 480px) {
        .game-container {
            padding: 5px;
        }
        
        #gameBoard {
            width: 200px;
            height: 400px;
        }
        
        .control-btn {
            font-size: 0.9rem;
            padding: 10px;
        }
        
        .game-title {
            font-size: 1.3rem;
        }
    }

    /* Èò≤Ê≠¢ÈÄâ‰∏≠ÊñáÊú¨ */
    .control-btn, .game-btn {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <div class="game-header">
        <h1 class="game-title">üéÆ ‰øÑÁΩóÊñØÊñπÂùó</h1>
        <div class="score-board">
            <div class="score-item">
                <div>ÂæóÂàÜ</div>
                <div id="score">0</div>
            </div>
            <div class="score-item">
                <div>Á≠âÁ∫ß</div>
                <div id="level">1</div>
            </div>
            <div class="score-item">
                <div>Ë°åÊï∞</div>
                <div id="lines">0</div>
            </div>
        </div>
    </div>

    <div class="game-area">
        <div class="main-board">
            <div id="gameBoard"></div>
        </div>
        
        <div class="side-panel">
            <div class="next-piece">
                <div class="next-title">‰∏ã‰∏Ä‰∏™</div>
                <div id="nextPieceBoard"></div>
            </div>
        </div>
    </div>

    <div class="controls">
        <div class="control-buttons">
            <button class="control-btn rotate-btn" id="rotateBtn">‚Üª</button>
            <button class="control-btn left-btn" id="leftBtn">‚Üê</button>
            <button class="control-btn down-btn" id="downBtn">‚Üì</button>
            <button class="control-btn right-btn" id="rightBtn">‚Üí</button>
            <button class="control-btn drop-btn" id="dropBtn">‚¨á</button>
        </div>
        
        <div class="game-controls">
            <button class="game-btn" id="startBtn">ÂºÄÂßã</button>
            <button class="game-btn pause-btn" id="pauseBtn">ÊöÇÂÅú</button>
            <button class="game-btn" id="resetBtn">ÈáçÁΩÆ</button>
        </div>
    </div>
</div>

<div class="game-over" id="gameOver">
    <div class="game-over-content">
        <h2>Ê∏∏ÊàèÁªìÊùü</h2>
        <div class="final-score">ÊúÄÁªàÂæóÂàÜ: <span id="finalScore">0</span></div>
        <button class="game-btn" onclick="resetGame()">ÂÜçÊù•‰∏ÄÂ±Ä</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class TetrisGame {
    constructor() {
        this.board = Array(20).fill().map(() => Array(10).fill(0));
        this.currentPiece = null;
        this.nextPiece = null;
        this.score = 0;
        this.level = 1;
        this.lines = 0;
        this.gameRunning = false;
        this.gamePaused = false;
        this.dropInterval = null;
        
        this.pieces = [
            { // I
                shape: [[1,1,1,1]],
                color: 1
            },
            { // O
                shape: [[1,1],[1,1]],
                color: 2
            },
            { // T
                shape: [[0,1,0],[1,1,1]],
                color: 3
            },
            { // S
                shape: [[0,1,1],[1,1,0]],
                color: 4
            },
            { // Z
                shape: [[1,1,0],[0,1,1]],
                color: 5
            },
            { // J
                shape: [[1,0,0],[1,1,1]],
                color: 6
            },
            { // L
                shape: [[0,0,1],[1,1,1]],
                color: 7
            }
        ];
        
        this.initializeBoard();
        this.initializeNextBoard();
        this.bindEvents();
        this.generateNextPiece();
    }
    
    initializeBoard() {
        const gameBoard = document.getElementById('gameBoard');
        gameBoard.innerHTML = '';
        
        for (let i = 0; i < 200; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.id = `cell-${i}`;
            gameBoard.appendChild(cell);
        }
    }
    
    initializeNextBoard() {
        const nextBoard = document.getElementById('nextPieceBoard');
        nextBoard.innerHTML = '';
        
        for (let i = 0; i < 16; i++) {
            const cell = document.createElement('div');
            cell.className = 'next-cell';
            cell.id = `next-cell-${i}`;
            nextBoard.appendChild(cell);
        }
    }
    
    bindEvents() {
        // ÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('startBtn').addEventListener('click', () => this.startGame());
        document.getElementById('pauseBtn').addEventListener('click', () => this.togglePause());
        document.getElementById('resetBtn').addEventListener('click', () => this.resetGame());
        
        // ÊéßÂà∂ÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('leftBtn').addEventListener('click', () => this.movePiece(-1, 0));
        document.getElementById('rightBtn').addEventListener('click', () => this.movePiece(1, 0));
        document.getElementById('downBtn').addEventListener('click', () => this.movePiece(0, 1));
        document.getElementById('rotateBtn').addEventListener('click', () => this.rotatePiece());
        document.getElementById('dropBtn').addEventListener('click', () => this.dropPiece());
        
        // ÈîÆÁõò‰∫ã‰ª∂
        document.addEventListener('keydown', (e) => {
            if (!this.gameRunning || this.gamePaused) return;
            
            switch(e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    this.movePiece(-1, 0);
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    this.movePiece(1, 0);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    this.movePiece(0, 1);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    this.rotatePiece();
                    break;
                case ' ':
                    e.preventDefault();
                    this.dropPiece();
                    break;
            }
        });
        
        // Ëß¶Êë∏‰∫ã‰ª∂ÊîØÊåÅ
        let touchStartX = 0;
        let touchStartY = 0;
        
        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        });
        
        document.addEventListener('touchend', (e) => {
            if (!this.gameRunning || this.gamePaused) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX > 30) {
                    this.movePiece(1, 0);
                } else if (deltaX < -30) {
                    this.movePiece(-1, 0);
                }
            } else {
                if (deltaY > 30) {
                    this.movePiece(0, 1);
                }
            }
        });
    }
    
    generatePiece() {
        const pieceType = this.pieces[Math.floor(Math.random() * this.pieces.length)];
        return {
            shape: pieceType.shape.map(row => [...row]),
            color: pieceType.color,
            x: Math.floor((10 - pieceType.shape[0].length) / 2),
            y: 0
        };
    }
    
    generateNextPiece() {
        this.nextPiece = this.generatePiece();
        this.drawNextPiece();
    }
    
    spawnPiece() {
        this.currentPiece = this.nextPiece;
        this.generateNextPiece();
        
        if (this.checkCollision(this.currentPiece, 0, 0)) {
            this.gameOver();
            return false;
        }
        
        return true;
    }
    
    checkCollision(piece, deltaX, deltaY) {
        for (let y = 0; y < piece.shape.length; y++) {
            for (let x = 0; x < piece.shape[y].length; x++) {
                if (piece.shape[y][x]) {
                    const newX = piece.x + x + deltaX;
                    const newY = piece.y + y + deltaY;
                    
                    if (newX < 0 || newX >= 10 || newY >= 20) {
                        return true;
                    }
                    
                    if (newY >= 0 && this.board[newY][newX]) {
                        return true;
                    }
                }
            }
        }
        return false;
    }
    
    movePiece(deltaX, deltaY) {
        if (!this.currentPiece) return;
        
        if (!this.checkCollision(this.currentPiece, deltaX, deltaY)) {
            this.currentPiece.x += deltaX;
            this.currentPiece.y += deltaY;
            this.drawBoard();
        } else if (deltaY > 0) {
            this.placePiece();
        }
    }
    
    rotatePiece() {
        if (!this.currentPiece) return;
        
        const rotated = this.currentPiece.shape[0].map((_, index) =>
            this.currentPiece.shape.map(row => row[index]).reverse()
        );
        
        const originalShape = this.currentPiece.shape;
        this.currentPiece.shape = rotated;
        
        if (this.checkCollision(this.currentPiece, 0, 0)) {
            this.currentPiece.shape = originalShape;
        } else {
            this.drawBoard();
        }
    }
    
    dropPiece() {
        if (!this.currentPiece) return;
        
        while (!this.checkCollision(this.currentPiece, 0, 1)) {
            this.currentPiece.y++;
        }
        this.placePiece();
    }
    
    placePiece() {
        for (let y = 0; y < this.currentPiece.shape.length; y++) {
            for (let x = 0; x < this.currentPiece.shape[y].length; x++) {
                if (this.currentPiece.shape[y][x]) {
                    const boardY = this.currentPiece.y + y;
                    const boardX = this.currentPiece.x + x;
                    if (boardY >= 0) {
                        this.board[boardY][boardX] = this.currentPiece.color;
                    }
                }
            }
        }
        
        this.clearLines();
        this.currentPiece = null;
        
        if (!this.spawnPiece()) {
            return;
        }
        
        this.drawBoard();
    }
    
    clearLines() {
        let linesCleared = 0;
        
        for (let y = this.board.length - 1; y >= 0; y--) {
            if (this.board[y].every(cell => cell !== 0)) {
                this.board.splice(y, 1);
                this.board.unshift(Array(10).fill(0));
                linesCleared++;
                y++; // Ê£ÄÊü•Âêå‰∏ÄË°å
            }
        }
        
        if (linesCleared > 0) {
            this.lines += linesCleared;
            this.score += linesCleared * 100 * this.level;
            this.level = Math.floor(this.lines / 10) + 1;
            this.updateScore();
            
            // Â¢ûÂä†‰∏ãËêΩÈÄüÂ∫¶
            this.updateDropSpeed();
        }
    }
    
    updateDropSpeed() {
        if (this.dropInterval) {
            clearInterval(this.dropInterval);
        }
        
        const speed = Math.max(100, 1000 - (this.level - 1) * 100);
        this.dropInterval = setInterval(() => {
            if (this.gameRunning && !this.gamePaused) {
                this.movePiece(0, 1);
            }
        }, speed);
    }
    
    drawBoard() {
        // Ê∏ÖÁ©∫ÊòæÁ§∫Êùø
        for (let i = 0; i < 200; i++) {
            const cell = document.getElementById(`cell-${i}`);
            cell.className = 'cell';
        }
        
        // ÁªòÂà∂Â∑≤ÊîæÁΩÆÁöÑÊñπÂùó
        for (let y = 0; y < 20; y++) {
            for (let x = 0; x < 10; x++) {
                if (this.board[y][x]) {
                    const cell = document.getElementById(`cell-${y * 10 + x}`);
                    cell.className = `cell filled color-${this.board[y][x]}`;
                }
            }
        }
        
        // ÁªòÂà∂ÂΩìÂâçÊñπÂùó
        if (this.currentPiece) {
            for (let y = 0; y < this.currentPiece.shape.length; y++) {
                for (let x = 0; x < this.currentPiece.shape[y].length; x++) {
                    if (this.currentPiece.shape[y][x]) {
                        const boardY = this.currentPiece.y + y;
                        const boardX = this.currentPiece.x + x;
                        if (boardY >= 0 && boardY < 20 && boardX >= 0 && boardX < 10) {
                            const cell = document.getElementById(`cell-${boardY * 10 + boardX}`);
                            cell.className = `cell filled color-${this.currentPiece.color}`;
                        }
                    }
                }
            }
        }
    }
    
    drawNextPiece() {
        // Ê∏ÖÁ©∫‰∏ã‰∏Ä‰∏™ÊñπÂùóÊòæÁ§∫Âå∫Âüü
        for (let i = 0; i < 16; i++) {
            const cell = document.getElementById(`next-cell-${i}`);
            cell.className = 'next-cell';
        }
        
        if (this.nextPiece) {
            const offsetX = Math.floor((4 - this.nextPiece.shape[0].length) / 2);
            const offsetY = Math.floor((4 - this.nextPiece.shape.length) / 2);
            
            for (let y = 0; y < this.nextPiece.shape.length; y++) {
                for (let x = 0; x < this.nextPiece.shape[y].length; x++) {
                    if (this.nextPiece.shape[y][x]) {
                        const cellIndex = (y + offsetY) * 4 + (x + offsetX);
                        if (cellIndex >= 0 && cellIndex < 16) {
                            const cell = document.getElementById(`next-cell-${cellIndex}`);
                            cell.className = `next-cell filled color-${this.nextPiece.color}`;
                        }
                    }
                }
            }
        }
    }
    
    updateScore() {
        document.getElementById('score').textContent = this.score;
        document.getElementById('level').textContent = this.level;
        document.getElementById('lines').textContent = this.lines;
    }
    
    startGame() {
        if (this.gameRunning) return;
        
        this.gameRunning = true;
        this.gamePaused = false;
        
        if (!this.currentPiece) {
            this.spawnPiece();
        }
        
        this.updateDropSpeed();
        this.drawBoard();
        
        document.getElementById('startBtn').textContent = 'Ê∏∏Êàè‰∏≠';
        document.getElementById('pauseBtn').textContent = 'ÊöÇÂÅú';
    }
    
    togglePause() {
        if (!this.gameRunning) return;
        
        this.gamePaused = !this.gamePaused;
        document.getElementById('pauseBtn').textContent = this.gamePaused ? 'ÁªßÁª≠' : 'ÊöÇÂÅú';
    }
    
    resetGame() {
        this.gameRunning = false;
        this.gamePaused = false;
        this.board = Array(20).fill().map(() => Array(10).fill(0));
        this.currentPiece = null;
        this.score = 0;
        this.level = 1;
        this.lines = 0;
        
        if (this.dropInterval) {
            clearInterval(this.dropInterval);
        }
        
        this.updateScore();
        this.generateNextPiece();
        this.drawBoard();
        
        document.getElementById('startBtn').textContent = 'ÂºÄÂßã';
        document.getElementById('pauseBtn').textContent = 'ÊöÇÂÅú';
        document.getElementById('gameOver').style.display = 'none';
    }
    
    gameOver() {
        this.gameRunning = false;
        
        if (this.dropInterval) {
            clearInterval(this.dropInterval);
        }
        
        document.getElementById('finalScore').textContent = this.score;
        document.getElementById('gameOver').style.display = 'flex';
        document.getElementById('startBtn').textContent = 'ÂºÄÂßã';
    }
}

// ÂàùÂßãÂåñÊ∏∏Êàè
let game;

document.addEventListener('DOMContentLoaded', () => {
    game = new TetrisGame();
});

function resetGame() {
    game.resetGame();
}
</script>
{% endblock %}

{% block footer_text %}
üéÆ ‰øÑÁΩóÊñØÊñπÂùó - ÁªèÂÖ∏ÁõäÊô∫Ê∏∏Êàè
{% endblock %}

