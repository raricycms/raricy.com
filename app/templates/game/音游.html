<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精准卡点音游 - Perfect Beat Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            height: 100vh;
            color: white;
            background: #000;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(45deg, 
                #1a1a2e 0%, 
                #16213e 25%, 
                #0f3460 50%, 
                #533483 75%, 
                #1a1a2e 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            z-index: 100;
            height: 70px;
        }

        .stats {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 10px;
            min-width: 60px;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.8;
            margin-bottom: 3px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
        }

        .progress-container {
            flex: 1;
            max-width: 300px;
            margin: 0 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.1s;
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.8;
        }

        .bpm-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bpm-display {
            background: rgba(255, 255, 255, 0.15);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .beat-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4caf50;
            transition: all 0.15s;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .beat-indicator.beat {
            transform: scale(1.5);
            background: #ffeb3b;
            box-shadow: 0 0 25px #ffeb3b;
        }

        .beat-indicator.strong-beat {
            transform: scale(1.8);
            background: #ff5722;
            box-shadow: 0 0 35px #ff5722;
        }

        .rhythm-analyzer {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rhythm-bars {
            display: flex;
            gap: 2px;
            align-items: end;
            height: 20px;
        }

        .rhythm-bar {
            width: 3px;
            background: #4caf50;
            border-radius: 1px;
            transition: height 0.1s;
        }

        .game-main {
            position: absolute;
            top: 70px;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10;
        }

        .tracks-system {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
        }

        .track {
            flex: 1;
            position: relative;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .track:last-child {
            border-right: none;
        }

        .track-line {
            position: absolute;
            bottom: 80px;
            height: 200px;
            left: 50%;
            transform: translateX(-50%);
            width: 3px;
            background: linear-gradient(180deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 70%, 
                rgba(255, 255, 255, 0.8) 100%);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .track:nth-child(1) .track-line { 
            background: linear-gradient(180deg, transparent 0%, rgba(233, 30, 99, 0.4) 70%, rgba(233, 30, 99, 1) 100%);
            box-shadow: 0 0 15px rgba(233, 30, 99, 0.5);
        }
        .track:nth-child(2) .track-line { 
            background: linear-gradient(180deg, transparent 0%, rgba(76, 175, 80, 0.4) 70%, rgba(76, 175, 80, 1) 100%);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }
        .track:nth-child(3) .track-line { 
            background: linear-gradient(180deg, transparent 0%, rgba(33, 150, 243, 0.4) 70%, rgba(33, 150, 243, 1) 100%);
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.5);
        }
        .track:nth-child(4) .track-line { 
            background: linear-gradient(180deg, transparent 0%, rgba(255, 152, 0, 0.4) 70%, rgba(255, 152, 0, 1) 100%);
            box-shadow: 0 0 15px rgba(255, 152, 0, 0.5);
        }

        .judgment-line {
            position: absolute;
            bottom: 180px;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.3), 
                rgba(255, 255, 255, 1), 
                rgba(255, 255, 255, 0.3));
            box-shadow: 
                0 0 25px rgba(255, 255, 255, 1),
                0 0 50px rgba(255, 255, 255, 0.6);
            z-index: 200;
            animation: judgmentPulse 1s ease-in-out infinite;
        }

        @keyframes judgmentPulse {
            0%, 100% { 
                box-shadow: 
                    0 0 25px rgba(255, 255, 255, 1),
                    0 0 50px rgba(255, 255, 255, 0.6);
            }
            50% { 
                box-shadow: 
                    0 0 35px rgba(255, 255, 255, 1),
                    0 0 70px rgba(255, 255, 255, 0.8);
            }
        }

        .control-zone {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 96px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
        }

        .track-control {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .track-control:last-child {
            border-right: none;
        }

        .track-button {
            width: 75px;
            height: 60px;
            border-radius: 30px;
            border: 3px solid white;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            color: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .track:nth-child(1) .track-button { 
            background: linear-gradient(135deg, #e91e63, #ad1457);
        }
        .track:nth-child(2) .track-button { 
            background: linear-gradient(135deg, #4caf50, #388e3c);
        }
        .track:nth-child(3) .track-button { 
            background: linear-gradient(135deg, #2196f3, #1976d2);
        }
        .track:nth-child(4) .track-button { 
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }

        .track-button:active, .track-button.pressed {
            transform: scale(0.9);
            box-shadow: 0 0 40px rgba(255, 255, 255, 1);
        }

        .note {
            position: absolute;
            width: 85px;
            height: 40px;
            border-radius: 20px;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.6);
            border: 3px solid rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            color: white;
            z-index: 50;
            transition: all 0.1s;
        }

        .note.strong-beat {
            width: 100px;
            height: 55px;
            border: 4px solid #ffeb3b;
            box-shadow: 
                0 0 40px rgba(255, 235, 59, 1),
                0 8px 25px rgba(0, 0, 0, 0.6);
            animation: strongBeatPulse 0.4s ease-in-out infinite alternate;
            font-size: 28px;
        }

        @keyframes strongBeatPulse {
            0% { 
                transform: translateX(-50%) scale(1);
                box-shadow: 
                    0 0 40px rgba(255, 235, 59, 1),
                    0 8px 25px rgba(0, 0, 0, 0.6);
            }
            100% { 
                transform: translateX(-50%) scale(1.1);
                box-shadow: 
                    0 0 60px rgba(255, 235, 59, 1),
                    0 12px 35px rgba(0, 0, 0, 0.8);
            }
        }

        .note.downbeat {
            width: 110px;
            height: 65px;
            border: 5px solid #ff5722;
            box-shadow: 
                0 0 50px rgba(255, 87, 34, 1),
                0 10px 30px rgba(0, 0, 0, 0.7);
            animation: downbeatPulse 0.3s ease-in-out infinite alternate;
            font-size: 32px;
        }

        @keyframes downbeatPulse {
            0% { 
                transform: translateX(-50%) scale(1);
                box-shadow: 
                    0 0 50px rgba(255, 87, 34, 1),
                    0 10px 30px rgba(0, 0, 0, 0.7);
            }
            100% { 
                transform: translateX(-50%) scale(1.15);
                box-shadow: 
                    0 0 80px rgba(255, 87, 34, 1),
                    0 15px 40px rgba(0, 0, 0, 0.9);
            }
        }

        .note.syncopated {
            border: 3px solid #9c27b0;
            box-shadow: 
                0 0 25px rgba(156, 39, 176, 0.8),
                0 8px 25px rgba(0, 0, 0, 0.6);
            animation: syncopatedPulse 0.6s ease-in-out infinite alternate;
        }

        @keyframes syncopatedPulse {
            0% { 
                transform: translateX(-50%) scale(1);
                border-color: #9c27b0;
            }
            100% { 
                transform: translateX(-50%) scale(1.05);
                border-color: #e91e63;
            }
        }

        .track:nth-child(1) .note { 
            background: linear-gradient(135deg, #e91e63, #ad1457);
            box-shadow: 0 8px 25px rgba(233, 30, 99, 0.7);
        }
        .track:nth-child(2) .note { 
            background: linear-gradient(135deg, #4caf50, #388e3c);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.7);
        }
        .track:nth-child(3) .note { 
            background: linear-gradient(135deg, #2196f3, #1976d2);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.7);
        }
        .track:nth-child(4) .note { 
            background: linear-gradient(135deg, #ff9800, #f57c00);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.7);
        }

        .hit-effect {
            position: absolute;
            bottom: 200px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-weight: bold;
            font-size: 32px;
            pointer-events: none;
            animation: hitEffect 1.2s ease-out forwards;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.8);
            z-index: 300;
        }

        .hit-effect.perfect { 
            color: #ffeb3b; 
            text-shadow: 0 0 20px #ffeb3b;
            animation: perfectEffect 1.2s ease-out forwards;
        }
        .hit-effect.great { 
            color: #4caf50; 
            text-shadow: 0 0 15px #4caf50; 
        }
        .hit-effect.good { 
            color: #2196f3; 
            text-shadow: 0 0 15px #2196f3; 
        }
        .hit-effect.miss { 
            color: #f44336; 
            text-shadow: 0 0 15px #f44336; 
        }
        .hit-effect.downbeat { 
            color: #ff5722; 
            text-shadow: 0 0 25px #ff5722;
            font-size: 42px;
            animation: downbeatEffect 1.5s ease-out forwards;
        }

        @keyframes hitEffect {
            0% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
            50% {
                transform: translateX(-50%) translateY(-40px) scale(1.4);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-80px) scale(0.8);
            }
        }

        @keyframes perfectEffect {
            0% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
            30% {
                transform: translateX(-50%) translateY(-30px) scale(1.6);
            }
            60% {
                transform: translateX(-50%) translateY(-50px) scale(1.3);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-90px) scale(0.7);
            }
        }

        @keyframes downbeatEffect {
            0% {
                opacity: 1;
                transform: translateX(-50%) translateY(0) scale(1);
            }
            20% {
                transform: translateX(-50%) translateY(-20px) scale(1.8);
            }
            40% {
                transform: translateX(-50%) translateY(-40px) scale(1.5);
            }
            70% {
                transform: translateX(-50%) translateY(-60px) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-100px) scale(0.6);
            }
        }

        .combo-display {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 72px;
            font-weight: bold;
            color: #ffeb3b;
            text-shadow: 0 0 25px #ffeb3b;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 300;
        }

        .combo-display.show {
            opacity: 1;
            animation: comboGlow 0.6s ease-out;
        }

        @keyframes comboGlow {
            0% { transform: translateX(-50%) scale(0.7); }
            50% { transform: translateX(-50%) scale(1.3); }
            100% { transform: translateX(-50%) scale(1); }
        }

        .controls {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            background: rgba(0, 0, 0, 0.95);
            padding: 40px;
            border-radius: 20px;
            z-index: 1000;
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            min-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .controls h2 {
            margin-bottom: 20px;
            font-size: 36px;
            background: linear-gradient(45deg, #4caf50, #2196f3, #ff9800);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% 200%;
            animation: gradientText 3s ease infinite;
        }

        @keyframes gradientText {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .controls p {
            margin-bottom: 25px;
            opacity: 0.9;
            line-height: 1.6;
            font-size: 16px;
        }

        .controls button {
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .controls button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .controls button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .file-input {
            margin: 25px 0;
        }

        .file-input input[type="file"] {
            display: none;
        }

        .file-input label {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            display: inline-block;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-size: 16px;
        }

        .file-input label:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .bpm-input-section {
            margin: 25px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .bpm-input-section h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #ffeb3b;
        }

        .bpm-input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .bpm-input {
            width: 100px;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }

        .bpm-input:focus {
            outline: none;
            border-color: #4caf50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .bpm-toggle {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .bpm-toggle button {
            padding: 8px 16px !important;
            font-size: 14px !important;
            margin: 0 !important;
        }

        .bpm-toggle button.active {
            background: linear-gradient(135deg, #ff9800, #f57c00) !important;
        }

        .difficulty-selector {
            margin: 25px 0;
        }

        .difficulty-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        .difficulty-btn {
            padding: 10px 20px !important;
            font-size: 14px !important;
            margin: 0 !important;
        }

        .difficulty-btn.active {
            background: linear-gradient(135deg, #ff9800, #f57c00) !important;
        }

        .hidden {
            display: none !important;
        }

        .analysis-status {
            margin: 20px 0;
            padding: 15px;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            border-radius: 10px;
            font-size: 14px;
            text-align: center;
        }

        .rhythm-info {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 12px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">分数</div>
                    <div class="stat-value" id="score">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">连击</div>
                    <div class="stat-value" id="combo">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">准确率</div>
                    <div class="stat-value" id="accuracy">100%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">重音</div>
                    <div class="stat-value" id="strongBeats">0</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
                <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                </div>
            </div>

            <div class="bpm-info">
                <div class="bpm-display">
                    BPM: <span id="bpm">--</span>
                    <div class="beat-indicator" id="beatIndicator"></div>
                </div>
                <div class="rhythm-analyzer">
                    <span>节奏:</span>
                    <div class="rhythm-bars" id="rhythmBars">
                        <div class="rhythm-bar"></div>
                        <div class="rhythm-bar"></div>
                        <div class="rhythm-bar"></div>
                        <div class="rhythm-bar"></div>
                        <div class="rhythm-bar"></div>
                        <div class="rhythm-bar"></div>
                        <div class="rhythm-bar"></div>
                        <div class="rhythm-bar"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-main">
            <div class="combo-display" id="comboDisplay">0</div>
            
            <div class="tracks-system">
                <div class="track">
                    <div class="track-line"></div>
                </div>
                <div class="track">
                    <div class="track-line"></div>
                </div>
                <div class="track">
                    <div class="track-line"></div>
                </div>
                <div class="track">
                    <div class="track-line"></div>
                </div>
            </div>

            <div class="judgment-line"></div>

            <div class="control-zone">
                <div class="track-control">
                    <div class="track-button" data-track="0">D</div>
                </div>
                <div class="track-control">
                    <div class="track-button" data-track="1">F</div>
                </div>
                <div class="track-control">
                    <div class="track-button" data-track="2">J</div>
                </div>
                <div class="track-control">
                    <div class="track-button" data-track="3">K</div>
                </div>
            </div>
        </div>

        <div class="controls" id="controls">
            <h2>🎵 精准卡点音游</h2>
            <p>使用 D、F、J、K 键或点击按钮来击打音符<br>
            <strong>🔥 红色音符是下拍，⭐ 金色音符是强拍，🎭 紫色音符是切分音！</strong><br>
            <strong>重音节拍会给更高分数，跟着节奏来！</strong></p>
            
            <div class="file-input">
                <label for="audioFile">🎵 选择音乐文件</label>
                <input type="file" id="audioFile" accept="audio/*">
            </div>

            <div class="bpm-input-section">
                <h3>🎼 BPM 设置</h3>
                <div class="bpm-toggle">
                    <button id="autoBpmBtn" class="active">智能分析</button>
                    <button id="manualBpmBtn">手动输入</button>
                </div>
                <div class="bpm-input-group hidden" id="bpmInputGroup">
                    <label>BPM:</label>
                    <input type="number" id="bpmInput" class="bpm-input" min="60" max="200" value="120" placeholder="120">
                    <span>(60-200)</span>
                </div>
                <div class="rhythm-info" id="rhythmInfo">
                    智能分析将检测：节拍强度、重音位置、节奏模式
                </div>
            </div>

            <div class="analysis-status hidden" id="analysisStatus">
                正在分析音乐节拍...
            </div>

            <div class="difficulty-selector">
                <div>选择难度:</div>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn" data-difficulty="easy">简单</button>
                    <button class="difficulty-btn active" data-difficulty="normal">普通</button>
                    <button class="difficulty-btn" data-difficulty="hard">困难</button>
                    <button class="difficulty-btn" data-difficulty="expert">专家</button>
                </div>
            </div>

            <button id="startBtn" disabled>🎮 开始游戏</button>
            <button id="pauseBtn" class="hidden">⏸️ 暂停</button>
        </div>
    </div>

    <audio id="gameAudio" preload="auto"></audio>

    <script>
        class PerfectBeatGame {
            constructor() {
                this.score = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.totalNotes = 0;
                this.hitNotes = 0;
                this.strongBeatsHit = 0;
                this.isPlaying = false;
                this.isPaused = false;
                this.notes = [];
                this.bpm = 120;
                this.difficulty = 'normal';
                this.noteSpeed = 1200;
                this.gameStartTime = 0;
                this.audioStartTime = 0;
                this.beatInterval = 500;
                this.beatCount = 0;
                this.strongBeatInterval = 4;
                this.isManualBpm = false;
                this.audioLoaded = false;
                this.isAnalyzing = false;
                
                this.audio = document.getElementById('gameAudio');
                this.tracks = document.querySelectorAll('.track');
                this.beatTimes = [];
                this.keysPressed = new Set();
                
                // 增强的节拍分析
                this.beatOffset = 0;
                this.lastBeatTime = 0;
                this.beatAccuracy = [];
                this.rhythmPattern = [];
                this.downbeats = [];
                this.syncopatedBeats = [];
                
                this.difficultySettings = {
                    easy: { 
                        noteChance: 0.4, 
                        strongBeatChance: 1.0, 
                        downbeatChance: 0.8,
                        syncopatedChance: 0.1,
                        eighthNoteChance: 0.2
                    },
                    normal: { 
                        noteChance: 0.6, 
                        strongBeatChance: 1.0, 
                        downbeatChance: 1.0,
                        syncopatedChance: 0.3,
                        eighthNoteChance: 0.4
                    },
                    hard: { 
                        noteChance: 0.75, 
                        strongBeatChance: 1.0, 
                        downbeatChance: 1.0,
                        syncopatedChance: 0.5,
                        eighthNoteChance: 0.6
                    },
                    expert: { 
                        noteChance: 0.9, 
                        strongBeatChance: 1.0, 
                        downbeatChance: 1.0,
                        syncopatedChance: 0.7,
                        eighthNoteChance: 0.8
                    }
                };

                this.init();
            }

            init() {
                this.bindEvents();
                this.gameLoop();
                this.startRhythmVisualizer();
            }

            bindEvents() {
                // 音频文件选择
                document.getElementById('audioFile').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.loadAudioFile(file);
                    }
                });

                // BPM 设置相关事件
                document.getElementById('autoBpmBtn').addEventListener('click', () => {
                    this.switchToBpmMode(false);
                });

                document.getElementById('manualBpmBtn').addEventListener('click', () => {
                    this.switchToBpmMode(true);
                });

                document.getElementById('bpmInput').addEventListener('input', (e) => {
                    if (this.isManualBpm) {
                        const newBpm = parseInt(e.target.value);
                        if (newBpm >= 60 && newBpm <= 200) {
                            this.bpm = newBpm;
                            this.beatInterval = (60 / this.bpm) * 1000;
                            document.getElementById('bpm').textContent = Math.round(this.bpm);
                            
                            if (this.audioLoaded) {
                                this.generateAdvancedBeatTimes();
                                document.getElementById('startBtn').disabled = false;
                            }
                        }
                    }
                });

                // 难度选择
                document.querySelectorAll('.difficulty-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.difficulty = e.target.dataset.difficulty;
                    });
                });

                // 游戏控制
                document.getElementById('startBtn').addEventListener('click', () => {
                    this.startGame();
                });

                document.getElementById('pauseBtn').addEventListener('click', () => {
                    this.togglePause();
                });

                // 键盘事件
                document.addEventListener('keydown', (e) => {
                    if (!this.isPlaying || this.isPaused) return;
                    
                    const keyMap = {
                        'KeyD': 0, 'KeyF': 1, 'KeyJ': 2, 'KeyK': 3
                    };
                    
                    if (keyMap.hasOwnProperty(e.code) && !this.keysPressed.has(e.code)) {
                        this.keysPressed.add(e.code);
                        this.hitTrack(keyMap[e.code]);
                        this.pressButton(keyMap[e.code]);
                    }
                });

                document.addEventListener('keyup', (e) => {
                    const keyMap = {
                        'KeyD': 0, 'KeyF': 1, 'KeyJ': 2, 'KeyK': 3
                    };
                    
                    if (keyMap.hasOwnProperty(e.code)) {
                        this.keysPressed.delete(e.code);
                        this.releaseButton(keyMap[e.code]);
                    }
                });

                // 鼠标事件
                document.querySelectorAll('.track-button').forEach((btn, index) => {
                    btn.addEventListener('mousedown', () => {
                        if (this.isPlaying && !this.isPaused) {
                            this.hitTrack(index);
                            this.pressButton(index);
                        }
                    });

                    btn.addEventListener('mouseup', () => {
                        this.releaseButton(index);
                    });
                });

                // 音频结束事件
                this.audio.addEventListener('ended', () => {
                    this.endGame();
                });
            }

            switchToBpmMode(isManual) {
                if (this.isAnalyzing) return; // 分析中不允许切换
                
                this.isManualBpm = isManual;
                
                if (isManual) {
                    document.getElementById('manualBpmBtn').classList.add('active');
                    document.getElementById('autoBpmBtn').classList.remove('active');
                    document.getElementById('bpmInputGroup').classList.remove('hidden');
                    document.getElementById('rhythmInfo').textContent = '手动模式：请输入准确的BPM值';
                    
                    this.bpm = parseInt(document.getElementById('bpmInput').value) || 120;
                    this.beatInterval = (60 / this.bpm) * 1000;
                    document.getElementById('bpm').textContent = Math.round(this.bpm);
                    
                    if (this.audioLoaded) {
                        this.generateAdvancedBeatTimes();
                        document.getElementById('startBtn').disabled = false;
                    }
                } else {
                    document.getElementById('autoBpmBtn').classList.add('active');
                    document.getElementById('manualBpmBtn').classList.remove('active');
                    document.getElementById('bpmInputGroup').classList.add('hidden');
                    document.getElementById('rhythmInfo').textContent = '智能分析将检测：节拍强度、重音位置、节奏模式';
                    
                    if (this.audioLoaded) {
                        this.simpleBeatAnalysis();
                    }
                }
            }

            async loadAudioFile(file) {
                try {
                    console.log('🎵 Loading audio file:', file.name);
                    
                    const url = URL.createObjectURL(file);
                    this.audio.src = url;
                    this.audioLoaded = false;
                    
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            reject(new Error('音频加载超时'));
                        }, 10000);
                        
                        this.audio.addEventListener('loadedmetadata', () => {
                            clearTimeout(timeout);
                            this.audioLoaded = true;
                            resolve();
                        }, { once: true });
                        
                        this.audio.addEventListener('error', (e) => {
                            clearTimeout(timeout);
                            reject(new Error('音频加载失败'));
                        }, { once: true });
                    });

                    console.log('✅ Audio loaded, duration:', this.audio.duration);
                    
                    if (this.isManualBpm) {
                        this.bpm = parseInt(document.getElementById('bpmInput').value) || 120;
                        this.beatInterval = (60 / this.bpm) * 1000;
                        document.getElementById('bpm').textContent = Math.round(this.bpm);
                        this.generateAdvancedBeatTimes();
                        document.getElementById('startBtn').disabled = false;
                    } else {
                        await this.simpleBeatAnalysis();
                    }
                    
                } catch (error) {
                    console.error('❌ Error loading audio file:', error);
                    alert('音频文件加载失败，请尝试其他文件');
                    this.audioLoaded = false;
                    document.getElementById('startBtn').disabled = true;
                }
            }

            async simpleBeatAnalysis() {
                if (this.isAnalyzing) return;
                
                try {
                    this.isAnalyzing = true;
                    document.getElementById('analysisStatus').classList.remove('hidden');
                    document.getElementById('analysisStatus').textContent = '正在分析音乐节拍...';
                    
                    // 1. 优先从文件名提取BPM
                    const filename = this.audio.src.split('/').pop().toLowerCase();
                    const bpmMatch = filename.match(/(\d{2,3})\s*bpm/i);
                    if (bpmMatch) {
                        this.bpm = parseInt(bpmMatch[1]);
                        console.log(`🎯 BPM found in filename: ${this.bpm}`);
                    } else {
                        // 2. 简化的音频分析
                        this.bpm = await this.quickBPMDetection();
                    }
                    
                    // 确保BPM在合理范围内
                    if (this.bpm < 60) this.bpm *= 2;
                    if (this.bpm > 200) this.bpm /= 2;
                    this.bpm = Math.max(60, Math.min(200, this.bpm));
                    
                    this.beatInterval = (60 / this.bpm) * 1000;
                    document.getElementById('bpm').textContent = Math.round(this.bpm);
                    
                    // 3. 生成节拍时间点
                    await this.generateAdvancedBeatTimes();
                    
                    document.getElementById('analysisStatus').textContent = 
                        `分析完成！BPM: ${Math.round(this.bpm)}，检测到${this.beatTimes.length}个节拍点`;
                    
                    setTimeout(() => {
                        document.getElementById('analysisStatus').classList.add('hidden');
                    }, 2000);
                    
                    document.getElementById('startBtn').disabled = false;
                    
                } catch (error) {
                    console.error('❌ Beat analysis failed:', error);
                    this.setDefaultBeatPattern();
                } finally {
                    this.isAnalyzing = false;
                }
            }

            async quickBPMDetection() {
                return new Promise((resolve) => {
                    // 使用超时保护，避免卡死
                    const timeout = setTimeout(() => {
                        console.log('⚠️ BPM detection timeout, using default');
                        resolve(120);
                    }, 3000);
                    
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        
                        fetch(this.audio.src)
                            .then(response => response.arrayBuffer())
                            .then(arrayBuffer => audioContext.decodeAudioData(arrayBuffer))
                            .then(audioBuffer => {
                                clearTimeout(timeout);
                                
                                const channelData = audioBuffer.getChannelData(0);
                                const sampleRate = audioBuffer.sampleRate;
                                
                                // 只分析前10秒，减少计算量
                                const maxSamples = Math.min(channelData.length, sampleRate * 10);
                                const analysisData = channelData.slice(0, maxSamples);
                                
                                const detectedBPM = this.fastEnergyBPMDetection(analysisData, sampleRate);
                                
                                audioContext.close();
                                resolve(detectedBPM || 120);
                            })
                            .catch(error => {
                                clearTimeout(timeout);
                                console.warn('Quick BPM detection failed:', error);
                                resolve(120);
                            });
                            
                    } catch (error) {
                        clearTimeout(timeout);
                        console.warn('Quick BPM detection failed:', error);
                        resolve(120);
                    }
                });
            }

            fastEnergyBPMDetection(data, sampleRate) {
                try {
                    const windowSize = 1024; // 减小窗口大小
                    const hopSize = 256;     // 减小跳跃大小
                    const energies = [];
                    
                    // 计算能量包络
                    for (let i = 0; i < data.length - windowSize; i += hopSize) {
                        let energy = 0;
                        for (let j = 0; j < windowSize; j += 4) { // 跳跃采样
                            energy += data[i + j] * data[i + j];
                        }
                        energies.push(Math.sqrt(energy / (windowSize / 4)));
                    }
                    
                    if (energies.length < 20) return 120;
                    
                    // 简化的峰值检测
                    const threshold = Math.max(...energies) * 0.6;
                    const peaks = [];
                    
                    for (let i = 2; i < energies.length - 2; i++) {
                        if (energies[i] > energies[i-1] && 
                            energies[i] > energies[i+1] && 
                            energies[i] > threshold) {
                            peaks.push(i);
                        }
                    }
                    
                    if (peaks.length < 4) return 120;
                    
                    // 计算平均间隔
                    const intervals = [];
                    for (let i = 1; i < Math.min(peaks.length, 10); i++) {
                        const intervalInSeconds = (peaks[i] - peaks[i-1]) * hopSize / sampleRate;
                        if (intervalInSeconds > 0.3 && intervalInSeconds < 2) {
                            intervals.push(60 / intervalInSeconds);
                        }
                    }
                    
                    if (intervals.length === 0) return 120;
                    
                    // 返回中位数
                    intervals.sort((a, b) => a - b);
                    return Math.round(intervals[Math.floor(intervals.length / 2)]);
                    
                } catch (error) {
                    console.warn('Fast energy detection failed:', error);
                    return 120;
                }
            }

            async generateAdvancedBeatTimes() {
                if (!this.audio.duration) return;
                
                const duration = this.audio.duration;
                const beatInterval = 60 / this.bpm;
                
                this.beatTimes = [];
                this.downbeats = [];
                this.syncopatedBeats = [];
                this.rhythmPattern = [];
                
                let beatIndex = 0;
                
                // 生成主节拍
                for (let time = beatInterval; time < duration - 0.2; time += beatInterval) {
                    const isStrong = (beatIndex % this.strongBeatInterval) === 0;
                    const isDownbeat = (beatIndex % (this.strongBeatInterval * 2)) === 0;
                    
                    const beatInfo = {
                        time: time,
                        isStrong: isStrong,
                        isDownbeat: isDownbeat,
                        type: 'main',
                        spawned: false,
                        intensity: isDownbeat ? 1.0 : (isStrong ? 0.8 : 0.6)
                    };
                    
                    this.beatTimes.push(beatInfo);
                    
                    if (isDownbeat) {
                        this.downbeats.push(time);
                    }
                    
                    beatIndex++;
                }
                
                const settings = this.difficultySettings[this.difficulty];
                
                // 添加八分音符
                if (settings.eighthNoteChance > 0) {
                    for (let time = beatInterval * 0.5; time < duration - 0.2; time += beatInterval) {
                        if (!this.beatTimes.some(bt => Math.abs(bt.time - time) < 0.05)) {
                            this.beatTimes.push({
                                time: time,
                                isStrong: false,
                                isDownbeat: false,
                                type: 'eighth',
                                spawned: false,
                                intensity: 0.4
                            });
                        }
                    }
                }
                
                // 添加切分音
                if (settings.syncopatedChance > 0) {
                    for (let time = beatInterval * 0.75; time < duration - 0.2; time += beatInterval * 2) {
                        if (!this.beatTimes.some(bt => Math.abs(bt.time - time) < 0.03)) {
                            this.beatTimes.push({
                                time: time,
                                isStrong: false,
                                isDownbeat: false,
                                type: 'syncopated',
                                spawned: false,
                                intensity: 0.7
                            });
                            this.syncopatedBeats.push(time);
                        }
                    }
                }
                
                this.beatTimes.sort((a, b) => a.time - b.time);
                
                console.log(`🎼 Generated ${this.beatTimes.length} beat times (BPM: ${Math.round(this.bpm)})`);
            }

            setDefaultBeatPattern() {
                this.bpm = 120;
                this.beatInterval = 500;
                this.beatTimes = [];
                this.downbeats = [];
                this.syncopatedBeats = [];
                
                if (this.audio.duration) {
                    const duration = this.audio.duration;
                    const beatInterval = 60 / this.bpm;
                    
                    let beatIndex = 0;
                    for (let time = beatInterval; time < duration - 1; time += beatInterval) {
                        const isStrong = (beatIndex % this.strongBeatInterval) === 0;
                        const isDownbeat = (beatIndex % (this.strongBeatInterval * 2)) === 0;
                        
                        this.beatTimes.push({
                            time: time,
                            isStrong: isStrong,
                            isDownbeat: isDownbeat,
                            type: 'main',
                            spawned: false,
                            intensity: isDownbeat ? 1.0 : (isStrong ? 0.8 : 0.6)
                        });
                        
                        if (isDownbeat) {
                            this.downbeats.push(time);
                        }
                        
                        beatIndex++;
                    }
                }
                
                document.getElementById('bpm').textContent = this.bpm;
                document.getElementById('startBtn').disabled = false;
                
                document.getElementById('analysisStatus').textContent = '使用默认BPM: 120';
                setTimeout(() => {
                    document.getElementById('analysisStatus').classList.add('hidden');
                }, 2000);
                
                console.log('📝 Using default beat pattern');
            }

            startGame() {
                if (!this.audioLoaded) {
                    alert('请先选择音频文件！');
                    return;
                }

                this.isPlaying = true;
                this.isPaused = false;
                this.score = 0;
                this.combo = 0;
                this.maxCombo = 0;
                this.totalNotes = 0;
                this.hitNotes = 0;
                this.strongBeatsHit = 0;
                this.notes = [];
                this.gameStartTime = performance.now();
                this.audioStartTime = 0;
                this.beatCount = 0;
                this.keysPressed.clear();
                this.beatOffset = 0;
                this.lastBeatTime = 0;
                this.beatAccuracy = [];
                
                this.beatTimes.forEach(beat => beat.spawned = false);
                
                document.getElementById('controls').classList.add('hidden');
                document.getElementById('pauseBtn').classList.remove('hidden');
                
                this.audio.currentTime = 0;
                this.audio.play().then(() => {
                    this.audioStartTime = performance.now();
                    console.log('🎮 Game started!');
                }).catch(error => {
                    console.error('Audio play failed:', error);
                    alert('音频播放失败，请检查文件格式');
                    this.endGame();
                });
                
                this.updateUI();
                this.startAdvancedBeatIndicator();
            }

            togglePause() {
                this.isPaused = !this.isPaused;
                
                if (this.isPaused) {
                    this.audio.pause();
                    document.getElementById('pauseBtn').textContent = '▶️ 继续';
                } else {
                    this.audio.play();
                    document.getElementById('pauseBtn').textContent = '⏸️ 暂停';
                }
            }

            endGame() {
                this.isPlaying = false;
                document.getElementById('controls').classList.remove('hidden');
                document.getElementById('pauseBtn').classList.add('hidden');
                
                this.notes.forEach(note => {
                    if (note.element && note.element.parentNode) {
                        note.element.parentNode.removeChild(note.element);
                    }
                });
                this.notes = [];
                
                const accuracy = this.totalNotes > 0 ? Math.round((this.hitNotes / this.totalNotes) * 100) : 100;
                const strongBeatAccuracy = this.downbeats.length > 0 ? Math.round((this.strongBeatsHit / this.downbeats.length) * 100) : 0;
                
                setTimeout(() => {
                    alert(`🎉 游戏结束！\n\n📊 最终统计:\n` +
                          `🎯 最终分数: ${Math.floor(this.score)}\n` +
                          `🔥 最高连击: ${this.maxCombo}\n` +
                          `🎯 总准确率: ${accuracy}%\n` +
                          `🥁 重音准确率: ${strongBeatAccuracy}%\n` +
                          `🎵 总音符数: ${this.totalNotes}\n` +
                          `🎼 使用BPM: ${Math.round(this.bpm)} ${this.isManualBpm ? '(手动)' : '(智能分析)'}\n` +
                          `🎶 重音命中: ${this.strongBeatsHit}/${this.downbeats.length}`);
                }, 100);
            }

            shouldSpawnNote() {
                if (!this.isPlaying || this.isPaused || !this.audioStartTime) return false;
                
                const currentAudioTime = this.audio.currentTime;
                const settings = this.difficultySettings[this.difficulty];
                const lookAheadTime = this.noteSpeed / 1000;
                
                for (let i = 0; i < this.beatTimes.length; i++) {
                    const beatTime = this.beatTimes[i];
                    
                    if (beatTime.spawned) continue;
                    
                    if (currentAudioTime + lookAheadTime >= beatTime.time - 0.02) {
                        beatTime.spawned = true;
                        
                        let spawnChance = settings.noteChance;
                        
                        if (beatTime.isDownbeat) {
                            spawnChance *= settings.downbeatChance;
                        } else if (beatTime.isStrong) {
                            spawnChance *= settings.strongBeatChance;
                        } else if (beatTime.type === 'syncopated') {
                            spawnChance *= settings.syncopatedChance;
                        } else if (beatTime.type === 'eighth') {
                            spawnChance *= settings.eighthNoteChance;
                        }
                        
                        if (Math.random() < spawnChance) {
                            return { 
                                shouldSpawn: true, 
                                isStrong: beatTime.isStrong,
                                isDownbeat: beatTime.isDownbeat,
                                beatType: beatTime.type,
                                targetTime: beatTime.time,
                                intensity: beatTime.intensity
                            };
                        }
                    }
                }
                
                return { shouldSpawn: false };
            }

            spawnNote() {
                const spawnInfo = this.shouldSpawnNote();
                if (!spawnInfo.shouldSpawn) return;
                
                const trackIndex = Math.floor(Math.random() * 4);
                
                const note = {
                    element: document.createElement('div'),
                    track: trackIndex,
                    startTime: performance.now(),
                    targetTime: spawnInfo.targetTime,
                    isDownbeat: spawnInfo.isDownbeat,
                    isStrongBeat: spawnInfo.isStrong,
                    beatType: spawnInfo.beatType,
                    intensity: spawnInfo.intensity,
                    id: Date.now() + Math.random(),
                    hasBeenProcessed: false
                };
                
                let className = 'note';
                if (spawnInfo.isDownbeat) {
                    className += ' downbeat';
                } else if (spawnInfo.isStrong) {
                    className += ' strong-beat';
                } else if (spawnInfo.beatType === 'syncopated') {
                    className += ' syncopated';
                }
                
                note.element.className = className;
                note.element.style.top = '0px';
                
                if (spawnInfo.isDownbeat) {
                    note.element.textContent = '🔥';
                } else if (spawnInfo.isStrong) {
                    note.element.textContent = '⭐';
                } else if (spawnInfo.beatType === 'syncopated') {
                    note.element.textContent = '🎭';
                } else {
                    note.element.textContent = '♪';
                }
                
                this.tracks[trackIndex].appendChild(note.element);
                this.notes.push(note);
                this.totalNotes++;
                
                this.animateNote(note);
            }

            animateNote(note) {
                const judgmentLineY = window.innerHeight - 300;
                
                const animate = () => {
                    if (!this.isPlaying || this.isPaused) {
                        requestAnimationFrame(animate);
                        return;
                    }
                    
                    const currentTime = performance.now();
                    const timeToTarget = (note.targetTime * 1000 + this.audioStartTime) - currentTime;
                    const progress = 1 - (timeToTarget / this.noteSpeed);
                    
                    if (progress >= 1.3 && !note.hasBeenProcessed) {
                        note.hasBeenProcessed = true;
                        
                        if (note.element && note.element.parentNode) {
                            note.element.parentNode.removeChild(note.element);
                        }
                        this.notes = this.notes.filter(n => n.id !== note.id);
                        this.combo = 0;
                        this.showHitEffect(note.track, 'MISS', 'miss');
                        this.updateUI();
                        return;
                    }
                    
                    const currentY = judgmentLineY * progress;
                    if (note.element) {
                        note.element.style.top = currentY + 'px';
                    }
                    
                    requestAnimationFrame(animate);
                };
                
                animate();
            }

            hitTrack(trackIndex) {
                const trackNotes = this.notes.filter(note => 
                    note.track === trackIndex && !note.hasBeenProcessed
                );
                
                if (trackNotes.length > 0) {
                    let closestNote = null;
                    let minDistance = Infinity;
                    
                    trackNotes.forEach(note => {
                        if (!note.element) return;
                        
                        const noteRect = note.element.getBoundingClientRect();
                        const judgmentLine = document.querySelector('.judgment-line').getBoundingClientRect();
                        
                        const noteCenterY = noteRect.top + noteRect.height / 2;
                        const judgmentCenterY = judgmentLine.top + judgmentLine.height / 2;
                        const distance = Math.abs(noteCenterY - judgmentCenterY);
                        
                        if (distance < minDistance && distance < 160) {
                            minDistance = distance;
                            closestNote = note;
                        }
                    });
                    
                    if (closestNote) {
                        this.beatAccuracy.push(minDistance);
                        if (this.beatAccuracy.length > 50) {
                            this.beatAccuracy.shift();
                        }
                        
                        this.processNote(closestNote, minDistance);
                    }
                }
            }

            processNote(note, distance) {
                note.hasBeenProcessed = true;
                
                let points = 50;
                let rating = 'MISS';
                let ratingClass = 'miss';
                
                if (distance < 8) {
                    points = 300;
                    rating = 'PERFECT!';
                    ratingClass = 'perfect';
                } else if (distance < 20) {
                    points = 200;
                    rating = 'GREAT!';
                    ratingClass = 'great';
                } else if (distance < 40) {
                    points = 100;
                    rating = 'GOOD';
                    ratingClass = 'good';
                } else if (distance < 80) {
                    points = 50;
                    rating = 'OK';
                    ratingClass = 'good';
                }
                
                if (note.isDownbeat && points > 50) {
                    points *= 2.5;
                    rating = '🔥 ' + rating + ' 🔥';
                    ratingClass = 'downbeat';
                    this.strongBeatsHit++;
                } else if (note.isStrongBeat && points > 50) {
                    points *= 1.8;
                    rating = '⭐ ' + rating + ' ⭐';
                } else if (note.beatType === 'syncopated' && points > 50) {
                    points *= 1.5;
                    rating = '🎭 ' + rating + ' 🎭';
                }
                
                if (points > 50) {
                    this.combo++;
                    this.hitNotes++;
                    this.maxCombo = Math.max(this.maxCombo, this.combo);
                } else {
                    this.combo = 0;
                }
                
                const comboMultiplier = 1 + (this.combo * 0.02);
                this.score += points * comboMultiplier;
                
                this.showHitEffect(note.track, rating, ratingClass);
                
                if (note.element && note.element.parentNode) {
                    note.element.parentNode.removeChild(note.element);
                }
                this.notes = this.notes.filter(n => n.id !== note.id);
                
                this.updateUI();
            }

            showHitEffect(trackIndex, text, className) {
                const effect = document.createElement('div');
                effect.className = `hit-effect ${className}`;
                effect.textContent = text;
                
                this.tracks[trackIndex].appendChild(effect);
                
                setTimeout(() => {
                    if (effect.parentNode) {
                        effect.parentNode.removeChild(effect);
                    }
                }, className === 'downbeat' ? 1500 : 1200);
            }

            pressButton(trackIndex) {
                document.querySelectorAll('.track-button')[trackIndex].classList.add('pressed');
            }

            releaseButton(trackIndex) {
                const button = document.querySelectorAll('.track-button')[trackIndex];
                button.classList.remove('pressed');
            }

            startAdvancedBeatIndicator() {
                const indicator = document.getElementById('beatIndicator');
                let beatIndex = 0;
                
                const beat = () => {
                    if (!this.isPlaying) return;
                    
                    const isDownbeat = (beatIndex % (this.strongBeatInterval * 2)) === 0;
                    const isStrongBeat = (beatIndex % this.strongBeatInterval) === 0;
                    
                    indicator.classList.remove('beat', 'strong-beat');
                    
                    if (isDownbeat) {
                        indicator.classList.add('strong-beat');
                        indicator.style.background = '#ff5722';
                    } else if (isStrongBeat) {
                        indicator.classList.add('strong-beat');
                        indicator.style.background = '#ffeb3b';
                    } else {
                        indicator.classList.add('beat');
                        indicator.style.background = '#4caf50';
                    }
                    
                    setTimeout(() => {
                        indicator.classList.remove('beat', 'strong-beat');
                    }, 200);
                    
                    beatIndex++;
                    setTimeout(beat, this.beatInterval);
                };
                
                beat();
            }

            startRhythmVisualizer() {
                const rhythmBars = document.querySelectorAll('.rhythm-bar');
                
                const updateVisualizer = () => {
                    if (this.isPlaying && !this.isPaused && this.audio.currentTime > 0) {
                        rhythmBars.forEach((bar, index) => {
                            const height = Math.random() * 15 + 5;
                            bar.style.height = height + 'px';
                            
                            const currentBeat = Math.floor(this.audio.currentTime / (60 / this.bpm));
                            if (currentBeat % this.strongBeatInterval === 0) {
                                bar.style.background = '#ff5722';
                            } else if (currentBeat % 2 === 0) {
                                bar.style.background = '#ffeb3b';
                            } else {
                                bar.style.background = '#4caf50';
                            }
                        });
                    }
                    
                    requestAnimationFrame(updateVisualizer);
                };
                
                updateVisualizer();
            }

            updateUI() {
                document.getElementById('score').textContent = Math.floor(this.score);
                document.getElementById('combo').textContent = this.combo;
                document.getElementById('strongBeats').textContent = this.strongBeatsHit;
                document.getElementById('bpm').textContent = Math.round(this.bpm);
                
                const accuracy = this.totalNotes > 0 ? Math.round((this.hitNotes / this.totalNotes) * 100) : 100;
                document.getElementById('accuracy').textContent = accuracy + '%';
                
                if (this.audio.duration) {
                    const progress = (this.audio.currentTime / this.audio.duration) * 100;
                    document.getElementById('progress').style.width = progress + '%';
                    document.getElementById('currentTime').textContent = this.formatTime(this.audio.currentTime);
                    document.getElementById('totalTime').textContent = this.formatTime(this.audio.duration);
                }
                
                const comboDisplay = document.getElementById('comboDisplay');
                if (this.combo >= 10) {
                    comboDisplay.textContent = `${this.combo} COMBO!`;
                    comboDisplay.classList.add('show');
                } else {
                    comboDisplay.classList.remove('show');
                }
            }

            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            gameLoop() {
                if (this.isPlaying && !this.isPaused) {
                    this.spawnNote();
                    this.updateUI();
                }
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }

        window.addEventListener('load', () => {
            new PerfectBeatGame();
        });
    </script>
</body>
</html>
