<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon">
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.png') }}" type="image/png">

    <title>{% block title %}聪明山{% endblock %}</title>
    
    <!-- 注入服务器端数据 -->
    <meta name="user-authenticated" content="{% if current_user.is_authenticated %}true{% else %}false{% endif %}">
    {% if current_user.is_authenticated %}
    <meta name="notification-api-url" content="{{ url_for('notifications.api_unread_count') }}">
    {% endif %}

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Local icons via CSS masking (no CDN) -->

    <!-- Global site styles (SCSS build output) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- 自定义无Bootstrap顶栏 -->
    <header class="site-navbar" role="navigation">
        <div class="site-container">
            <a class="site-brand" href="/">
                <img src="/static/img/favicon.png" alt="My Icon" width="30" height="30">
                <span>Raricy.com - 聪明山</span>
            </a>
            <button class="site-navbar-toggler" type="button" aria-expanded="false" aria-controls="siteNavbar" aria-label="切换导航">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </button>
            <div class="site-navbar-collapse" id="siteNavbar">
                <ul class="site-nav">
                    <li><a class="site-link active" href="/">首页</a></li>
                    <li><a class="site-link" href="{{ url_for('story.menu') }}">故事</a></li>
                    <li><a class="site-link" href="{{ url_for('blog.menu') }}">博客</a></li>
                    <li><a class="site-link" href="{{ url_for('tool.menu') }}">工具</a></li>
                </ul>
                <div class="site-actions">
                    {% if current_user.is_authenticated %}
                            <a class="notification-btn" href="{{ url_for('notifications.notification_page') }}" title="我的通知">
                            <span class="icon icon-bell-fill" aria-hidden="true"></span>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </a>
                        <div class="site-user-dropdown">
                            <button class="site-user-dropdown-toggle" id="userDropdownToggle" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="userDropdownMenu">
                                <span class="site-user-avatar">
                                    <img src="{{ url_for('auth.get_avatar', user_id=current_user.id) }}" alt="avatar">
                                </span>
                                <span>{{ current_user.username }}</span>
                            </button>
                            <ul class="site-user-dropdown-menu" role="menu" id="userDropdownMenu" aria-labelledby="userDropdownToggle">
                                <li role="presentation" class="site-dropdown-header">用户信息</li>
                                <li role="separator" class="site-dropdown-divider"></li>
                                <li role="none"><a class="site-dropdown-item" role="menuitem" href="{{ url_for('auth.profile', user_id=current_user.id) }}"><span class="icon icon-person" style="margin-right: .5rem;"></span>个人资料</a></li>
                                <li role="none"><a class="site-dropdown-item" role="menuitem" href="{{ url_for('notifications.notification_page') }}"><span class="icon icon-bell" style="margin-right: .5rem;"></span>我的通知</a></li>
                                <li role="none"><a class="site-dropdown-item" role="menuitem" href="{{ url_for('auth.notification_settings') }}"><span class="icon icon-gear" style="margin-right: .5rem;"></span>通知设置</a></li>
                                {% if current_user.is_admin %}
                                <li role="none"><a class="site-dropdown-item" role="menuitem" href="/blog/admin"><span class="icon icon-gear-fill" style="margin-right: .5rem;"></span>博客管理后台</a></li>
                                <li role="none"><a class="site-dropdown-item" role="menuitem" href="{{ url_for('auth.user_management') }}"><span class="icon icon-people" style="margin-right: .5rem;"></span>用户管理</a></li>
                                {% endif %}
                                <li role="separator" class="site-dropdown-divider"></li>
                                <li role="none"><a class="site-dropdown-item text-danger" role="menuitem" href="#" onclick="logout()"><span class="icon icon-box-arrow-right" style="margin-right: .5rem;"></span>退出登录</a></li>
                            </ul>
                        </div>
                    {% else %}
                        <a class="site-login-btn" href="{{ url_for('auth.login') }}"><span class="icon icon-person-circle" style="margin-right:6px;"></span>登录</a>
                        <a class="site-link" href="{{ url_for('auth.register') }}" style="color:#6c757d;">注册</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </header>

    <!-- 主要内容区域 -->
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- 自定义底栏（无Bootstrap） -->
    <footer class="site-footer">
        <div class="site-footer-container">
            <div class="site-footer-row">
                <div class="site-footer-left">
                    <h5>聪明山 Raricy.com</h5>
                    {% block footer_text %}{% endblock %}
                </div>
                <div class="site-footer-right">
                    <div class="social-links">
                        <a href="https://github.com/raricycms/raricy.com" aria-label="GitHub"><span class="icon icon-github" aria-hidden="true"></span></a>
                        <a href="/contact" aria-label="Twitter"><span class="icon icon-twitter" aria-hidden="true"></span></a>
                        <a href="mailto:raricycms@gmail.com" aria-label="Email"><span class="icon icon-envelope" aria-hidden="true"></span></a>
                    </div>
                    <p style="margin-top: 0.5rem;">{% block copyright %}&copy; 2025 聪明山. All rights reserved.{% endblock %}
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS（全站其他组件可用；顶栏不依赖） -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 通用JavaScript -->
    <script>
        // 从meta标签读取服务器端数据
        const userAuthenticatedMeta = document.querySelector('meta[name="user-authenticated"]');
        const notificationApiUrlMeta = document.querySelector('meta[name="notification-api-url"]');
        
        // 安全地解析JSON
        function safeJsonParse(jsonString, defaultValue) {
            try {
                return JSON.parse(jsonString);
            } catch (e) {
                console.error('JSON解析错误:', e, '原始内容:', jsonString);
                return defaultValue;
            }
        }
        
        window.isUserAuthenticated = userAuthenticatedMeta ? (userAuthenticatedMeta.content === 'true') : false;
        window.notificationApiUrl = notificationApiUrlMeta ? notificationApiUrlMeta.content : null;
        
        console.log('用户认证状态:', window.isUserAuthenticated);
        console.log('通知API URL:', window.notificationApiUrl);
        console.log('user-authenticated meta内容:', userAuthenticatedMeta ? userAuthenticatedMeta.content : '不存在');
        console.log('notification-api-url meta内容:', notificationApiUrlMeta ? notificationApiUrlMeta.content : '不存在');
        // 滚动时导航栏背景渐变
        window.addEventListener('scroll', function () {
            const navbar = document.querySelector('.site-navbar');
            if (!navbar) return;
            navbar.style.background = (window.scrollY > 50) ? 'rgba(33, 37, 41, 0.98)' : 'rgba(33, 37, 41, 0.95)';
        });

        // 平滑滚动
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const href = this.getAttribute('href');
                if (!href || href === '#') return;
                const target = document.querySelector(href);
                if (!target) {
                    console.warn('Target element not found:', href);
                    return;
                }
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            });
        });

        // 登出功能
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                fetch('{{ url_for("auth.logout") }}', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        // 显示成功消息
                        showToast('已成功退出登录', 'success');
                        // 刷新页面
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    } else {
                        showToast('退出登录失败', 'error');
                    }
                })
                .catch(error => {
                    console.error('退出登录请求失败:', error);
                    showToast('网络错误，请稍后重试', 'error');
                });
            }
        }

        // 显示消息提示
        function showToast(message, type = 'info') {
            // 创建toast元素
            const toastContainer = document.getElementById('toast-container') || createToastContainer();
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // 显示toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // 自动移除
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }

        // 创建toast容器
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toast-container';
            container.className = 'toast-container position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }

        // 获取并更新通知数量
        function updateNotificationCount() {
            if (!window.isUserAuthenticated) {
                console.log('用户未登录，跳过通知数量更新');
                return;
            }
            
            if (!window.notificationApiUrl) {
                console.log('通知API URL未设置');
                return;
            }
            
            console.log('正在获取通知数量...', window.notificationApiUrl);
            fetch(window.notificationApiUrl)
                .then(response => response.json())
                .then(data => {
                    const badge = document.getElementById('notificationBadge');
                    if (badge) {
                        const count = data.count || 0;
                        if (count > 0) {
                            badge.style.display = 'flex';
                            if (count > 99) {
                                badge.textContent = '99+';
                                badge.classList.add('large-count');
                            } else {
                                badge.textContent = count;
                                badge.classList.remove('large-count');
                            }
                            badge.classList.add('has-notifications');
                        } else {
                            badge.style.display = 'none';
                            badge.classList.remove('has-notifications');
                        }
                    }
                })
                .catch(error => {
                    console.error('获取通知数量失败:', error);
                });
        }

        // 检测Bootstrap是否加载成功
        function checkBootstrapLoaded() {
            // 检查Bootstrap CSS文件是否加载成功
            const bootstrapLink = document.querySelector('link[href*="bootstrap"]');
            if (!bootstrapLink) {
                console.warn('Bootstrap CSS链接未找到');
                document.body.classList.add('bootstrap-failed');
                return;
            }
            
            // 使用更简单的方法：检查Bootstrap特有的CSS规则是否存在
            const testElement = document.createElement('div');
            testElement.className = 'container';
            testElement.style.visibility = 'hidden';
            testElement.style.position = 'absolute';
            testElement.style.top = '-9999px';
            document.body.appendChild(testElement);
            
            const computedStyle = window.getComputedStyle(testElement);
            
            // 检查Bootstrap container的box-sizing属性（Bootstrap使用border-box）
            const hasBootstrap = computedStyle.boxSizing === 'border-box';
            
            // 调试信息
            console.log('Bootstrap检测详情:', {
                boxSizing: computedStyle.boxSizing,
                paddingLeft: computedStyle.paddingLeft,
                paddingRight: computedStyle.paddingRight,
                marginLeft: computedStyle.marginLeft,
                marginRight: computedStyle.marginRight,
                maxWidth: computedStyle.maxWidth,
                hasBootstrap: hasBootstrap
            });
            
            document.body.removeChild(testElement);
            
            if (!hasBootstrap) {
                console.warn('Bootstrap CSS未正确加载，使用fallback样式');
                document.body.classList.add('bootstrap-failed');
            } else {
                console.log('Bootstrap CSS加载成功');
            }
        }

        // 页面加载后：初始化顶栏交互与通知
        document.addEventListener('DOMContentLoaded', function() {
            updateNotificationCount();

            // 顶栏折叠
            const siteNavbar = document.querySelector('.site-navbar');
            const toggler = document.querySelector('.site-navbar-toggler');
            if (toggler && siteNavbar) {
                toggler.addEventListener('click', function () {
                    const isOpen = siteNavbar.classList.toggle('open');
                    toggler.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
                });
                window.addEventListener('resize', function () {
                    if (window.innerWidth >= 992 && siteNavbar.classList.contains('open')) {
                        siteNavbar.classList.remove('open');
                        toggler.setAttribute('aria-expanded', 'false');
                    }
                });
            }

            // 用户下拉
            const userDropdown = document.querySelector('.site-user-dropdown');
            const userToggle = document.querySelector('.site-user-dropdown-toggle');
            if (userDropdown && userToggle) {
                userToggle.addEventListener('click', function (e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('open');
                    const expanded = userDropdown.classList.contains('open') ? 'true' : 'false';
                    userToggle.setAttribute('aria-expanded', expanded);
                });
                document.addEventListener('click', function (e) {
                    if (!userDropdown.contains(e.target)) {
                        userDropdown.classList.remove('open');
                        userToggle.setAttribute('aria-expanded', 'false');
                    }
                });
            }
        });

        // 当用户点击通知按钮时，延迟更新计数（给服务器时间处理）
        document.addEventListener('click', function(e) {
            if (e.target.closest('.notification-btn')) {
                setTimeout(updateNotificationCount, 1000);
            }
        });

        // 全局函数：刷新通知计数（可在其他页面调用）
        window.refreshNotificationCount = function() {
            updateNotificationCount();
        };

        // 取消不再需要的fallback相关函数（已移除）
    </script>

    <!-- 页面特定的JavaScript -->
    {% block extra_js %}{% endblock %}
</body>

</html>